module.exports=[60350,a=>{"use strict";var b,c,d,e,f,g,h,i,j,k,l=a.i(87924),m=a.i(72131);let n=[{id:"graph",label:"ГРАФ"},{id:"events",label:"СОБЫТИЯ"},{id:"stats",label:"СТАТИСТИКА"},{id:"agents",label:"АГЕНТЫ"},{id:"messages",label:"СООБЩЕНИЯ"}];function o({children:a,activeTab:b="graph",onTabChange:c,onAddEvent:d,timeSpeed:e=1,onTimeSpeedChange:f,onRestartSimulation:g,worldTime:h}){let[i,j]=(0,m.useState)("--:--:--"),[k,o]=(0,m.useState)("--.--.----"),[p,q]=(0,m.useState)(""),[r,s]=(0,m.useState)(!1),[t,u]=(0,m.useState)(!1),v=(0,m.useRef)(1),w=e<=.001;(0,m.useEffect)(()=>{e>.001&&(v.current=e)},[e]),(0,m.useEffect)(()=>{u(!0)},[]),(0,m.useEffect)(()=>{if(!h){j("--:--:--"),o("--.--.----");return}let a=new Date(h);if(Number.isNaN(a.getTime())){j("--:--:--"),o("--.--.----");return}let b=a.getTime(),c=Math.max(0,e),d=()=>{let a=new Date(b);j(a.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"})),o(a.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"})),b+=1e3*c*60};d();let f=setInterval(d,1e3);return()=>clearInterval(f)},[h,e]);let x=()=>{p.trim()&&d&&(d(p.trim()),q(""))};return(0,l.jsxs)("div",{className:"relative w-screen overflow-hidden flex flex-col",style:{height:"100dvh",backgroundColor:"var(--background)"},children:[(0,l.jsx)("div",{className:"pointer-events-none absolute inset-0 z-50",style:{background:"repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(229,195,75,0.008) 2px, rgba(229,195,75,0.008) 4px)"}}),(0,l.jsxs)("svg",{className:"pointer-events-none absolute inset-0 z-40 hidden md:block",style:{width:"100%",height:"100%"},viewBox:"0 0 1000 1000",preserveAspectRatio:"none",fill:"none",children:[(0,l.jsxs)("defs",{children:[(0,l.jsxs)("filter",{id:"glow",children:[(0,l.jsx)("feGaussianBlur",{stdDeviation:"2",result:"blur"}),(0,l.jsxs)("feMerge",{children:[(0,l.jsx)("feMergeNode",{in:"blur"}),(0,l.jsx)("feMergeNode",{in:"SourceGraphic"})]})]}),(0,l.jsxs)("filter",{id:"glow-strong",children:[(0,l.jsx)("feGaussianBlur",{stdDeviation:"4",result:"blur"}),(0,l.jsxs)("feMerge",{children:[(0,l.jsx)("feMergeNode",{in:"blur"}),(0,l.jsx)("feMergeNode",{in:"SourceGraphic"})]})]})]}),(0,l.jsx)("path",{d:"M 30 6 L 970 6 L 994 30 L 994 970 L 970 994 L 30 994 L 6 970 L 6 30 Z",stroke:"var(--cyber-glow)",strokeWidth:"1.2",filter:"url(#glow)",opacity:"0.8"}),(0,l.jsx)("path",{d:"M 34 10 L 966 10 L 990 34 L 990 966 L 966 990 L 34 990 L 10 966 L 10 34 Z",stroke:"var(--cyber-glow)",strokeWidth:"0.3",opacity:"0.25"}),(0,l.jsx)("path",{d:"M 6 55 L 6 30 L 30 6",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),(0,l.jsx)("path",{d:"M 970 6 L 994 30 L 994 55",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),(0,l.jsx)("path",{d:"M 994 945 L 994 970 L 970 994",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),(0,l.jsx)("path",{d:"M 30 994 L 6 970 L 6 945",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),[150,300,500,700,850].map(a=>(0,l.jsx)("line",{x1:a,y1:6,x2:a,y2:12,stroke:"var(--cyber-glow)",strokeWidth:"0.5",opacity:"0.35"},a))]}),(0,l.jsx)("div",{className:"pointer-events-none absolute inset-[2px] z-40 md:hidden",style:{border:"1px solid var(--cyber-glow)",boxShadow:"0 0 6px var(--cyber-glow-dim), inset 0 0 6px var(--cyber-glow-dim)",opacity:.5}}),(0,l.jsx)("div",{className:"absolute left-[0.35%] top-1/2 z-40 -translate-y-1/2 flex-col gap-1 hidden lg:flex",children:[.9,.7,.5,.3].map((a,b)=>(0,l.jsx)("div",{className:"rounded-sm",style:{width:"3px",height:"14px",backgroundColor:"var(--cyber-glow)",opacity:a,boxShadow:"0 0 4px var(--cyber-glow-dim)"}},b))}),(0,l.jsx)("div",{className:"absolute right-[0.35%] top-1/2 z-40 -translate-y-1/2 flex-col gap-1 hidden lg:flex",children:[.3,.5,.7,.9].map((a,b)=>(0,l.jsx)("div",{className:"rounded-sm",style:{width:"3px",height:"14px",backgroundColor:"var(--cyber-glow)",opacity:a,boxShadow:"0 0 4px var(--cyber-glow-dim)"}},b))}),(0,l.jsxs)("div",{className:"relative z-10 flex flex-col h-full",style:{padding:"1.2% 1.8%"},children:[(0,l.jsxs)("header",{className:"shrink-0 flex flex-col gap-2 pb-[0.6%]",children:[(0,l.jsx)("div",{className:"flex items-center justify-between",children:(0,l.jsxs)("div",{className:"flex items-center gap-4 pl-[1.5%]",children:[(0,l.jsx)("h1",{className:"font-mono text-base md:text-lg lg:text-xl tracking-[0.2em] uppercase whitespace-nowrap",style:{color:"var(--cyber-glow)"},children:"LONG LIVE MODELS"}),(0,l.jsxs)("div",{className:"flex flex-col items-start gap-1",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("button",{onClick:()=>{if(f){if(w)return void f(Math.max(v.current,1));f(0)}},className:"font-mono text-[10px] md:text-xs tracking-wider uppercase cursor-pointer",style:{color:w?"#4ade80":"#f87171",border:`1px solid ${w?"rgba(74,222,128,0.45)":"rgba(248,113,113,0.45)"}`,backgroundColor:w?"rgba(74,222,128,0.12)":"rgba(248,113,113,0.12)",padding:"2px 8px",transition:"all 0.2s ease"},title:w?"Продолжить течение игрового времени":"Остановить течение игрового времени",children:w?"ПРОДОЛЖИТЬ ВРЕМЯ":"ОСТАНОВИТЬ ВРЕМЯ"}),(0,l.jsx)("button",{onClick:g,disabled:!g,className:"font-mono text-[10px] md:text-xs tracking-wider uppercase cursor-pointer disabled:cursor-not-allowed",style:{color:g?"var(--cyber-glow)":"var(--muted-foreground)",border:"1px solid rgba(229,195,75,0.35)",backgroundColor:g?"rgba(229,195,75,0.1)":"rgba(229,195,75,0.03)",padding:"2px 8px",transition:"all 0.2s ease"},title:"Полностью сбросить мир и начать симуляцию заново",children:"НАЧАТЬ ЗАНОВО"})]}),(0,l.jsxs)("span",{className:"font-mono text-xs md:text-sm tabular-nums whitespace-nowrap",style:{color:"var(--cyber-glow)",opacity:.5},children:[k,(0,l.jsx)("span",{className:"mx-1.5",style:{opacity:.4},children:"/"}),i]})]})]})}),(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("nav",{className:"flex items-center pl-[1.5%]",children:n.map(a=>{let d=b===a.id;return(0,l.jsx)("button",{onClick:()=>c?.(a.id),className:"font-mono text-sm md:text-base tracking-wider uppercase cursor-pointer whitespace-nowrap",style:{padding:"6px 14px",color:d?"var(--cyber-glow)":"var(--muted-foreground)",backgroundColor:d?"rgba(229,195,75,0.1)":"transparent",borderBottom:d?"2px solid var(--cyber-glow)":"2px solid transparent",textShadow:d?"0 0 10px rgba(229,195,75,0.4)":"none",transition:"all 0.2s ease"},onMouseEnter:a=>{d||(a.currentTarget.style.color="var(--cyber-glow)",a.currentTarget.style.backgroundColor="rgba(229,195,75,0.06)",a.currentTarget.style.textShadow="0 0 10px rgba(229,195,75,0.3)",a.currentTarget.style.borderBottom="2px solid rgba(229,195,75,0.4)")},onMouseLeave:a=>{d||(a.currentTarget.style.color="var(--muted-foreground)",a.currentTarget.style.backgroundColor="transparent",a.currentTarget.style.textShadow="none",a.currentTarget.style.borderBottom="2px solid transparent")},children:a.label},a.id)})}),(0,l.jsxs)("div",{className:"relative flex items-center gap-3 shrink-0",style:{padding:"5px 14px",backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.1)",clipPath:"polygon(4px 0, calc(100% - 4px) 0, 100% 4px, 100% calc(100% - 4px), calc(100% - 4px) 100%, 4px 100%, 0 calc(100% - 4px), 0 4px)"},onMouseEnter:()=>s(!0),onMouseLeave:()=>s(!1),children:[(0,l.jsx)("span",{className:"font-mono text-xs tracking-widest uppercase select-none",style:{color:"var(--muted-foreground)"},children:"СКОРОСТЬ"}),(0,l.jsx)("input",{type:"range",min:0,max:5,step:.1,value:e,onChange:a=>f?.(Math.round(10*parseFloat(a.target.value))/10),className:"cyber-slider h-1",style:{width:"clamp(80px, 8vw, 160px)",background:`linear-gradient(to right, var(--cyber-glow) ${e/5*100}%, var(--border) ${e/5*100}%)`}}),(0,l.jsxs)("button",{onClick:()=>f?.(1),className:"font-mono text-sm tabular-nums cursor-pointer",title:t?`Клик = сброс на 1x`:void 0,style:{color:"var(--cyber-glow)",textShadow:e>0?"0 0 8px rgba(229,195,75,0.4)":"none",background:"none",border:"none",padding:0,width:"3.5em",textAlign:"right",transition:"opacity 0.2s ease, text-shadow 0.2s ease",opacity:1===e?.7:1},onMouseEnter:a=>{a.currentTarget.style.textShadow="0 0 14px rgba(229,195,75,0.7)"},onMouseLeave:a=>{a.currentTarget.style.textShadow=e>0?"0 0 8px rgba(229,195,75,0.4)":"none"},children:[e.toFixed(1),"x"]}),r&&(0,l.jsx)("div",{className:"absolute top-full right-0 mt-2 px-3 py-1.5 font-mono text-[10px] tracking-wide whitespace-nowrap pointer-events-none z-50 hidden lg:block",style:{backgroundColor:"rgba(17,17,24,0.95)",border:"1px solid rgba(229,195,75,0.25)",color:"var(--cyber-glow)",clipPath:"polygon(4px 0, calc(100% - 4px) 0, 100% 4px, 100% calc(100% - 4px), calc(100% - 4px) 100%, 4px 100%, 0 calc(100% - 4px), 0 4px)"},children:"Скорость течения времени мира // Клик на значение = сброс"})]})]})]}),(0,l.jsx)("div",{className:"relative flex-1 min-h-0 overflow-hidden rounded-sm border",style:{borderColor:"rgba(229,195,75,0.2)"},children:a}),(0,l.jsx)("div",{className:"shrink-0",style:{paddingTop:"0.6%"},children:(0,l.jsx)("div",{className:"relative overflow-hidden",style:{clipPath:"polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px)"},children:(0,l.jsxs)("div",{className:"flex items-center gap-3",style:{padding:"4px 6px",border:"1px solid rgba(229,195,75,0.2)",backgroundColor:"rgba(17,17,24,0.9)",animation:"cyber-shimmer 4s ease-in-out infinite",clipPath:"polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px)"},children:[(0,l.jsx)("div",{className:"shrink-0 pl-2",children:(0,l.jsx)("div",{className:"h-2 w-2 rounded-full",style:{backgroundColor:"var(--cyber-glow)",boxShadow:"0 0 6px var(--cyber-glow-dim)",animation:"cyber-pulse 2s ease-in-out infinite"}})}),(0,l.jsx)("input",{type:"text",value:p,onChange:a=>q(a.target.value),onKeyDown:a=>{"Enter"===a.key&&(a.preventDefault(),x())},placeholder:"Введите событие для мира агентов...",className:"flex-1 bg-transparent font-mono text-sm md:text-base py-2.5 placeholder:opacity-30 focus:outline-none",style:{color:"var(--foreground)",caretColor:"var(--cyber-glow)",paddingLeft:"8px",paddingRight:"8px"}}),(0,l.jsx)("button",{onClick:x,className:"shrink-0 font-mono text-xs md:text-sm tracking-widest uppercase cursor-pointer",style:{padding:"10px 20px",marginRight:"4px",backgroundColor:"rgba(229,195,75,0.08)",color:"var(--cyber-glow)",border:"1px solid rgba(229,195,75,0.25)",clipPath:"polygon(6px 0, calc(100% - 6px) 0, 100% 6px, 100% calc(100% - 6px), calc(100% - 6px) 100%, 6px 100%, 0 calc(100% - 6px), 0 6px)",transition:"all 0.25s ease"},onMouseEnter:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.18)",a.currentTarget.style.borderColor="rgba(229,195,75,0.6)",a.currentTarget.style.boxShadow="0 0 20px rgba(229,195,75,0.15), inset 0 0 12px rgba(229,195,75,0.06)",a.currentTarget.style.textShadow="0 0 10px rgba(229,195,75,0.5)",a.currentTarget.style.color="#f5d96b"},onMouseLeave:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.08)",a.currentTarget.style.borderColor="rgba(229,195,75,0.25)",a.currentTarget.style.boxShadow="none",a.currentTarget.style.textShadow="none",a.currentTarget.style.color="var(--cyber-glow)"},onMouseDown:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.3)",a.currentTarget.style.transform="scale(0.97)"},onMouseUp:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.18)",a.currentTarget.style.transform="scale(1)"},children:"ДОБАВИТЬ СОБЫТИЕ"})]})})})]})]})}let p={happy:{color:"#4ade80",label:"Счастлив"},neutral:{color:"#a0a0b0",label:"Нейтрален"},sad:{color:"#60a5fa",label:"Грустит"},angry:{color:"#f87171",label:"Злится"},excited:{color:"#e5c34b",label:"Воодушевлён"},anxious:{color:"#c084fc",label:"Тревожится"}},q=[{id:"agent-1",name:"Алексей",avatar:"А",mood:"happy",traits:["общительный","оптимист","любопытный"],description:"Молодой исследователь, который всегда ищет новые знакомства. Верит в лучшее в людях.",currentPlan:"Поговорить с Мариной о вчерашнем событии",memories:["Встретил Марину на площади","Поспорил с Виктором о политике","Нашёл старую книгу в библиотеке"]},{id:"agent-2",name:"Марина",avatar:"М",mood:"neutral",traits:["задумчивая","художница","интроверт"],description:"Талантливая художница, предпочитает одиночество. Наблюдает за миром через призму искусства.",currentPlan:"Закончить картину заката",memories:["Разговор с Алексеем был приятным","Виктор показался грубым","Увидела красивый закат"]},{id:"agent-3",name:"Виктор",avatar:"В",mood:"angry",traits:["прямолинейный","амбициозный","упрямый"],description:"Бывший военный, привык командовать. Не терпит слабости, но глубоко внутри одинок.",currentPlan:"Доказать свою правоту Алексею",memories:["Спор с Алексеем закончился ничем","Марина отвернулась при встрече","Вспомнил службу в армии"]},{id:"agent-4",name:"Елена",avatar:"Е",mood:"excited",traits:["энергичная","лидер","эмпат"],description:"Врач по профессии и миротворец по натуре. Старается помирить всех вокруг.",currentPlan:"Организовать общий ужин для всех",memories:["Помогла незнакомцу на улице","Заметила напряжение между Виктором и Алексеем","Получила письмо от старого друга"]},{id:"agent-5",name:"Дмитрий",avatar:"Д",mood:"sad",traits:["замкнутый","умный","меланхоличный"],description:"Бывший учёный, потерял лабораторию в пожаре. Живёт на окраине и избегает людей.",currentPlan:"Попытаться восстановить записи из сгоревшей лаборатории",memories:["Пожар уничтожил десять лет работы","Марина однажды принесла еду","Не доверяет Виктору"]},{id:"agent-6",name:"Ольга",avatar:"О",mood:"anxious",traits:["осторожная","наблюдательная","скрытная"],description:"Торговка на рынке. Знает все сплетни города, но сама держит много секретов.",currentPlan:"Разузнать, что случилось на площади вчера ночью",memories:["Видела Виктора в переулке поздно ночью","Елена покупает у неё травы каждую неделю","Кто-то следит за ней -- уверена"]},{id:"agent-7",name:"Игорь",avatar:"И",mood:"neutral",traits:["спокойный","справедливый","старомодный"],description:"Пожилой сторож библиотеки. Видел многое, говорит мало, но когда говорит -- все слушают.",currentPlan:"Присматривать за библиотекой и читать хроники",memories:["Алексей часто приходит читать","Помнит, каким был город до войны","Не одобряет поведение Виктора"]},{id:"agent-8",name:"Настя",avatar:"Н",mood:"happy",traits:["жизнерадостная","наивная","творческая"],description:"Студентка-музыкант, недавно приехала в город. Ещё не знает местных интриг.",currentPlan:"Найти место для репетиции и познакомиться с людьми",memories:["Город показался красивым, но странным","Марина улыбнулась ей на улице","Услышала громкий спор на площади"]}],r=[{id:"evt-1",agentId:"agent-1",agentName:"Алексей",type:"chat",text:"Привет, Марина! Как твоя новая картина?",timestamp:new Date(Date.now()-3e5).toISOString()},{id:"evt-2",agentId:"agent-2",agentName:"Марина",type:"emotion",text:"Почувствовала прилив вдохновения от заката",timestamp:new Date(Date.now()-24e4).toISOString()},{id:"evt-3",agentId:"agent-3",agentName:"Виктор",type:"action",text:"Отправился на площадь, чтобы найти Алексея",timestamp:new Date(Date.now()-18e4).toISOString()},{id:"evt-4",agentId:"agent-4",agentName:"Елена",type:"chat",text:"Виктор, давай поговорим спокойно. Я уверена, вы с Алексеем найдёте общий язык.",timestamp:new Date(Date.now()-12e4).toISOString()},{id:"evt-5",agentId:"agent-3",agentName:"Виктор",type:"emotion",text:"Раздражён: Елена снова лезет не в своё дело",timestamp:new Date(Date.now()-6e4).toISOString()},{id:"evt-6",agentId:"agent-1",agentName:"Алексей",type:"action",text:"Зашёл в библиотеку и нашёл интересную книгу об истории города",timestamp:new Date(Date.now()-3e4).toISOString()},{id:"evt-7",agentId:"agent-2",agentName:"Марина",type:"action",text:"Поставила мольберт у реки и начала рисовать",timestamp:new Date(Date.now()-15e3).toISOString()},{id:"evt-8",agentId:"agent-4",agentName:"Елена",type:"system",text:"Решила организовать общий ужин сегодня вечером",timestamp:new Date(Date.now()-5e3).toISOString()},{id:"evt-9",agentId:"agent-5",agentName:"Дмитрий",type:"action",text:"Нашёл обгоревший дневник среди руин лаборатории",timestamp:new Date(Date.now()-28e4).toISOString()},{id:"evt-10",agentId:"agent-6",agentName:"Ольга",type:"emotion",text:"Тревога нарастает -- кто-то определённо следит",timestamp:new Date(Date.now()-2e5).toISOString()},{id:"evt-11",agentId:"agent-7",agentName:"Игорь",type:"action",text:"Открыл старый архив в подвале библиотеки",timestamp:new Date(Date.now()-15e4).toISOString()},{id:"evt-12",agentId:"agent-8",agentName:"Настя",type:"chat",text:"Простите, вы не подскажете, где тут можно порепетировать?",timestamp:new Date(Date.now()-9e4).toISOString()}],s=[{from:"agent-1",to:"agent-2",sentiment:.7,label:"дружба"},{from:"agent-1",to:"agent-3",sentiment:-.4,label:"конфликт"},{from:"agent-1",to:"agent-7",sentiment:.4,label:"уважение"},{from:"agent-2",to:"agent-5",sentiment:.3,label:"сочувствие"},{from:"agent-2",to:"agent-8",sentiment:.5,label:"симпатия"},{from:"agent-3",to:"agent-4",sentiment:-.2,label:"раздражение"},{from:"agent-3",to:"agent-7",sentiment:-.3,label:"неприязнь"},{from:"agent-4",to:"agent-6",sentiment:.4,label:"торговля"},{from:"agent-4",to:"agent-1",sentiment:.5,label:"знакомые"},{from:"agent-6",to:"agent-3",sentiment:-.1,label:"подозрение"},{from:"agent-8",to:"agent-1",sentiment:.2,label:"знакомые"},{from:"agent-5",to:"agent-7",sentiment:.2,label:"соседи"}],t={totalEvents:847,totalConversations:234,avgMood:.62,mostActiveAgent:"Алексей",topRelationship:{from:"agent-1",to:"agent-2",sentiment:.7},eventsByType:[{type:"chat",count:312},{type:"action",count:289},{type:"emotion",count:178},{type:"system",count:68}],moodDistribution:[{mood:"happy",count:2},{mood:"neutral",count:2},{mood:"sad",count:1},{mood:"angry",count:1},{mood:"excited",count:1},{mood:"anxious",count:1}]},u=new Map(q.map(a=>[a.id,[]]));for(let a of r){let b=u.get(a.agentId)??[];b.push({id:`mock-msg-${a.id}`,agentId:a.agentId,agentName:a.agentName,role:"assistant",content:a.text,timestamp:a.timestamp}),u.set(a.agentId,b)}function v(){let a=process.env.NEXT_PUBLIC_USER_ID?.trim();return a&&a.length>0?a:"demo-user"}async function w(a,b,c=15e3){let d,e=new Headers(b?.headers);e.set("Accept","application/json"),e.set("X-User-Id",v()),b?.body&&!e.has("Content-Type")&&e.set("Content-Type","application/json");let f=new AbortController,g=setTimeout(()=>f.abort(),Math.max(1e3,c));try{d=await fetch(`/api/backend${a}`,{...b,headers:e,cache:"no-store",signal:f.signal})}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)throw Error(`Backend request timed out after ${c}ms`);throw a}finally{clearTimeout(g)}if(!d.ok)throw Error(`Backend request failed: ${d.status} ${d.statusText}`);return await d.json()}function x(a){var b,c,d;let e,f,g,h=(b=a.status,c=a.energy,d=a.emotion,e=b.toLowerCase(),f=d?.trim().toLowerCase()??"",g=Number.isFinite(c)?Math.max(0,Math.min(1,c)):.5,f.includes("радост")||f.includes("счаст")||f.includes("вдохнов")||f.includes("воодуш")?"happy":f.includes("спокой")||f.includes("нейтрал")?"neutral":f.includes("устал")||f.includes("груст")?"sad":f.includes("раздраж")||f.includes("зл")?"angry":f.includes("тревог")||f.includes("напряж")?"anxious":e.includes("error")||e.includes("failed")?"angry":e.includes("stop")||e.includes("archived")?"sad":e.includes("pause")?"anxious":g>=.8?"excited":g>=.6?"happy":g>=.4?"neutral":g>=.2?"anxious":"sad"),i=function(a,b){if(b&&b.length>0)return b.slice(0,8);if(!a)return["adaptive"];let c=[{key:"openness",label:"curious"},{key:"conscientiousness",label:"disciplined"},{key:"extraversion",label:"social"},{key:"agreeableness",label:"cooperative"},{key:"neuroticism",label:"sensitive"}].map(b=>({label:b.label,value:Number(a[b.key]??0)})).sort((a,b)=>b.value-a.value).filter(a=>a.value>0).slice(0,3).map(a=>a.label);return c.length>0?c:["adaptive"]}(a.personalityTraits,a.traits),j=a.memories&&a.memories.length>0?a.memories:a.state?[`Current state: ${a.state}`]:[];return{id:a.agentId,name:a.name,avatar:a.name?.trim()?.charAt(0)?.toUpperCase()||"?",mood:h,traits:i,description:a.description?.trim()||`${a.model} - status: ${a.status}`,currentPlan:a.currentPlan?.trim()||a.state||"No current plan",memories:j}}function y(a){return!a||"object"!=typeof a||Array.isArray(a)?null:a}function z(a,b){if(a)for(let c of b){let b=a[c];if("string"==typeof b&&b.trim().length>0)return b.trim()}}function A(a){let b=a.replace(/\*\*/g," ").replace(/[«»]/g,'"').replace(/^[\"']+|[\"']+$/g,"").replace(/\s+/g," ").trim();return b?b.length<=400?b:`${b.slice(0,397)}...`:""}function B(a,b){let c,d="user"===(c=a.role.trim().toLowerCase())||"assistant"===c||"system"===c?c:"assistant";return{id:a.messageId,agentId:a.agentId,agentName:b.get(a.agentId)?.name??"Agent",role:d,content:function(a,b){let c,d=a.trim();if(!d)return"";let e=d.split(/\r?\n/).map(a=>a.trim().replace(/^\*+|\*+$/g,"").trim()).filter(a=>a.length>0);if(0===e.length)return"";if("assistant"===b){let a=e.find(a=>a.toLowerCase().startsWith("actiontext"));if(a){let b=a.indexOf(":");return A(b>=0?a.slice(b+1).trim():a)}return A(e.filter(a=>{let b=a.toLowerCase();return!b.startsWith("actionname")&&!b.startsWith("actiontext")}).join(" "))}return e.length>1&&!(!(c=e[0].trim().toLowerCase())||c.includes(" "))&&("world.update"===c||c.startsWith("chat.")||c.startsWith("action.")||c.startsWith("custom.")||c.startsWith("ui.")||c.startsWith("system."))?e.slice(1).join("\n"):e.join("\n")}(a.content,d),timestamp:a.createdAt,correlationId:a.correlationId}}async function C(a){try{return await w("/api/events",{method:"POST",body:JSON.stringify({type:"ui.note",payload:{text:a,message:a,source:"frontend",agentName:"Operator"}})}),!0}catch(a){return console.warn("[data] addEvent fallback, backend unavailable",a),!1}}function D(a){return q.find(b=>b.id===a)?.name??a}function E(a,b,c,d){let e=u.get(a)??[];e.push({id:`mock-msg-${Math.random().toString(36).slice(2,10)}`,agentId:a,agentName:D(a),role:b,content:c,timestamp:new Date().toISOString(),correlationId:d}),u.set(a,e)}async function F(a,b=80){let c=a.trim();if(!c)return[];try{let[a,d]=await Promise.all([w(`/api/user-agents/${encodeURIComponent(c)}/messages?limit=${Math.max(1,Math.floor(b))}`),L()]),e=new Map(d.map(a=>[a.id,a]));return a.items.map(a=>B(a,e)).filter(a=>a.content.trim().length>0)}catch(a){var d;return console.warn("[data] getAgentMessages fallback to mock",a),d=Math.max(1,Math.floor(b)),(u.get(c)??[]).slice(-d)}}async function G(a=20){let b=Math.max(1,Math.floor(a));try{let[a,c]=await Promise.all([w(`/api/user-agents/messages?limitPerAgent=${b}`),L()]),d=new Map(c.map(a=>[a.id,a]));return a.items.map(a=>B(a,d)).filter(a=>a.content.trim().length>0)}catch(a){return console.warn("[data] getAllAgentMessages fallback to mock",a),Array.from(u.values()).flatMap(a=>a.slice(-b)).sort((a,b)=>new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime())}}async function H(a,b,c){let d=a.trim(),e=b.trim(),f=c?.trim();if(!d||!e&&!f)return null;try{let a=await w(`/api/user-agents/${encodeURIComponent(d)}/commands`,{method:"POST",body:JSON.stringify({command:f||void 0,message:e||void 0})});return{agentId:a.agentId,userId:a.userId,correlationId:a.correlationId,status:a.status,acceptedAt:a.acceptedAt}}catch(b){console.warn("[data] commandAgent fallback to mock",b);let a=`mock-${Date.now().toString(36)}`;return E(d,"user",e||f||"...",a),E(d,"assistant",`${D(d)} получил команду и готов действовать.`,a),{agentId:d,userId:v(),correlationId:a,status:"Working",acceptedAt:new Date().toISOString()}}}async function I(a,b){let c=a.trim(),d=b?.command?.trim();if(!c&&!d)return null;let e={command:d||void 0,message:c||void 0,agentIds:b?.agentIds&&b.agentIds.length>0?b.agentIds:void 0};try{let a=await w("/api/user-agents/commands/broadcast",{method:"POST",body:JSON.stringify(e)});return{userId:a.userId,acceptedAt:a.acceptedAt,acceptedCount:a.acceptedCount,rejectedCount:a.rejectedCount,items:a.items.map(a=>({agentId:a.agentId,status:a.status,correlationId:a.correlationId,reason:a.reason}))}}catch(g){console.warn("[data] broadcastAgentCommand fallback to mock",g);let a=b?.agentIds?.filter(a=>a.trim().length>0)??q.map(a=>a.id),e=`mock-${Date.now().toString(36)}`,f=a.map((a,b)=>{let f=`${e}-${b+1}`;return E(a,"user",c||d||"...",f),E(a,"assistant",`${D(a)} получил общий сигнал и приступает к задаче.`,f),{agentId:a,status:"accepted",correlationId:f}});return{userId:v(),acceptedAt:new Date().toISOString(),acceptedCount:f.length,rejectedCount:0,items:f}}}async function J(a,b){let c=a.trim();if(!c)return null;let d={prompt:c,model:b?.trim()||void 0};try{let a=await w("/api/user-agents/generate",{method:"POST",body:JSON.stringify(d)},9e4);return x(a)}catch(a){return console.warn("[data] generateAgentWithAi failed",a),null}}async function K(a){let b=a.trim();if(!b)return!1;try{return await w(`/api/user-agents/${encodeURIComponent(b)}`,{method:"DELETE"}),!0}catch(a){return console.warn("[data] deleteAgent failed",a),!1}}async function L(){try{return(await w("/api/user-agents")).map(x)}catch(a){return console.warn("[data] getAgents fallback to mock",a),q}}async function M(){try{let[a,b]=await Promise.all([L(),w("/api/events")]),c=new Map(a.map(a=>[a.id,a]));return b.map(a=>{var b,d;let e,f,g,h,i;return b=a,d=c,f=y(b.payload),g=y(f?.payload)??f,h=z(g,["agentId","agent_id","id"])??z(y(g?.agent),["id","agentId"])??"system",i=z(g,["agentName","agent_name","name"])??d.get(h)?.name??"System",{id:b.id,agentId:h,agentName:i,type:(e=b.type.toLowerCase()).includes("chat")||e.includes("message")?"chat":e.includes("emotion")||e.includes("mood")?"emotion":e.includes("system")||e.includes("status")||e.includes("error")||e.includes("progress")?"system":"action",text:function(a,b){let c=y(a),d=z(c,["text","message","description","content"]);if(d)return d;if(c){let a=z(y(c.payload),["text","message","description","content"]);if(a)return a}try{let c=JSON.stringify(a);if(!c||"{}"===c)return b;return c.slice(0,200)}catch{return b}}(b.payload,b.type),timestamp:b.createdAt}})}catch(a){return console.warn("[data] getEvents fallback to mock",a),r}}async function N(){try{return(await w("/api/relationships")).map(a=>({from:a.from,to:a.to,sentiment:a.sentiment,label:a.label??"interaction"}))}catch(a){return console.warn("[data] getRelationships fallback to mock",a),s}}async function O(){try{var a;return{totalEvents:(a=await w("/api/stats")).totalEvents,totalConversations:a.totalConversations,avgMood:a.avgMood,mostActiveAgent:a.mostActiveAgent,topRelationship:a.topRelationship,eventsByType:a.eventsByType,moodDistribution:a.moodDistribution.map(a=>{let b;return{mood:(b=a.mood.trim().toLowerCase(),"happy"===b||"neutral"===b||"sad"===b||"angry"===b||"excited"===b||"anxious"===b?b:"neutral"),count:a.count}})}}catch(a){return console.warn("[data] getStats fallback to mock",a),t}}async function P(){try{let a=await w("/api/world/time");return{gameTime:a.gameTime,speed:a.speed}}catch(a){return console.warn("[data] getWorldTime failed",a),null}}async function Q(a){try{let b=await w("/api/world/time/speed",{method:"POST",body:JSON.stringify({speed:a})});return{gameTime:b.gameTime,speed:b.speed}}catch(a){return console.warn("[data] setWorldTimeSpeed failed",a),null}}async function R(){try{let a=await w("/api/world/time/reset",{method:"POST"});return{gameTime:a.gameTime,speed:a.speed}}catch(a){return console.warn("[data] resetWorldSimulation failed",a),null}}function S(a){return a>=.5?"#4ade80":a>=.2?"#86efac":a>-.2?"#555566":a>-.5?"#fca5a5":"#f87171"}function T({visible:a}){return(0,l.jsxs)("div",{className:"absolute inset-0 z-30 flex items-center justify-center",style:{backgroundColor:"var(--cyber-surface)",opacity:+!!a,pointerEvents:a?"auto":"none",transition:"opacity 0.6s ease"},children:[(0,l.jsx)("div",{className:"pointer-events-none absolute inset-0 opacity-10",style:{backgroundImage:"linear-gradient(var(--cyber-glow) 1px, transparent 1px), linear-gradient(90deg, var(--cyber-glow) 1px, transparent 1px)",backgroundSize:"60px 60px"}}),(0,l.jsxs)("div",{className:"relative flex flex-col items-center gap-4",children:[(0,l.jsx)("div",{className:"h-16 w-16 rounded-full border flex items-center justify-center",style:{borderColor:"var(--cyber-glow)",boxShadow:"0 0 20px var(--cyber-glow-dim), inset 0 0 20px var(--cyber-glow-dim)",animation:"cyber-pulse 2s ease-in-out infinite"},children:(0,l.jsxs)("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"var(--cyber-glow)",strokeWidth:"1.5",children:[(0,l.jsx)("circle",{cx:"5",cy:"12",r:"2"}),(0,l.jsx)("circle",{cx:"19",cy:"6",r:"2"}),(0,l.jsx)("circle",{cx:"19",cy:"18",r:"2"}),(0,l.jsx)("line",{x1:"7",y1:"12",x2:"17",y2:"6"}),(0,l.jsx)("line",{x1:"7",y1:"12",x2:"17",y2:"18"})]})}),(0,l.jsx)("p",{className:"font-mono text-sm tracking-[0.2em] uppercase",style:{color:"var(--cyber-glow)",opacity:.6},children:"ЗАГРУЗКА ГРАФА"})]})]})}function U(){return(0,l.jsxs)("div",{className:"absolute bottom-3 left-3 z-20 flex items-center gap-4 px-3 py-2 font-mono text-[11px]",style:{backgroundColor:"rgba(10,10,15,0.85)",border:"1px solid rgba(229,195,75,0.15)"},children:[[{color:"#4ade80",label:"Дружба"},{color:"#555566",label:"Нейтрально"},{color:"#f87171",label:"Конфликт"}].map(a=>(0,l.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,l.jsx)("div",{className:"h-[2px] w-4",style:{backgroundColor:a.color}}),(0,l.jsx)("span",{style:{color:"var(--muted-foreground)"},children:a.label})]},a.label)),(0,l.jsx)("div",{className:"flex items-center gap-1.5 ml-2",style:{borderLeft:"1px solid rgba(229,195,75,0.15)",paddingLeft:8},children:(0,l.jsx)("span",{style:{color:"var(--muted-foreground)"},children:"Клик = профиль"})})]})}function V({onSelectAgent:b,refreshToken:c}){let d=(0,m.useRef)(null),e=(0,m.useRef)(null),[f,g]=(0,m.useState)({width:0,height:0}),[h,i]=(0,m.useState)(!1),[j,k]=(0,m.useState)(!1),[n,o]=(0,m.useState)([]),[q,r]=(0,m.useState)([]),[s,t]=(0,m.useState)({nodes:[],links:[]}),[u,v]=(0,m.useState)(null),[w,x]=(0,m.useState)(null),[y,z]=(0,m.useState)({x:0,y:0}),A=(0,m.useRef)(""),B=(0,m.useRef)(""),C=(0,m.useRef)(!1);(0,m.useEffect)(()=>{let a=!0;C.current||k(!1);let b=async()=>{let[b,c]=await Promise.all([L(),N()]);if(!a)return;let d=JSON.stringify(b.map(a=>[a.id,a.name,a.avatar,a.mood])),e=JSON.stringify(c.map(a=>[a.from,a.to,a.sentiment,a.label])),f=!1;d!==A.current&&(A.current=d,o(b),f=!0),e!==B.current&&(B.current=e,r(c),f=!0),f&&t(a=>{let d,e,f;return d=new Set(b.map(a=>a.id)),e={nodes:b.map(a=>({id:a.id,name:a.name,avatar:a.avatar,mood:a.mood,moodColor:p[a.mood].color,val:8})),links:c.filter(a=>d.has(a.from)&&d.has(a.to)).map(a=>({source:a.from,target:a.to,sentiment:a.sentiment,label:a.label,color:S(a.sentiment)}))},f=new Map(a.nodes.map(a=>[a.id,a])),{nodes:e.nodes.map(a=>{let b=f.get(a.id);return b?{...a,x:b.x,y:b.y,fx:b.fx,fy:b.fy,__dragging:b.__dragging}:a}),links:e.links}}),C.current||(C.current=!0,k(!0))};b();let c=setInterval(()=>{b()},4e3);return()=>{a=!1,clearInterval(c)}},[c]),(0,m.useEffect)(()=>{let a=d.current;if(!a)return;let b=new ResizeObserver(a=>{for(let b of a)g({width:b.contentRect.width,height:b.contentRect.height})});return b.observe(a),()=>b.disconnect()},[]),(0,m.useEffect)(()=>{a.A(68482).then(a=>{v(()=>a.default),setTimeout(()=>i(!0),500)})},[]);let D=(0,m.useRef)(!1);(0,m.useEffect)(()=>{let b=e.current;b&&!D.current&&h&&(D.current=!0,b.d3Force("charge")?.strength(-300).distanceMax(500),b.d3Force("link")?.distance(120).strength(.35),b.d3Force("center")?.strength(.04),a.A(76698).then(({forceCollide:a})=>{b.d3Force("collide",a(30).strength(1).iterations(4)),b.d3ReheatSimulation()}),b.d3ReheatSimulation())},[h]),(0,m.useEffect)(()=>{let a=e.current;if(!a||!h||0===f.width)return;let b=setTimeout(()=>{a.zoomToFit(400,40),a.d3ReheatSimulation()},100);return()=>clearTimeout(b)},[f,h]);let E=(0,m.useCallback)((a,b,c)=>{let d=a.x??0,e=a.y??0,f=w?.id===a.id,g=Math.max(11/c,2.5);b.save(),f&&(b.beginPath(),b.arc(d,e,20,0,2*Math.PI),b.fillStyle="rgba(229,195,75,0.06)",b.fill()),b.beginPath(),b.arc(d,e,14,0,2*Math.PI),b.fillStyle="#111118",b.fill(),b.strokeStyle=f?"#e5c34b":a.moodColor,b.lineWidth=1.5,b.stroke(),b.textAlign="center",b.textBaseline="middle",b.font="bold 11.200000000000001px 'Geist Mono', monospace",b.fillStyle=f?"#e5c34b":a.moodColor,b.fillText(a.avatar,d,e+.5),c>.45&&(b.font=`${g}px 'Geist Mono', monospace`,b.fillStyle=f?"#e5c34b":"rgba(229,195,75,0.3)",b.fillText(a.name,d,e+14+g+3)),b.restore()},[w]),F=(0,m.useCallback)((a,b)=>{let c=a.source,d=a.target;null!=c.x&&null!=c.y&&null!=d.x&&null!=d.y&&(b.save(),b.beginPath(),b.moveTo(c.x,c.y),b.lineTo(d.x,d.y),b.strokeStyle=a.color,b.lineWidth=1.2,b.globalAlpha=.4,b.stroke(),b.restore())},[]),G=(0,m.useMemo)(()=>{if(!w)return null;let a=n.find(a=>a.id===w.id);if(!a)return null;let b=p[a.mood],c=q.filter(b=>b.from===a.id||b.to===a.id).map(b=>{let c=b.from===a.id?b.to:b.from,d=n.find(a=>a.id===c);return{name:d?.name??c,sentiment:b.sentiment,label:b.label}});return{agent:a,moodCfg:b,rels:c}},[w,n,q]),H=(0,m.useCallback)(a=>{b&&b(a.id)},[b]),I=(0,m.useCallback)(a=>{a.__dragging=!0,a.fx=a.x,a.fy=a.y},[]),J=(0,m.useCallback)(a=>{a.__dragging=!1,setTimeout(()=>{a.__dragging||(a.fx=void 0,a.fy=void 0)},300)},[]);return(0,l.jsxs)("div",{ref:d,className:"relative h-full w-full overflow-hidden",style:{backgroundColor:"var(--cyber-surface)"},onMouseMove:a=>{let b=d.current?.getBoundingClientRect();b&&z({x:a.clientX-b.left,y:a.clientY-b.top})},children:[(0,l.jsx)("div",{className:"pointer-events-none absolute inset-0 opacity-[0.04]",style:{backgroundImage:"linear-gradient(var(--cyber-glow) 1px, transparent 1px), linear-gradient(90deg, var(--cyber-glow) 1px, transparent 1px)",backgroundSize:"50px 50px"}}),(0,l.jsx)(T,{visible:!h||!j}),u&&f.width>0&&(0,l.jsx)(u,{ref:e,graphData:s,width:f.width,height:f.height,backgroundColor:"transparent",d3AlphaDecay:.005,d3VelocityDecay:.25,warmupTicks:0,cooldownTime:1/0,nodeCanvasObject:E,nodePointerAreaPaint:(a,b,c)=>{let d=a.x??0,e=a.y??0;c.fillStyle=b,c.beginPath(),c.arc(d,e,22,0,2*Math.PI),c.fill()},nodeLabel:()=>"",nodeVal:()=>1,onNodeHover:a=>{x(a||null),d.current&&(d.current.style.cursor=a?"pointer":"default")},onNodeClick:H,onNodeDrag:I,onNodeDragEnd:J,enableNodeDrag:!0,linkCanvasObject:F,linkDirectionalParticles:0,linkPointerAreaPaint:()=>{},enableZoomInteraction:!0,enablePanInteraction:!0,minZoom:.3,maxZoom:6}),w&&G&&(0,l.jsxs)("div",{className:"absolute z-40 pointer-events-none font-mono",style:{left:Math.min(y.x+18,f.width-230),top:Math.max(y.y-14,8),backgroundColor:"rgba(10,10,15,0.94)",border:"1px solid rgba(229,195,75,0.2)",padding:"10px 14px",minWidth:"180px",maxWidth:"240px"},children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-1.5",children:[(0,l.jsx)("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold",style:{backgroundColor:G.moodCfg.color+"25",color:G.moodCfg.color,border:`1px solid ${G.moodCfg.color}50`},children:G.agent.avatar}),(0,l.jsx)("span",{className:"text-sm",style:{color:"var(--cyber-glow)"},children:G.agent.name})]}),(0,l.jsxs)("div",{className:"text-[10px] flex items-center gap-1.5 mb-2",style:{color:G.moodCfg.color},children:[(0,l.jsx)("div",{className:"w-1.5 h-1.5 rounded-full",style:{backgroundColor:G.moodCfg.color}}),G.moodCfg.label,(0,l.jsx)("span",{style:{color:"var(--muted-foreground)",marginLeft:4},children:G.agent.traits.slice(0,2).join(", ")})]}),G.rels.length>0&&(0,l.jsxs)("div",{style:{borderTop:"1px solid rgba(229,195,75,0.1)"},className:"pt-1.5",children:[(0,l.jsx)("div",{className:"text-[9px] uppercase tracking-widest mb-1",style:{color:"var(--muted-foreground)"},children:"Связи"}),G.rels.map(a=>(0,l.jsxs)("div",{className:"flex items-center justify-between text-[10px] py-0.5",children:[(0,l.jsx)("span",{style:{color:"var(--foreground)"},children:a.name}),(0,l.jsx)("span",{style:{color:S(a.sentiment),fontSize:"9px"},children:a.label})]},a.name))]}),0===G.rels.length&&(0,l.jsx)("div",{className:"text-[10px] pt-1",style:{color:"var(--muted-foreground)",borderTop:"1px solid rgba(229,195,75,0.1)",paddingTop:6},children:"Нет связей с другими агентами"})]}),(0,l.jsx)(U,{})]})}let W=[0,2e3,1e4,3e4,null];class X{constructor(a){this._retryDelays=void 0!==a?[...a,null]:W}nextRetryDelayInMilliseconds(a){return this._retryDelays[a.previousRetryCount]}}class Y{}Y.Authorization="Authorization",Y.Cookie="Cookie";class Z{constructor(a,b,c){this.statusCode=a,this.statusText=b,this.content=c}}class ${get(a,b){return this.send({...b,method:"GET",url:a})}post(a,b){return this.send({...b,method:"POST",url:a})}delete(a,b){return this.send({...b,method:"DELETE",url:a})}getCookieString(a){return""}}class _ extends ${constructor(a,b){super(),this._innerClient=a,this._accessTokenFactory=b}async send(a){let b=!0;this._accessTokenFactory&&(!this._accessToken||a.url&&a.url.indexOf("/negotiate?")>0)&&(b=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(a);let c=await this._innerClient.send(a);return b&&401===c.statusCode&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(a),await this._innerClient.send(a)):c}_setAuthorizationHeader(a){a.headers||(a.headers={}),this._accessToken?a.headers[Y.Authorization]=`Bearer ${this._accessToken}`:this._accessTokenFactory&&a.headers[Y.Authorization]&&delete a.headers[Y.Authorization]}getCookieString(a){return this._innerClient.getCookieString(a)}}class aa extends Error{constructor(a,b){const c=new.target.prototype;super(`${a}: Status code '${b}'`),this.statusCode=b,this.__proto__=c}}class ab extends Error{constructor(a="A timeout occurred."){const b=new.target.prototype;super(a),this.__proto__=b}}class ac extends Error{constructor(a="An abort occurred."){const b=new.target.prototype;super(a),this.__proto__=b}}class ad extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.transport=b,this.errorType="UnsupportedTransportError",this.__proto__=c}}class ae extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.transport=b,this.errorType="DisabledTransportError",this.__proto__=c}}class af extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.transport=b,this.errorType="FailedToStartTransportError",this.__proto__=c}}class ag extends Error{constructor(a){const b=new.target.prototype;super(a),this.errorType="FailedToNegotiateWithServerError",this.__proto__=b}}class ah extends Error{constructor(a,b){const c=new.target.prototype;super(a),this.innerErrors=b,this.__proto__=c}}(b=g||(g={}))[b.Trace=0]="Trace",b[b.Debug=1]="Debug",b[b.Information=2]="Information",b[b.Warning=3]="Warning",b[b.Error=4]="Error",b[b.Critical=5]="Critical",b[b.None=6]="None";class ai{log(a,b){}}ai.instance=new ai;class aj{static isRequired(a,b){if(null==a)throw Error(`The '${b}' argument is required.`)}static isNotEmpty(a,b){if(!a||a.match(/^\s*$/))throw Error(`The '${b}' argument should not be empty.`)}static isIn(a,b,c){if(!(a in b))throw Error(`Unknown ${c} value: ${a}.`)}}class ak{static get isBrowser(){return!ak.isNode&&!1}static get isWebWorker(){return!ak.isNode&&"object"==typeof self&&"importScripts"in self}static get isReactNative(){return!ak.isNode&&!1}static get isNode(){return"u">typeof process&&process.release&&"node"===process.release.name}}function al(a,b){let c,d,e="";return am(a)?(e=`Binary data of length ${a.byteLength}`,b&&(e+=`. Content: '${c=new Uint8Array(a),d="",c.forEach(a=>{let b=a<16?"0":"";d+=`0x${b}${a.toString(16)} `}),d.substr(0,d.length-1)}'`)):"string"==typeof a&&(e=`String data of length ${a.length}`,b&&(e+=`. Content: '${a}'`)),e}function am(a){return a&&"u">typeof ArrayBuffer&&(a instanceof ArrayBuffer||a.constructor&&"ArrayBuffer"===a.constructor.name)}async function an(a,b,c,d,e,f){let h={},[i,j]=aq();h[i]=j,a.log(g.Trace,`(${b} transport) sending data. ${al(e,f.logMessageContent)}.`);let k=am(e)?"arraybuffer":"text",l=await c.post(d,{content:e,headers:{...h,...f.headers},responseType:k,timeout:f.timeout,withCredentials:f.withCredentials});a.log(g.Trace,`(${b} transport) request complete. Response status: ${l.statusCode}.`)}class ao{constructor(a,b){this._subject=a,this._observer=b}dispose(){let a=this._subject.observers.indexOf(this._observer);a>-1&&this._subject.observers.splice(a,1),0===this._subject.observers.length&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(a=>{})}}class ap{constructor(a){this._minLevel=a,this.out=console}log(a,b){if(a>=this._minLevel){let c=`[${new Date().toISOString()}] ${g[a]}: ${b}`;switch(a){case g.Critical:case g.Error:this.out.error(c);break;case g.Warning:this.out.warn(c);break;case g.Information:this.out.info(c);break;default:this.out.log(c)}}}}function aq(){var a,b,c,d;let e,f,g="X-SignalR-User-Agent";return ak.isNode&&(g="User-Agent"),[g,(a="8.0.17",b=function(){if(!ak.isNode)return"";switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}}(),c=ak.isNode?"NodeJS":"Browser",d=function(){if(ak.isNode)return process.versions.node}(),e="Microsoft SignalR/",f=a.split("."),e+=`${f[0]}.${f[1]} (${a}; `,b&&""!==b?e+=`${b}; `:e+="Unknown OS; ",e+=`${c}`,d?e+=`; ${d}`:e+="; Unknown Runtime Version",e+=")")]}function ar(a){return a.stack?a.stack:a.message?a.message:`${a}`}class as extends ${constructor(b){if(super(),this._logger=b,"u"<typeof fetch||ak.isNode){const b="function"==typeof __webpack_require__?__non_webpack_require__:a.z;this._jar=new(b("tough-cookie")).CookieJar,"u"<typeof fetch?this._fetchType=b("node-fetch"):this._fetchType=fetch,this._fetchType=b("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind("u">typeof globalThis?globalThis:"u">typeof self?self:a.g);if("u"<typeof AbortController){const b="function"==typeof __webpack_require__?__non_webpack_require__:a.z;this._abortControllerType=b("abort-controller")}else this._abortControllerType=AbortController}async send(a){let b,c;if(a.abortSignal&&a.abortSignal.aborted)throw new ac;if(!a.method)throw Error("No method defined.");if(!a.url)throw Error("No url defined.");let d=new this._abortControllerType;a.abortSignal&&(a.abortSignal.onabort=()=>{d.abort(),b=new ac});let e=null;a.timeout&&(e=setTimeout(()=>{d.abort(),this._logger.log(g.Warning,"Timeout from HTTP request."),b=new ab},a.timeout)),""===a.content&&(a.content=void 0),a.content&&(a.headers=a.headers||{},am(a.content)?a.headers["Content-Type"]="application/octet-stream":a.headers["Content-Type"]="text/plain;charset=UTF-8");try{c=await this._fetchType(a.url,{body:a.content,cache:"no-cache",credentials:!0===a.withCredentials?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...a.headers},method:a.method,mode:"cors",redirect:"follow",signal:d.signal})}catch(a){if(b)throw b;throw this._logger.log(g.Warning,`Error from HTTP request. ${a}.`),a}finally{e&&clearTimeout(e),a.abortSignal&&(a.abortSignal.onabort=null)}if(!c.ok)throw new aa(await at(c,"text")||c.statusText,c.status);let f=at(c,a.responseType),h=await f;return new Z(c.status,c.statusText,h)}getCookieString(a){let b="";return ak.isNode&&this._jar&&this._jar.getCookies(a,(a,c)=>b=c.join("; ")),b}}function at(a,b){let c;switch(b){case"arraybuffer":c=a.arrayBuffer();break;case"text":default:c=a.text();break;case"blob":case"document":case"json":throw Error(`${b} is not supported.`)}return c}class au extends ${constructor(a){super(),this._logger=a}send(a){return a.abortSignal&&a.abortSignal.aborted?Promise.reject(new ac):a.method?a.url?new Promise((b,c)=>{let d=new XMLHttpRequest;d.open(a.method,a.url,!0),d.withCredentials=void 0===a.withCredentials||a.withCredentials,d.setRequestHeader("X-Requested-With","XMLHttpRequest"),""===a.content&&(a.content=void 0),a.content&&(am(a.content)?d.setRequestHeader("Content-Type","application/octet-stream"):d.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));let e=a.headers;e&&Object.keys(e).forEach(a=>{d.setRequestHeader(a,e[a])}),a.responseType&&(d.responseType=a.responseType),a.abortSignal&&(a.abortSignal.onabort=()=>{d.abort(),c(new ac)}),a.timeout&&(d.timeout=a.timeout),d.onload=()=>{a.abortSignal&&(a.abortSignal.onabort=null),d.status>=200&&d.status<300?b(new Z(d.status,d.statusText,d.response||d.responseText)):c(new aa(d.response||d.responseText||d.statusText,d.status))},d.onerror=()=>{this._logger.log(g.Warning,`Error from HTTP request. ${d.status}: ${d.statusText}.`),c(new aa(d.statusText,d.status))},d.ontimeout=()=>{this._logger.log(g.Warning,"Timeout from HTTP request."),c(new ab)},d.send(a.content)}):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}}class av extends ${constructor(a){if(super(),"u">typeof fetch||ak.isNode)this._httpClient=new as(a);else if("u">typeof XMLHttpRequest)this._httpClient=new au(a);else throw Error("No usable HttpClient found.")}send(a){return a.abortSignal&&a.abortSignal.aborted?Promise.reject(new ac):a.method?a.url?this._httpClient.send(a):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}getCookieString(a){return this._httpClient.getCookieString(a)}}(c=h||(h={}))[c.None=0]="None",c[c.WebSockets=1]="WebSockets",c[c.ServerSentEvents=2]="ServerSentEvents",c[c.LongPolling=4]="LongPolling",(d=i||(i={}))[d.Text=1]="Text",d[d.Binary=2]="Binary";class aw{constructor(){this._isAborted=!1,this.onabort=null}abort(){!this._isAborted&&(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}}class ax{get pollAborted(){return this._pollAbort.aborted}constructor(a,b,c){this._httpClient=a,this._logger=b,this._pollAbort=new aw,this._options=c,this._running=!1,this.onreceive=null,this.onclose=null}async connect(a,b){if(aj.isRequired(a,"url"),aj.isRequired(b,"transferFormat"),aj.isIn(b,i,"transferFormat"),this._url=a,this._logger.log(g.Trace,"(LongPolling transport) Connecting."),b===i.Binary&&"u">typeof XMLHttpRequest&&"string"!=typeof new XMLHttpRequest().responseType)throw Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");let[c,d]=aq(),e={[c]:d,...this._options.headers},f={abortSignal:this._pollAbort.signal,headers:e,timeout:1e5,withCredentials:this._options.withCredentials};b===i.Binary&&(f.responseType="arraybuffer");let h=`${a}&_=${Date.now()}`;this._logger.log(g.Trace,`(LongPolling transport) polling: ${h}.`);let j=await this._httpClient.get(h,f);200!==j.statusCode?(this._logger.log(g.Error,`(LongPolling transport) Unexpected response code: ${j.statusCode}.`),this._closeError=new aa(j.statusText||"",j.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,f)}async _poll(a,b){try{for(;this._running;)try{let c=`${a}&_=${Date.now()}`;this._logger.log(g.Trace,`(LongPolling transport) polling: ${c}.`);let d=await this._httpClient.get(c,b);204===d.statusCode?(this._logger.log(g.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==d.statusCode?(this._logger.log(g.Error,`(LongPolling transport) Unexpected response code: ${d.statusCode}.`),this._closeError=new aa(d.statusText||"",d.statusCode),this._running=!1):d.content?(this._logger.log(g.Trace,`(LongPolling transport) data received. ${al(d.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(d.content)):this._logger.log(g.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(a){this._running?a instanceof ab?this._logger.log(g.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=a,this._running=!1):this._logger.log(g.Trace,`(LongPolling transport) Poll errored after shutdown: ${a.message}`)}}finally{this._logger.log(g.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(a){return this._running?an(this._logger,"LongPolling",this._httpClient,this._url,a,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(g.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{let a;await this._receiving,this._logger.log(g.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);let b={},[c,d]=aq();b[c]=d;let e={headers:{...b,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};try{await this._httpClient.delete(this._url,e)}catch(b){a=b}a?a instanceof aa&&(404===a.statusCode?this._logger.log(g.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(g.Trace,`(LongPolling transport) Error sending a DELETE request: ${a}`)):this._logger.log(g.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(g.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let a="(LongPolling transport) Firing onclose event.";this._closeError&&(a+=" Error: "+this._closeError),this._logger.log(g.Trace,a),this.onclose(this._closeError)}}}class ay{constructor(a,b,c,d){this._httpClient=a,this._accessToken=b,this._logger=c,this._options=d,this.onreceive=null,this.onclose=null}async connect(a,b){return aj.isRequired(a,"url"),aj.isRequired(b,"transferFormat"),aj.isIn(b,i,"transferFormat"),this._logger.log(g.Trace,"(SSE transport) Connecting."),this._url=a,this._accessToken&&(a+=(0>a.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(this._accessToken)}`),new Promise((c,d)=>{let e,f=!1;if(b!==i.Text)return void d(Error("The Server-Sent Events transport only supports the 'Text' transfer format"));if(ak.isBrowser||ak.isWebWorker)e=new this._options.EventSource(a,{withCredentials:this._options.withCredentials});else{let b=this._httpClient.getCookieString(a),c={};c.Cookie=b;let[d,f]=aq();c[d]=f,e=new this._options.EventSource(a,{withCredentials:this._options.withCredentials,headers:{...c,...this._options.headers}})}try{e.onmessage=a=>{if(this.onreceive)try{this._logger.log(g.Trace,`(SSE transport) data received. ${al(a.data,this._options.logMessageContent)}.`),this.onreceive(a.data)}catch(a){this._close(a);return}},e.onerror=a=>{f?this._close():d(Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},e.onopen=()=>{this._logger.log(g.Information,`SSE connected to ${this._url}`),this._eventSource=e,f=!0,c()}}catch(a){d(a);return}})}async send(a){return this._eventSource?an(this._logger,"SSE",this._httpClient,this._url,a,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(a){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(a))}}class az{constructor(a,b,c,d,e,f){this._logger=c,this._accessTokenFactory=b,this._logMessageContent=d,this._webSocketConstructor=e,this._httpClient=a,this.onreceive=null,this.onclose=null,this._headers=f}async connect(a,b){let c;return aj.isRequired(a,"url"),aj.isRequired(b,"transferFormat"),aj.isIn(b,i,"transferFormat"),this._logger.log(g.Trace,"(WebSockets transport) Connecting."),this._accessTokenFactory&&(c=await this._accessTokenFactory()),new Promise((d,e)=>{let f;a=a.replace(/^http/,"ws");let h=this._httpClient.getCookieString(a),j=!1;if(ak.isNode||ak.isReactNative){let b={},[d,e]=aq();b[d]=e,c&&(b[Y.Authorization]=`Bearer ${c}`),h&&(b[Y.Cookie]=h),f=new this._webSocketConstructor(a,void 0,{headers:{...b,...this._headers}})}else c&&(a+=(0>a.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(c)}`);f||(f=new this._webSocketConstructor(a)),b===i.Binary&&(f.binaryType="arraybuffer"),f.onopen=b=>{this._logger.log(g.Information,`WebSocket connected to ${a}.`),this._webSocket=f,j=!0,d()},f.onerror=a=>{let b=null;b="u">typeof ErrorEvent&&a instanceof ErrorEvent?a.error:"There was an error with the transport",this._logger.log(g.Information,`(WebSockets transport) ${b}.`)},f.onmessage=a=>{if(this._logger.log(g.Trace,`(WebSockets transport) data received. ${al(a.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(a.data)}catch(a){this._close(a);return}},f.onclose=a=>{if(j)this._close(a);else e(Error("u">typeof ErrorEvent&&a instanceof ErrorEvent?a.error:"WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled."))}})}send(a){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(g.Trace,`(WebSockets transport) sending data. ${al(a,this._logMessageContent)}.`),this._webSocket.send(a),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(a){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(g.Trace,"(WebSockets transport) socket closed."),this.onclose&&(this._isCloseEvent(a)&&(!1===a.wasClean||1e3!==a.code)?this.onclose(Error(`WebSocket closed with status code: ${a.code} (${a.reason||"no reason given"}).`)):a instanceof Error?this.onclose(a):this.onclose())}_isCloseEvent(a){return a&&"boolean"==typeof a.wasClean&&"number"==typeof a.code}}class aA{constructor(b,c={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,aj.isRequired(b,"url"),this._logger=function(a){return void 0===a?new ap(g.Information):null===a?ai.instance:void 0!==a.log?a:new ap(a)}(c.logger),this.baseUrl=this._resolveUrl(b),(c=c||{}).logMessageContent=void 0!==c.logMessageContent&&c.logMessageContent,"boolean"==typeof c.withCredentials||void 0===c.withCredentials)c.withCredentials=void 0===c.withCredentials||c.withCredentials;else throw Error("withCredentials option was not a 'boolean' or 'undefined' value");c.timeout=void 0===c.timeout?1e5:c.timeout;let d=null,e=null;if(ak.isNode&&1){const b="function"==typeof __webpack_require__?__non_webpack_require__:a.z;d=b("ws"),e=b("eventsource")}!ak.isNode&&"u">typeof WebSocket&&!c.WebSocket?c.WebSocket=WebSocket:ak.isNode&&!c.WebSocket&&d&&(c.WebSocket=d),!ak.isNode&&"u">typeof EventSource&&!c.EventSource?c.EventSource=EventSource:ak.isNode&&!c.EventSource&&void 0!==e&&(c.EventSource=e),this._httpClient=new _(c.httpClient||new av(this._logger),c.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=c,this.onreceive=null,this.onclose=null}async start(a){if(a=a||i.Binary,aj.isIn(a,i,"transferFormat"),this._logger.log(g.Debug,`Starting connection with transfer format '${i[a]}'.`),"Disconnected"!==this._connectionState)return Promise.reject(Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(a),await this._startInternalPromise,"Disconnecting"===this._connectionState){let a="Failed to start the HttpConnection before stop() was called.";return this._logger.log(g.Error,a),await this._stopPromise,Promise.reject(new ac(a))}if("Connected"!==this._connectionState){let a="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(g.Error,a),Promise.reject(new ac(a))}this._connectionStarted=!0}send(a){return"Connected"!==this._connectionState?Promise.reject(Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new aB(this.transport)),this._sendQueue.send(a))}async stop(a){return"Disconnected"===this._connectionState?(this._logger.log(g.Debug,`Call to HttpConnection.stop(${a}) ignored because the connection is already in the disconnected state.`),Promise.resolve()):"Disconnecting"===this._connectionState?(this._logger.log(g.Debug,`Call to HttpConnection.stop(${a}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):void(this._connectionState="Disconnecting",this._stopPromise=new Promise(a=>{this._stopPromiseResolver=a}),await this._stopInternal(a),await this._stopPromise)}async _stopInternal(a){this._stopError=a;try{await this._startInternalPromise}catch(a){}if(this.transport){try{await this.transport.stop()}catch(a){this._logger.log(g.Error,`HttpConnection.transport.stop() threw error '${a}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(g.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(a){let b=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation)if(this._options.transport===h.WebSockets)this.transport=this._constructTransport(h.WebSockets),await this._startTransport(b,a);else throw Error("Negotiation can only be skipped when using the WebSocket transport directly.");else{let c=null,d=0;do{if(c=await this._getNegotiationResponse(b),"Disconnecting"===this._connectionState||"Disconnected"===this._connectionState)throw new ac("The connection was stopped during negotiation.");if(c.error)throw Error(c.error);if(c.ProtocolVersion)throw Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(c.url&&(b=c.url),c.accessToken){let a=c.accessToken;this._accessTokenFactory=()=>a,this._httpClient._accessToken=a,this._httpClient._accessTokenFactory=void 0}d++}while(c.url&&d<100)if(100===d&&c.url)throw Error("Negotiate redirection limit exceeded.");await this._createTransport(b,this._options.transport,c,a)}this.transport instanceof ax&&(this.features.inherentKeepAlive=!0),"Connecting"===this._connectionState&&(this._logger.log(g.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(a){return this._logger.log(g.Error,"Failed to start the connection: "+a),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(a)}}async _getNegotiationResponse(a){let b={},[c,d]=aq();b[c]=d;let e=this._resolveNegotiateUrl(a);this._logger.log(g.Debug,`Sending negotiation request: ${e}.`);try{let a=await this._httpClient.post(e,{content:"",headers:{...b,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(200!==a.statusCode)return Promise.reject(Error(`Unexpected status code returned from negotiate '${a.statusCode}'`));let c=JSON.parse(a.content);if((!c.negotiateVersion||c.negotiateVersion<1)&&(c.connectionToken=c.connectionId),c.useStatefulReconnect&&!0!==this._options._useStatefulReconnect)return Promise.reject(new ag("Client didn't negotiate Stateful Reconnect but the server did."));return c}catch(b){let a="Failed to complete negotiation with the server: "+b;return b instanceof aa&&404===b.statusCode&&(a+=" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(g.Error,a),Promise.reject(new ag(a))}}_createConnectUrl(a,b){return b?a+(-1===a.indexOf("?")?"?":"&")+`id=${b}`:a}async _createTransport(a,b,c,d){let e=this._createConnectUrl(a,c.connectionToken);if(this._isITransport(b)){this._logger.log(g.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=b,await this._startTransport(e,d),this.connectionId=c.connectionId;return}let f=[],i=c.availableTransports||[],j=c;for(let c of i){let i=this._resolveTransportOrError(c,b,d,(null==j?void 0:j.useStatefulReconnect)===!0);if(i instanceof Error)f.push(`${c.transport} failed:`),f.push(i);else if(this._isITransport(i)){if(this.transport=i,!j){try{j=await this._getNegotiationResponse(a)}catch(a){return Promise.reject(a)}e=this._createConnectUrl(a,j.connectionToken)}try{await this._startTransport(e,d),this.connectionId=j.connectionId;return}catch(a){if(this._logger.log(g.Error,`Failed to start the transport '${c.transport}': ${a}`),j=void 0,f.push(new af(`${c.transport} failed: ${a}`,h[c.transport])),"Connecting"!==this._connectionState){let a="Failed to select transport before stop() was called.";return this._logger.log(g.Debug,a),Promise.reject(new ac(a))}}}}return f.length>0?Promise.reject(new ah(`Unable to connect to the server with any of the available transports. ${f.join(" ")}`,f)):Promise.reject(Error("None of the transports supported by the client are supported by the server."))}_constructTransport(a){switch(a){case h.WebSockets:if(!this._options.WebSocket)throw Error("'WebSocket' is not supported in your environment.");return new az(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case h.ServerSentEvents:if(!this._options.EventSource)throw Error("'EventSource' is not supported in your environment.");return new ay(this._httpClient,this._httpClient._accessToken,this._logger,this._options);case h.LongPolling:return new ax(this._httpClient,this._logger,this._options);default:throw Error(`Unknown transport: ${a}.`)}}_startTransport(a,b){return this.transport.onreceive=this.onreceive,this.features.reconnect?this.transport.onclose=async c=>{let d=!1;if(!this.features.reconnect)return void this._stopConnection(c);try{this.features.disconnected(),await this.transport.connect(a,b),await this.features.resend()}catch{d=!0}d&&this._stopConnection(c)}:this.transport.onclose=a=>this._stopConnection(a),this.transport.connect(a,b)}_resolveTransportOrError(a,b,c,d){var e,f;let j=h[a.transport];if(null==j)return this._logger.log(g.Debug,`Skipping transport '${a.transport}' because it is not supported by this client.`),Error(`Skipping transport '${a.transport}' because it is not supported by this client.`);if(e=b,f=j,e&&(f&e)==0)return this._logger.log(g.Debug,`Skipping transport '${h[j]}' because it was disabled by the client.`),new ae(`'${h[j]}' is disabled by the client.`,j);if(!(a.transferFormats.map(a=>i[a]).indexOf(c)>=0))return this._logger.log(g.Debug,`Skipping transport '${h[j]}' because it does not support the requested transfer format '${i[c]}'.`),Error(`'${h[j]}' does not support ${i[c]}.`);if(j===h.WebSockets&&!this._options.WebSocket||j===h.ServerSentEvents&&!this._options.EventSource)return this._logger.log(g.Debug,`Skipping transport '${h[j]}' because it is not supported in your environment.'`),new ad(`'${h[j]}' is not supported in your environment.`,j);this._logger.log(g.Debug,`Selecting transport '${h[j]}'.`);try{return this.features.reconnect=j===h.WebSockets?d:void 0,this._constructTransport(j)}catch(a){return a}}_isITransport(a){return a&&"object"==typeof a&&"connect"in a}_stopConnection(a){if(this._logger.log(g.Debug,`HttpConnection.stopConnection(${a}) called while in state ${this._connectionState}.`),this.transport=void 0,a=this._stopError||a,this._stopError=void 0,"Disconnected"===this._connectionState)return void this._logger.log(g.Debug,`Call to HttpConnection.stopConnection(${a}) was ignored because the connection is already in the disconnected state.`);if("Connecting"===this._connectionState)throw this._logger.log(g.Warning,`Call to HttpConnection.stopConnection(${a}) was ignored because the connection is still in the connecting state.`),Error(`HttpConnection.stopConnection(${a}) was called while the connection is still in the connecting state.`);if("Disconnecting"===this._connectionState&&this._stopPromiseResolver(),a?this._logger.log(g.Error,`Connection disconnected with error '${a}'.`):this._logger.log(g.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(a=>{this._logger.log(g.Error,`TransportSendQueue.stop() threw error '${a}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(a)}catch(b){this._logger.log(g.Error,`HttpConnection.onclose(${a}) threw error '${b}'.`)}}}_resolveUrl(a){if(0===a.lastIndexOf("https://",0)||0===a.lastIndexOf("http://",0))return a;if(!ak.isBrowser)throw Error(`Cannot resolve '${a}'.`);let b=window.document.createElement("a");return b.href=a,this._logger.log(g.Information,`Normalizing '${a}' to '${b.href}'.`),b.href}_resolveNegotiateUrl(a){let b=new URL(a);b.pathname.endsWith("/")?b.pathname+="negotiate":b.pathname+="/negotiate";let c=new URLSearchParams(b.searchParams);return c.has("negotiateVersion")||c.append("negotiateVersion",this._negotiateVersion.toString()),c.has("useStatefulReconnect")?"true"===c.get("useStatefulReconnect")&&(this._options._useStatefulReconnect=!0):!0===this._options._useStatefulReconnect&&c.append("useStatefulReconnect","true"),b.search=c.toString(),b.toString()}}class aB{constructor(a){this._transport=a,this._buffer=[],this._executing=!0,this._sendBufferedData=new aC,this._transportResult=new aC,this._sendLoopPromise=this._sendLoop()}send(a){return this._bufferData(a),this._transportResult||(this._transportResult=new aC),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(a){if(this._buffer.length&&typeof this._buffer[0]!=typeof a)throw Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof a}`);this._buffer.push(a),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new aC;let a=this._transportResult;this._transportResult=void 0;let b="string"==typeof this._buffer[0]?this._buffer.join(""):aB._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(b),a.resolve()}catch(b){a.reject(b)}}}static _concatBuffers(a){let b=new Uint8Array(a.map(a=>a.byteLength).reduce((a,b)=>a+b)),c=0;for(let d of a)b.set(new Uint8Array(d),c),c+=d.byteLength;return b.buffer}}class aC{constructor(){this.promise=new Promise((a,b)=>([this._resolver,this._rejecter]=[a,b]))}resolve(){this._resolver()}reject(a){this._rejecter(a)}}class aD{static write(a){return`${a}${aD.RecordSeparator}`}static parse(a){if(a[a.length-1]!==aD.RecordSeparator)throw Error("Message is incomplete.");let b=a.split(aD.RecordSeparator);return b.pop(),b}}aD.RecordSeparatorCode=30,aD.RecordSeparator=String.fromCharCode(aD.RecordSeparatorCode);class aE{writeHandshakeRequest(a){return aD.write(JSON.stringify(a))}parseHandshakeResponse(a){let b,c;if(am(a)){let d=new Uint8Array(a),e=d.indexOf(aD.RecordSeparatorCode);if(-1===e)throw Error("Message is incomplete.");let f=e+1;b=String.fromCharCode.apply(null,Array.prototype.slice.call(d.slice(0,f))),c=d.byteLength>f?d.slice(f).buffer:null}else{let d=a.indexOf(aD.RecordSeparator);if(-1===d)throw Error("Message is incomplete.");let e=d+1;b=a.substring(0,e),c=a.length>e?a.substring(e):null}let d=JSON.parse(aD.parse(b)[0]);if(d.type)throw Error("Expected a handshake response from the server.");return[c,d]}}(e=j||(j={}))[e.Invocation=1]="Invocation",e[e.StreamItem=2]="StreamItem",e[e.Completion=3]="Completion",e[e.StreamInvocation=4]="StreamInvocation",e[e.CancelInvocation=5]="CancelInvocation",e[e.Ping=6]="Ping",e[e.Close=7]="Close",e[e.Ack=8]="Ack",e[e.Sequence=9]="Sequence";class aF{constructor(){this.observers=[]}next(a){for(let b of this.observers)b.next(a)}error(a){for(let b of this.observers)b.error&&b.error(a)}complete(){for(let a of this.observers)a.complete&&a.complete()}subscribe(a){return this.observers.push(a),new ao(this,a)}}class aG{constructor(a,b,c){this._bufferSize=1e5,this._messages=[],this._totalMessageCount=0,this._waitForSequenceMessage=!1,this._nextReceivingSequenceId=1,this._latestReceivedSequenceId=0,this._bufferedByteCount=0,this._reconnectInProgress=!1,this._protocol=a,this._connection=b,this._bufferSize=c}async _send(a){let b=this._protocol.writeMessage(a),c=Promise.resolve();if(this._isInvocationMessage(a)){this._totalMessageCount++;let a=()=>{},d=()=>{};am(b)?this._bufferedByteCount+=b.byteLength:this._bufferedByteCount+=b.length,this._bufferedByteCount>=this._bufferSize&&(c=new Promise((b,c)=>{a=b,d=c})),this._messages.push(new aH(b,this._totalMessageCount,a,d))}try{this._reconnectInProgress||await this._connection.send(b)}catch{this._disconnected()}await c}_ack(a){let b=-1;for(let c=0;c<this._messages.length;c++){let d=this._messages[c];if(d._id<=a.sequenceId)b=c,am(d._message)?this._bufferedByteCount-=d._message.byteLength:this._bufferedByteCount-=d._message.length,d._resolver();else if(this._bufferedByteCount<this._bufferSize)d._resolver();else break}-1!==b&&(this._messages=this._messages.slice(b+1))}_shouldProcessMessage(a){if(this._waitForSequenceMessage)if(a.type!==j.Sequence)return!1;else return this._waitForSequenceMessage=!1,!0;if(!this._isInvocationMessage(a))return!0;let b=this._nextReceivingSequenceId;return(this._nextReceivingSequenceId++,b<=this._latestReceivedSequenceId)?(b===this._latestReceivedSequenceId&&this._ackTimer(),!1):(this._latestReceivedSequenceId=b,this._ackTimer(),!0)}_resetSequence(a){a.sequenceId>this._nextReceivingSequenceId?this._connection.stop(Error("Sequence ID greater than amount of messages we've received.")):this._nextReceivingSequenceId=a.sequenceId}_disconnected(){this._reconnectInProgress=!0,this._waitForSequenceMessage=!0}async _resend(){let a=0!==this._messages.length?this._messages[0]._id:this._totalMessageCount+1;for(let b of(await this._connection.send(this._protocol.writeMessage({type:j.Sequence,sequenceId:a})),this._messages))await this._connection.send(b._message);this._reconnectInProgress=!1}_dispose(a){for(let b of(null!=a||(a=Error("Unable to reconnect to server.")),this._messages))b._rejector(a)}_isInvocationMessage(a){switch(a.type){case j.Invocation:case j.StreamItem:case j.Completion:case j.StreamInvocation:case j.CancelInvocation:return!0;case j.Close:case j.Sequence:case j.Ping:case j.Ack:return!1}}_ackTimer(){void 0===this._ackTimerHandle&&(this._ackTimerHandle=setTimeout(async()=>{try{this._reconnectInProgress||await this._connection.send(this._protocol.writeMessage({type:j.Ack,sequenceId:this._latestReceivedSequenceId}))}catch{}clearTimeout(this._ackTimerHandle),this._ackTimerHandle=void 0},1e3))}}class aH{constructor(a,b,c,d){this._message=a,this._id=b,this._resolver=c,this._rejector=d}}(f=k||(k={})).Disconnected="Disconnected",f.Connecting="Connecting",f.Connected="Connected",f.Disconnecting="Disconnecting",f.Reconnecting="Reconnecting";class aI{static create(a,b,c,d,e,f,g){return new aI(a,b,c,d,e,f,g)}constructor(a,b,c,d,e,f,h){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(g.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://learn.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},aj.isRequired(a,"connection"),aj.isRequired(b,"logger"),aj.isRequired(c,"protocol"),this.serverTimeoutInMilliseconds=null!=e?e:3e4,this.keepAliveIntervalInMilliseconds=null!=f?f:15e3,this._statefulReconnectBufferSize=null!=h?h:1e5,this._logger=b,this._protocol=c,this.connection=a,this._reconnectPolicy=d,this._handshakeProtocol=new aE,this.connection.onreceive=a=>this._processIncomingData(a),this.connection.onclose=a=>this._connectionClosed(a),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=k.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:j.Ping})}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(a){if(this._connectionState!==k.Disconnected&&this._connectionState!==k.Reconnecting)throw Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!a)throw Error("The HubConnection url must be a valid url.");this.connection.baseUrl=a}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==k.Disconnected)return Promise.reject(Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=k.Connecting,this._logger.log(g.Debug,"Starting HubConnection.");try{await this._startInternal(),ak.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=k.Connected,this._connectionStarted=!0,this._logger.log(g.Debug,"HubConnection connected successfully.")}catch(a){return this._connectionState=k.Disconnected,this._logger.log(g.Debug,`HubConnection failed to start successfully because of error '${a}'.`),Promise.reject(a)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;let a=new Promise((a,b)=>{this._handshakeResolver=a,this._handshakeRejecter=b});await this.connection.start(this._protocol.transferFormat);try{let b=this._protocol.version;this.connection.features.reconnect||(b=1);let c={protocol:this._protocol.name,version:b};if(this._logger.log(g.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(c)),this._logger.log(g.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await a,this._stopDuringStartError)throw this._stopDuringStartError;(this.connection.features.reconnect||0)&&(this._messageBuffer=new aG(this._protocol,this.connection,this._statefulReconnectBufferSize),this.connection.features.disconnected=this._messageBuffer._disconnected.bind(this._messageBuffer),this.connection.features.resend=()=>{if(this._messageBuffer)return this._messageBuffer._resend()}),this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(a){throw this._logger.log(g.Debug,`Hub handshake failed with error '${a}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(a),a}}async stop(){let a=this._startPromise;this.connection.features.reconnect=!1,this._stopPromise=this._stopInternal(),await this._stopPromise;try{await a}catch(a){}}_stopInternal(a){if(this._connectionState===k.Disconnected)return this._logger.log(g.Debug,`Call to HubConnection.stop(${a}) ignored because it is already in the disconnected state.`),Promise.resolve();if(this._connectionState===k.Disconnecting)return this._logger.log(g.Debug,`Call to HttpConnection.stop(${a}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;let b=this._connectionState;return(this._connectionState=k.Disconnecting,this._logger.log(g.Debug,"Stopping HubConnection."),this._reconnectDelayHandle)?(this._logger.log(g.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(b===k.Connected&&this._sendCloseMessage(),this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=a||new ac("The connection was stopped before the hub handshake could complete."),this.connection.stop(a))}async _sendCloseMessage(){try{await this._sendWithProtocol(this._createCloseMessage())}catch{}}stream(a,...b){let c,[d,e]=this._replaceStreamingParams(b),f=this._createStreamInvocation(a,b,e),g=new aF;return g.cancelCallback=()=>{let a=this._createCancelInvocation(f.invocationId);return delete this._callbacks[f.invocationId],c.then(()=>this._sendWithProtocol(a))},this._callbacks[f.invocationId]=(a,b)=>{b?g.error(b):a&&(a.type===j.Completion?a.error?g.error(Error(a.error)):g.complete():g.next(a.item))},c=this._sendWithProtocol(f).catch(a=>{g.error(a),delete this._callbacks[f.invocationId]}),this._launchStreams(d,c),g}_sendMessage(a){return this._resetKeepAliveInterval(),this.connection.send(a)}_sendWithProtocol(a){return this._messageBuffer?this._messageBuffer._send(a):this._sendMessage(this._protocol.writeMessage(a))}send(a,...b){let[c,d]=this._replaceStreamingParams(b),e=this._sendWithProtocol(this._createInvocation(a,b,!0,d));return this._launchStreams(c,e),e}invoke(a,...b){let[c,d]=this._replaceStreamingParams(b),e=this._createInvocation(a,b,!1,d);return new Promise((a,b)=>{this._callbacks[e.invocationId]=(c,d)=>{d?b(d):c&&(c.type===j.Completion?c.error?b(Error(c.error)):a(c.result):b(Error(`Unexpected message type: ${c.type}`)))};let d=this._sendWithProtocol(e).catch(a=>{b(a),delete this._callbacks[e.invocationId]});this._launchStreams(c,d)})}on(a,b){a&&b&&(a=a.toLowerCase(),this._methods[a]||(this._methods[a]=[]),-1===this._methods[a].indexOf(b)&&this._methods[a].push(b))}off(a,b){if(!a)return;a=a.toLowerCase();let c=this._methods[a];if(c)if(b){let d=c.indexOf(b);-1!==d&&(c.splice(d,1),0===c.length&&delete this._methods[a])}else delete this._methods[a]}onclose(a){a&&this._closedCallbacks.push(a)}onreconnecting(a){a&&this._reconnectingCallbacks.push(a)}onreconnected(a){a&&this._reconnectedCallbacks.push(a)}_processIncomingData(a){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(a=this._processHandshakeResponse(a),this._receivedHandshakeResponse=!0),a){for(let b of this._protocol.parseMessages(a,this._logger))if(!this._messageBuffer||this._messageBuffer._shouldProcessMessage(b))switch(b.type){case j.Invocation:this._invokeClientMethod(b).catch(a=>{this._logger.log(g.Error,`Invoke client method threw error: ${ar(a)}`)});break;case j.StreamItem:case j.Completion:{let a=this._callbacks[b.invocationId];if(a){b.type===j.Completion&&delete this._callbacks[b.invocationId];try{a(b)}catch(a){this._logger.log(g.Error,`Stream callback threw error: ${ar(a)}`)}}break}case j.Ping:break;case j.Close:{this._logger.log(g.Information,"Close message received from server.");let a=b.error?Error("Server returned an error on close: "+b.error):void 0;!0===b.allowReconnect?this.connection.stop(a):this._stopPromise=this._stopInternal(a);break}case j.Ack:this._messageBuffer&&this._messageBuffer._ack(b);break;case j.Sequence:this._messageBuffer&&this._messageBuffer._resetSequence(b);break;default:this._logger.log(g.Warning,`Invalid message type: ${b.type}.`)}}this._resetTimeoutPeriod()}_processHandshakeResponse(a){let b,c;try{[c,b]=this._handshakeProtocol.parseHandshakeResponse(a)}catch(c){let a="Error parsing handshake response: "+c;this._logger.log(g.Error,a);let b=Error(a);throw this._handshakeRejecter(b),b}if(b.error){let a="Server returned handshake error: "+b.error;this._logger.log(g.Error,a);let c=Error(a);throw this._handshakeRejecter(c),c}return this._logger.log(g.Debug,"Server handshake complete."),this._handshakeResolver(),c}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=new Date().getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if((!this.connection.features||!this.connection.features.inherentKeepAlive)&&(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),void 0===this._pingServerHandle)){let a=this._nextKeepAlive-new Date().getTime();a<0&&(a=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===k.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},a)}}serverTimeout(){this.connection.stop(Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(a){let b,c,d,e=a.target.toLowerCase(),f=this._methods[e];if(!f){this._logger.log(g.Warning,`No client method with the name '${e}' found.`),a.invocationId&&(this._logger.log(g.Warning,`No result given for '${e}' method and invocation ID '${a.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(a.invocationId,"Client didn't provide a result.",null)));return}let h=f.slice(),i=!!a.invocationId;for(let f of h)try{let h=b;b=await f.apply(this,a.arguments),i&&b&&h&&(this._logger.log(g.Error,`Multiple results provided for '${e}'. Sending error to server.`),d=this._createCompletionMessage(a.invocationId,"Client provided multiple results.",null)),c=void 0}catch(a){c=a,this._logger.log(g.Error,`A callback for the method '${e}' threw error '${a}'.`)}d?await this._sendWithProtocol(d):i?(c?d=this._createCompletionMessage(a.invocationId,`${c}`,null):void 0!==b?d=this._createCompletionMessage(a.invocationId,null,b):(this._logger.log(g.Warning,`No result given for '${e}' method and invocation ID '${a.invocationId}'.`),d=this._createCompletionMessage(a.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(d)):b&&this._logger.log(g.Error,`Result given for '${e}' method but server is not expecting a result.`)}_connectionClosed(a){this._logger.log(g.Debug,`HubConnection.connectionClosed(${a}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||a||new ac("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(a||Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===k.Disconnecting?this._completeClose(a):this._connectionState===k.Connected&&this._reconnectPolicy?this._reconnect(a):this._connectionState===k.Connected&&this._completeClose(a)}_completeClose(a){if(this._connectionStarted){this._connectionState=k.Disconnected,this._connectionStarted=!1,this._messageBuffer&&(this._messageBuffer._dispose(null!=a?a:Error("Connection closed.")),this._messageBuffer=void 0),ak.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(b=>b.apply(this,[a]))}catch(b){this._logger.log(g.Error,`An onclose callback called with error '${a}' threw error '${b}'.`)}}}async _reconnect(a){let b=Date.now(),c=0,d=void 0!==a?a:Error("Attempting to reconnect due to a unknown error."),e=this._getNextRetryDelay(c++,0,d);if(null===e){this._logger.log(g.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(a);return}if(this._connectionState=k.Reconnecting,a?this._logger.log(g.Information,`Connection reconnecting because of error '${a}'.`):this._logger.log(g.Information,"Connection reconnecting."),0!==this._reconnectingCallbacks.length){try{this._reconnectingCallbacks.forEach(b=>b.apply(this,[a]))}catch(b){this._logger.log(g.Error,`An onreconnecting callback called with error '${a}' threw error '${b}'.`)}if(this._connectionState!==k.Reconnecting)return void this._logger.log(g.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.")}for(;null!==e;){if(this._logger.log(g.Information,`Reconnect attempt number ${c} will start in ${e} ms.`),await new Promise(a=>{this._reconnectDelayHandle=setTimeout(a,e)}),this._reconnectDelayHandle=void 0,this._connectionState!==k.Reconnecting)return void this._logger.log(g.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");try{if(await this._startInternal(),this._connectionState=k.Connected,this._logger.log(g.Information,"HubConnection reconnected successfully."),0!==this._reconnectedCallbacks.length)try{this._reconnectedCallbacks.forEach(a=>a.apply(this,[this.connection.connectionId]))}catch(a){this._logger.log(g.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${a}'.`)}return}catch(a){if(this._logger.log(g.Information,`Reconnect attempt failed because of error '${a}'.`),this._connectionState!==k.Reconnecting){this._logger.log(g.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),this._connectionState===k.Disconnecting&&this._completeClose();return}d=a instanceof Error?a:Error(a.toString()),e=this._getNextRetryDelay(c++,Date.now()-b,d)}}this._logger.log(g.Information,`Reconnect retries have been exhausted after ${Date.now()-b} ms and ${c} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(a,b,c){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:b,previousRetryCount:a,retryReason:c})}catch(c){return this._logger.log(g.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${a}, ${b}) threw error '${c}'.`),null}}_cancelCallbacksWithError(a){let b=this._callbacks;this._callbacks={},Object.keys(b).forEach(c=>{let d=b[c];try{d(null,a)}catch(b){this._logger.log(g.Error,`Stream 'error' callback called with '${a}' threw error: ${ar(b)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(a,b,c,d){if(c)if(0!==d.length)return{arguments:b,streamIds:d,target:a,type:j.Invocation};else return{arguments:b,target:a,type:j.Invocation};{let c=this._invocationId;return(this._invocationId++,0!==d.length)?{arguments:b,invocationId:c.toString(),streamIds:d,target:a,type:j.Invocation}:{arguments:b,invocationId:c.toString(),target:a,type:j.Invocation}}}_launchStreams(a,b){if(0!==a.length)for(let c in b||(b=Promise.resolve()),a)a[c].subscribe({complete:()=>{b=b.then(()=>this._sendWithProtocol(this._createCompletionMessage(c)))},error:a=>{let d;d=a instanceof Error?a.message:a&&a.toString?a.toString():"Unknown error",b=b.then(()=>this._sendWithProtocol(this._createCompletionMessage(c,d)))},next:a=>{b=b.then(()=>this._sendWithProtocol(this._createStreamItemMessage(c,a)))}})}_replaceStreamingParams(a){let b=[],c=[];for(let d=0;d<a.length;d++){let e=a[d];if(this._isObservable(e)){let f=this._invocationId;this._invocationId++,b[f]=e,c.push(f.toString()),a.splice(d,1)}}return[b,c]}_isObservable(a){return a&&a.subscribe&&"function"==typeof a.subscribe}_createStreamInvocation(a,b,c){let d=this._invocationId;return(this._invocationId++,0!==c.length)?{arguments:b,invocationId:d.toString(),streamIds:c,target:a,type:j.StreamInvocation}:{arguments:b,invocationId:d.toString(),target:a,type:j.StreamInvocation}}_createCancelInvocation(a){return{invocationId:a,type:j.CancelInvocation}}_createStreamItemMessage(a,b){return{invocationId:a,item:b,type:j.StreamItem}}_createCompletionMessage(a,b,c){return b?{error:b,invocationId:a,type:j.Completion}:{invocationId:a,result:c,type:j.Completion}}_createCloseMessage(){return{type:j.Close}}}class aJ{constructor(){this.name="json",this.version=2,this.transferFormat=i.Text}parseMessages(a,b){if("string"!=typeof a)throw Error("Invalid input for JSON hub protocol. Expected a string.");if(!a)return[];null===b&&(b=ai.instance);let c=aD.parse(a),d=[];for(let a of c){let c=JSON.parse(a);if("number"!=typeof c.type)throw Error("Invalid payload.");switch(c.type){case j.Invocation:this._isInvocationMessage(c);break;case j.StreamItem:this._isStreamItemMessage(c);break;case j.Completion:this._isCompletionMessage(c);break;case j.Ping:case j.Close:break;case j.Ack:this._isAckMessage(c);break;case j.Sequence:this._isSequenceMessage(c);break;default:b.log(g.Information,"Unknown message type '"+c.type+"' ignored.");continue}d.push(c)}return d}writeMessage(a){return aD.write(JSON.stringify(a))}_isInvocationMessage(a){this._assertNotEmptyString(a.target,"Invalid payload for Invocation message."),void 0!==a.invocationId&&this._assertNotEmptyString(a.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(a){if(this._assertNotEmptyString(a.invocationId,"Invalid payload for StreamItem message."),void 0===a.item)throw Error("Invalid payload for StreamItem message.")}_isCompletionMessage(a){if(a.result&&a.error)throw Error("Invalid payload for Completion message.");!a.result&&a.error&&this._assertNotEmptyString(a.error,"Invalid payload for Completion message."),this._assertNotEmptyString(a.invocationId,"Invalid payload for Completion message.")}_isAckMessage(a){if("number"!=typeof a.sequenceId)throw Error("Invalid SequenceId for Ack message.")}_isSequenceMessage(a){if("number"!=typeof a.sequenceId)throw Error("Invalid SequenceId for Sequence message.")}_assertNotEmptyString(a,b){if("string"!=typeof a||""===a)throw Error(b)}}let aK={trace:g.Trace,debug:g.Debug,info:g.Information,information:g.Information,warn:g.Warning,warning:g.Warning,error:g.Error,critical:g.Critical,none:g.None};class aL{configureLogging(a){if(aj.isRequired(a,"logging"),void 0!==a.log)this.logger=a;else if("string"==typeof a){let b=function(a){let b=aK[a.toLowerCase()];if(void 0!==b)return b;throw Error(`Unknown log level: ${a}`)}(a);this.logger=new ap(b)}else this.logger=new ap(a);return this}withUrl(a,b){return aj.isRequired(a,"url"),aj.isNotEmpty(a,"url"),this.url=a,"object"==typeof b?this.httpConnectionOptions={...this.httpConnectionOptions,...b}:this.httpConnectionOptions={...this.httpConnectionOptions,transport:b},this}withHubProtocol(a){return aj.isRequired(a,"protocol"),this.protocol=a,this}withAutomaticReconnect(a){if(this.reconnectPolicy)throw Error("A reconnectPolicy has already been set.");return a?Array.isArray(a)?this.reconnectPolicy=new X(a):this.reconnectPolicy=a:this.reconnectPolicy=new X,this}withServerTimeout(a){return aj.isRequired(a,"milliseconds"),this._serverTimeoutInMilliseconds=a,this}withKeepAliveInterval(a){return aj.isRequired(a,"milliseconds"),this._keepAliveIntervalInMilliseconds=a,this}withStatefulReconnect(a){return void 0===this.httpConnectionOptions&&(this.httpConnectionOptions={}),this.httpConnectionOptions._useStatefulReconnect=!0,this._statefulReconnectBufferSize=null==a?void 0:a.bufferSize,this}build(){let a=this.httpConnectionOptions||{};if(void 0===a.logger&&(a.logger=this.logger),!this.url)throw Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");let b=new aA(this.url,a);return aI.create(b,this.logger||ai.instance,this.protocol||new aJ,this.reconnectPolicy,this._serverTimeoutInMilliseconds,this._keepAliveIntervalInMilliseconds,this._statefulReconnectBufferSize)}}let aM=["events.updated","agents.list.updated","agent.status.changed","agent.message","agent.progress","agent.thought","agent.error"],aN={chat:{label:"ЧАТ",color:"#4ade80"},action:{label:"ДЕЙСТВИЕ",color:"#e5c34b"},emotion:{label:"ЭМОЦИЯ",color:"#c084fc"},system:{label:"СИСТЕМА",color:"#60a5fa"}};function aO({refreshToken:a}){let[b,c]=(0,m.useState)([]),[d,e]=(0,m.useState)([]),[f,h]=(0,m.useState)(!0);return(0,m.useEffect)(()=>{let a=!0,b=null,d=async({silent:b=!1}={})=>{b||h(!0);try{let[b,d]=await Promise.all([M(),L()]);if(!a)return;c(b),e(d)}finally{a&&!b&&h(!1)}},f=()=>{a&&d({silent:!0})},i=async()=>{let c,e,h=(c=process.env.NEXT_PUBLIC_BACKEND_URL?.trim())&&c.length>0?c.replace(/\/+$/,""):"http://localhost:5133",i=(e=process.env.NEXT_PUBLIC_USER_ID?.trim())&&e.length>0?e:"demo-user",j=`${h}/hubs/agents?userId=${encodeURIComponent(i)}`;for(let a of(b=new aL().withUrl(j).withAutomaticReconnect().configureLogging(g.Error).build(),aM))b.on(a,f);b.onreconnected(()=>{a&&(b?.invoke("SubscribeUser").catch(()=>void 0),d({silent:!0}))});try{if(await b.start(),!a)return;await b.invoke("SubscribeUser")}catch(a){console.warn("[events-panel] SignalR connection failed, fallback to polling",a)}};d(),i();let j=setInterval(()=>{d({silent:!0})},5e3);return()=>{if(a=!1,clearInterval(j),b){for(let a of aM)b.off(a,f);b.stop()}}},[a]),(0,l.jsxs)("div",{className:"flex h-full w-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,l.jsxs)("aside",{className:"shrink-0 flex flex-col gap-3 overflow-y-auto border-r py-4 px-3",style:{borderColor:"rgba(229,195,75,0.15)",width:"clamp(160px, 15%, 220px)"},children:[(0,l.jsx)("span",{className:"font-mono text-[10px] tracking-widest uppercase px-1",style:{color:"var(--muted-foreground)"},children:"АГЕНТЫ ОНЛАЙН"}),d.map(a=>{let b=p[a.mood];return(0,l.jsxs)("div",{className:"flex items-center gap-2 px-2 py-2 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.04)"},children:[(0,l.jsx)("div",{className:"shrink-0 flex items-center justify-center font-mono text-xs font-bold rounded-sm",style:{width:32,height:32,backgroundColor:"rgba(229,195,75,0.1)",color:b.color,border:`1px solid ${b.color}`},children:a.avatar}),(0,l.jsxs)("div",{className:"min-w-0",children:[(0,l.jsx)("div",{className:"font-mono text-xs truncate",style:{color:"var(--foreground)"},children:a.name}),(0,l.jsx)("div",{className:"font-mono text-[10px]",style:{color:b.color},children:b.label})]})]},a.id)})]}),(0,l.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,l.jsxs)("div",{className:"shrink-0 flex items-center justify-between px-4 py-2 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,l.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"ЛЕНТА СОБЫТИЙ"}),(0,l.jsxs)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:[b.length," ","событий"]})]}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 flex flex-col gap-1.5",children:[f&&(0,l.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Загрузка событий..."}),!f&&0===b.length&&(0,l.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Событий пока нет"}),b.map(a=>{let b=aN[a.type];return(0,l.jsxs)("div",{className:"group flex items-start gap-3 px-3 py-2.5 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.02)",borderLeft:`2px solid ${b.color}`,transition:"background-color 0.15s ease"},onMouseEnter:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.06)"},onMouseLeave:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.02)"},children:[(0,l.jsx)("span",{className:"shrink-0 font-mono text-[11px] tabular-nums pt-0.5",style:{color:"var(--muted-foreground)",width:"64px"},children:new Date(a.timestamp).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}),(0,l.jsx)("span",{className:"shrink-0 font-mono text-[9px] tracking-wider uppercase px-1.5 py-0.5 rounded-sm mt-0.5",style:{color:b.color,backgroundColor:`${b.color}15`,border:`1px solid ${b.color}30`},children:b.label}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsx)("span",{className:"font-mono text-xs font-bold mr-2",style:{color:"var(--cyber-glow)"},children:a.agentName}),(0,l.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.85},children:a.text})]})]},a.id)})]})]})]})}function aP({agent:a,onBack:b,fromGraph:c,allAgents:d,allEvents:e,allRelationships:f,onDelete:g,deleting:h,deleteError:i}){let j=p[a.mood],k=e.filter(b=>b.agentId===a.id),m=f.filter(b=>b.from===a.id||b.to===a.id);return(0,l.jsxs)("div",{className:"flex flex-col h-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,l.jsxs)("div",{className:"shrink-0 flex items-center gap-3 px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,l.jsx)("button",{onClick:b,className:"font-mono text-xs tracking-wider uppercase cursor-pointer",style:{color:"var(--cyber-glow)",padding:"4px 10px",border:"1px solid rgba(229,195,75,0.25)",backgroundColor:"rgba(229,195,75,0.05)",transition:"all 0.2s ease"},onMouseEnter:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.15)",a.currentTarget.style.borderColor="rgba(229,195,75,0.5)"},onMouseLeave:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.05)",a.currentTarget.style.borderColor="rgba(229,195,75,0.25)"},children:c?"<- К ГРАФУ":"<- НАЗАД"}),(0,l.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"ДОСЬЕ АГЕНТА"}),(0,l.jsx)("button",{onClick:()=>g(a.id),disabled:h,className:"ml-auto font-mono text-xs tracking-wider uppercase cursor-pointer disabled:cursor-not-allowed",style:{color:h?"var(--muted-foreground)":"#f87171",padding:"4px 10px",border:"1px solid rgba(248,113,113,0.35)",backgroundColor:h?"rgba(248,113,113,0.05)":"rgba(248,113,113,0.1)",transition:"all 0.2s ease"},children:h?"УДАЛЕНИЕ...":"УДАЛИТЬ АГЕНТА"})]}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-5",children:[(0,l.jsxs)("div",{className:"flex items-start gap-4",children:[(0,l.jsx)("div",{className:"shrink-0 flex items-center justify-center font-mono text-2xl font-bold rounded-sm",style:{width:64,height:64,backgroundColor:"rgba(229,195,75,0.1)",color:j.color,border:`2px solid ${j.color}`,boxShadow:`0 0 12px ${j.color}30`},children:a.avatar}),(0,l.jsxs)("div",{className:"flex flex-col gap-1 min-w-0",children:[(0,l.jsx)("h2",{className:"font-mono text-lg uppercase tracking-wider",style:{color:"var(--foreground)"},children:a.name}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("div",{className:"h-2 w-2 rounded-full",style:{backgroundColor:j.color}}),(0,l.jsx)("span",{className:"font-mono text-xs",style:{color:j.color},children:j.label})]}),(0,l.jsx)("p",{className:"font-mono text-xs mt-1",style:{color:"var(--muted-foreground)"},children:a.description})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ЧЕРТЫ ХАРАКТЕРА"}),(0,l.jsx)("div",{className:"flex flex-wrap gap-1.5",children:a.traits.map(a=>(0,l.jsx)("span",{className:"font-mono text-[11px] px-2 py-0.5 rounded-sm",style:{color:"var(--cyber-glow)",backgroundColor:"rgba(229,195,75,0.08)",border:"1px solid rgba(229,195,75,0.2)"},children:a},a))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ТЕКУЩИЙ ПЛАН"}),(0,l.jsx)("p",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.9},children:a.currentPlan})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ОТНОШЕНИЯ"}),(0,l.jsx)("div",{className:"flex flex-col gap-1.5",children:m.map((b,c)=>{let e=b.from===a.id?b.to:b.from,f=d.find(a=>a.id===e),g=b.sentiment>0?"#4ade80":b.sentiment<0?"#f87171":"#a0a0b0";return(0,l.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.03)",borderLeft:`2px solid ${g}`},children:[(0,l.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)"},children:f?.name||e}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:b.label}),(0,l.jsxs)("span",{className:"font-mono text-xs font-bold",style:{color:g},children:[b.sentiment>0?"+":"",(100*b.sentiment).toFixed(0),"%"]})]})]},c)})})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ВОСПОМИНАНИЯ"}),(0,l.jsx)("div",{className:"flex flex-col gap-1",children:a.memories.map((a,b)=>(0,l.jsxs)("div",{className:"flex items-start gap-2 py-1",children:[(0,l.jsx)("div",{className:"shrink-0 mt-1.5 h-1 w-1 rounded-full",style:{backgroundColor:"var(--cyber-glow)",opacity:.5}}),(0,l.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.8},children:a})]},b))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ПОСЛЕДНИЕ СОБЫТИЯ"}),(0,l.jsx)("div",{className:"flex flex-col gap-1",children:k.map(a=>(0,l.jsxs)("div",{className:"flex items-start gap-2 py-1.5 px-2 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.02)"},children:[(0,l.jsx)("span",{className:"shrink-0 font-mono text-[10px] tabular-nums",style:{color:"var(--muted-foreground)",width:56},children:new Date(a.timestamp).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}),(0,l.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.8},children:a.text})]},a.id))})]}),i?(0,l.jsx)("div",{className:"font-mono text-[11px]",style:{color:"#f87171"},children:i}):null]})]})}function aQ({preSelectedAgentId:a,onClearSelection:b,fromGraph:c,refreshToken:d}){let[e,f]=(0,m.useState)(a??null),[g,h]=(0,m.useState)([]),[i,j]=(0,m.useState)([]),[k,n]=(0,m.useState)([]),[o,q]=(0,m.useState)(!0),[r,s]=(0,m.useState)(""),[t,u]=(0,m.useState)(null),[v,w]=(0,m.useState)(!1),[x,y]=(0,m.useState)(!1),[z,A]=(0,m.useState)(null),B=async()=>{let[a,b,c]=await Promise.all([L(),M(),N()]);h(a),j(b),n(c)};(0,m.useEffect)(()=>{let a=!0;return q(!0),Promise.all([L(),M(),N()]).then(([b,c,d])=>{a&&(h(b),j(c),n(d))}).finally(()=>{a&&q(!1)}),()=>{a=!1}},[d]);let C=async()=>{let a=r.trim();if(a&&!v){w(!0),u(null);try{let b=await J(a);if(!b)return void u("Не удалось сгенерировать агента. Проверь backend и OPENAI_API_KEY.");await B(),s(""),f(b.id)}finally{w(!1)}}},D=async a=>{if(x)return;let c=g.find(b=>b.id===a)?.name??a;if(window.confirm(`Удалить агента "${c}"?`)){y(!0),A(null);try{if(!await K(a))return void A("Не удалось удалить агента. Проверь backend и попробуй снова.");await B(),f(null),b?.()}finally{y(!1)}}},E=(0,m.useRef)(a);a&&a!==E.current&&(E.current=a,e!==a&&f(a));let F=g.find(a=>a.id===e);return F?(0,l.jsx)(aP,{agent:F,allAgents:g,allEvents:i,allRelationships:k,onDelete:D,deleting:x,deleteError:z,onBack:()=>{f(null),b?.()},fromGraph:c}):o?(0,l.jsx)("div",{className:"flex h-full items-center justify-center font-mono text-xs",style:{backgroundColor:"var(--cyber-surface)",color:"var(--muted-foreground)"},children:"Загрузка агентов..."}):(0,l.jsxs)("div",{className:"flex flex-col h-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,l.jsxs)("div",{className:"shrink-0 flex items-center justify-between px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,l.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"СПИСОК АГЕНТОВ"}),(0,l.jsxs)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:[g.length," ","агентов"]})]}),(0,l.jsxs)("div",{className:"px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.12)"},children:[(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("input",{type:"text",value:r,onChange:a=>s(a.target.value),placeholder:"Опиши агента для ИИ...",className:"flex-1 font-mono text-xs px-3 py-2 rounded-sm outline-none",style:{backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.2)",color:"var(--foreground)"},disabled:v}),(0,l.jsx)("button",{onClick:C,disabled:v||0===r.trim().length,className:"font-mono text-xs tracking-wider uppercase px-3 py-2 rounded-sm cursor-pointer disabled:cursor-not-allowed",style:{color:v?"var(--muted-foreground)":"var(--cyber-glow)",backgroundColor:v?"rgba(229,195,75,0.02)":"rgba(229,195,75,0.08)",border:"1px solid rgba(229,195,75,0.25)"},children:v?"ГЕНЕРАЦИЯ...":"СОЗДАТЬ ИИ"})]}),t?(0,l.jsx)("p",{className:"mt-2 font-mono text-[10px]",style:{color:"#f87171"},children:t}):null]}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto px-5 py-4 grid grid-cols-1 md:grid-cols-2 gap-3 auto-rows-min",children:[0===g.length?(0,l.jsx)("div",{className:"col-span-full flex items-center justify-center font-mono text-xs py-8",style:{color:"var(--muted-foreground)"},children:'Агентов пока нет. Опиши первого и нажми "СОЗДАТЬ ИИ".'}):null,g.map(a=>{let b=p[a.mood];return(0,l.jsxs)("button",{onClick:()=>f(a.id),className:"text-left p-4 rounded-sm cursor-pointer flex items-start gap-3",style:{backgroundColor:"rgba(229,195,75,0.03)",border:"1px solid rgba(229,195,75,0.1)",transition:"all 0.2s ease"},onMouseEnter:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.08)",a.currentTarget.style.borderColor="rgba(229,195,75,0.3)",a.currentTarget.style.boxShadow="0 0 12px rgba(229,195,75,0.06)"},onMouseLeave:a=>{a.currentTarget.style.backgroundColor="rgba(229,195,75,0.03)",a.currentTarget.style.borderColor="rgba(229,195,75,0.1)",a.currentTarget.style.boxShadow="none"},children:[(0,l.jsx)("div",{className:"shrink-0 flex items-center justify-center font-mono text-lg font-bold rounded-sm",style:{width:48,height:48,backgroundColor:"rgba(229,195,75,0.08)",color:b.color,border:`1px solid ${b.color}`},children:a.avatar}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"font-mono text-sm uppercase",style:{color:"var(--foreground)"},children:a.name}),(0,l.jsxs)("div",{className:"flex items-center gap-1",children:[(0,l.jsx)("div",{className:"h-1.5 w-1.5 rounded-full",style:{backgroundColor:b.color}}),(0,l.jsx)("span",{className:"font-mono text-[10px]",style:{color:b.color},children:b.label})]})]}),(0,l.jsx)("p",{className:"font-mono text-[11px] mt-1 line-clamp-2",style:{color:"var(--muted-foreground)"},children:a.description}),(0,l.jsx)("div",{className:"flex flex-wrap gap-1 mt-2",children:a.traits.map(a=>(0,l.jsx)("span",{className:"font-mono text-[9px] px-1.5 py-0.5 rounded-sm",style:{color:"var(--cyber-glow)",backgroundColor:"rgba(229,195,75,0.06)",border:"1px solid rgba(229,195,75,0.15)"},children:a},a))})]})]},a.id)})]})]})}function aR({label:a,value:b,sub:c}){return(0,l.jsxs)("div",{className:"flex flex-col gap-1 p-4 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.03)",border:"1px solid rgba(229,195,75,0.1)"},children:[(0,l.jsx)("span",{className:"font-mono text-[10px] tracking-widest uppercase",style:{color:"var(--muted-foreground)"},children:a}),(0,l.jsx)("span",{className:"font-mono text-2xl tabular-nums",style:{color:"var(--cyber-glow)",textShadow:"0 0 10px rgba(229,195,75,0.3)"},children:b}),c&&(0,l.jsx)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:c})]})}function aS({items:a,maxVal:b}){return(0,l.jsx)("div",{className:"flex flex-col gap-2",children:a.map(a=>(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsx)("span",{className:"font-mono text-[10px] tracking-wider uppercase shrink-0",style:{color:"var(--muted-foreground)",width:80},children:a.label}),(0,l.jsx)("div",{className:"flex-1 h-5 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.06)"},children:(0,l.jsx)("div",{className:"h-full rounded-sm",style:{width:`${Math.max(a.value/b*100,2)}%`,backgroundColor:a.color,opacity:.7,boxShadow:`0 0 8px ${a.color}40`,transition:"width 0.5s ease"}})}),(0,l.jsx)("span",{className:"font-mono text-xs tabular-nums shrink-0",style:{color:a.color,width:36,textAlign:"right"},children:a.value})]},a.label))})}function aT({refreshToken:a}){let[b,c]=(0,m.useState)(null);if((0,m.useEffect)(()=>{let a=!0;return c(null),O().then(b=>{a&&c(b)}),()=>{a=!1}},[a]),!b)return(0,l.jsx)("div",{className:"flex h-full items-center justify-center font-mono text-xs",style:{backgroundColor:"var(--cyber-surface)",color:"var(--muted-foreground)"},children:"Загрузка статистики..."});let d={chat:"#4ade80",action:"#e5c34b",emotion:"#c084fc",system:"#60a5fa"},e={chat:"Чат",action:"Действие",emotion:"Эмоция",system:"Система"},f=Math.max(1,...b.eventsByType.map(a=>a.count)),g=Math.max(1,...b.moodDistribution.map(a=>a.count)),h=b.topRelationship.sentiment>0?"#4ade80":b.topRelationship.sentiment<0?"#f87171":"var(--muted-foreground)";return(0,l.jsxs)("div",{className:"flex flex-col h-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,l.jsx)("div",{className:"shrink-0 flex items-center px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:(0,l.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"СТАТИСТИКА МИРА"})}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-5",children:[(0,l.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,l.jsx)(aR,{label:"Всего событий",value:b.totalEvents}),(0,l.jsx)(aR,{label:"Диалогов",value:b.totalConversations}),(0,l.jsx)(aR,{label:"Среднее настроение",value:`${(100*b.avgMood).toFixed(0)}%`,sub:"0% = плохо, 100% = отлично"}),(0,l.jsx)(aR,{label:"Самый активный",value:b.mostActiveAgent})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-3",style:{color:"var(--muted-foreground)"},children:"СОБЫТИЯ ПО ТИПАМ"}),(0,l.jsx)(aS,{items:b.eventsByType.map(a=>({label:e[a.type]||a.type,value:a.count,color:d[a.type]||"var(--cyber-glow)"})),maxVal:f})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-3",style:{color:"var(--muted-foreground)"},children:"РАСПРЕДЕЛЕНИЕ НАСТРОЕНИЙ"}),(0,l.jsx)(aS,{items:b.moodDistribution.map(a=>({label:p[a.mood].label,value:a.count,color:p[a.mood].color})),maxVal:g})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"САМАЯ СИЛЬНАЯ СВЯЗЬ"}),(0,l.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.15)"},children:[(0,l.jsxs)("div",{className:"flex items-center gap-3",children:[(0,l.jsx)("span",{className:"font-mono text-sm",style:{color:"var(--foreground)"},children:b.topRelationship.from}),(0,l.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"<->"}),(0,l.jsx)("span",{className:"font-mono text-sm",style:{color:"var(--foreground)"},children:b.topRelationship.to})]}),(0,l.jsxs)("span",{className:"font-mono text-sm font-bold",style:{color:h},children:[b.topRelationship.sentiment>0?"+":"",(100*b.topRelationship.sentiment).toFixed(0),"%"]})]})]})]})]})}let aU="__all_agents__",aV=["agents.list.updated","agent.status.changed","agent.message","agent.progress","agent.error"];function aW({refreshToken:a}){let[b,c]=(0,m.useState)([]),[d,e]=(0,m.useState)(aU),[f,h]=(0,m.useState)([]),[i,j]=(0,m.useState)("ask"),[k,n]=(0,m.useState)(""),[o,q]=(0,m.useState)(!0),[r,s]=(0,m.useState)(!1),[t,u]=(0,m.useState)(null),[v,w]=(0,m.useState)(null),x=(0,m.useRef)(0),y=(0,m.useRef)(d),z=(0,m.useMemo)(()=>b.find(a=>a.id===d),[b,d]);(0,m.useEffect)(()=>{y.current=d},[d]),(0,m.useEffect)(()=>{let a=!0,b=null,d=async({silent:b=!1}={})=>{let d=++x.current;b||(q(!0),h([]));try{let b=await L();if(!a||d!==x.current)return;c(b);let f=y.current,g=f===aU||b.some(a=>a.id===f)?f:b[0]?.id??aU;g!==f&&(y.current=g,e(g));let i=g===aU?await G(20):await F(g,120);if(!a||d!==x.current)return;h(i.filter(a=>"system"!==a.role).slice().sort((a,b)=>new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime()))}finally{a&&!b&&q(!1)}},f=()=>{a&&d({silent:!0})},i=async()=>{let c,e,h=(c=process.env.NEXT_PUBLIC_BACKEND_URL?.trim())&&c.length>0?c.replace(/\/+$/,""):"http://localhost:5133",i=(e=process.env.NEXT_PUBLIC_USER_ID?.trim())&&e.length>0?e:"demo-user",j=`${h}/hubs/agents?userId=${encodeURIComponent(i)}`;for(let a of(b=new aL().withUrl(j).withAutomaticReconnect().configureLogging(g.Error).build(),aV))b.on(a,f);b.onreconnected(()=>{a&&(b?.invoke("SubscribeUser").catch(()=>void 0),d({silent:!0}))});try{if(await b.start(),!a)return;await b.invoke("SubscribeUser")}catch(a){console.warn("[messages-panel] SignalR connection failed, fallback to polling",a)}};d(),i();let j=setInterval(()=>{d({silent:!0})},5e3);return()=>{if(a=!1,clearInterval(j),b){for(let a of aV)b.off(a,f);b.stop()}}},[a]),(0,m.useEffect)(()=>{let a=!0,b=++x.current;return q(!0),h([]),(async()=>{try{let c=d===aU?await G(20):await F(d,120);if(!a||b!==x.current)return;h(c.filter(a=>"system"!==a.role).slice().sort((a,b)=>new Date(a.timestamp).getTime()-new Date(b.timestamp).getTime()))}finally{a&&b===x.current&&q(!1)}})(),()=>{a=!1}},[d]);let A=async()=>{let a=k.trim();if(!a||r)return;s(!0),u(null),w(null);let b="ask"===i?"chat.ask":"action.nudge";if(d!==aU){let b={id:`local-user-${Date.now()}`,agentId:d,agentName:z?.name??"You",role:"user",content:a,timestamp:new Date().toISOString()};h(a=>[...a,b])}try{if(d===aU){let c=await I(a,{command:b});if(!c)return void u("Failed to send message to all agents.");c.rejectedCount>0?w(`Sent: ${c.acceptedCount}, rejected: ${c.rejectedCount}.`):w(`Sent to all agents: ${c.acceptedCount}.`)}else{if(!await H(d,a,b))return void u("Failed to send message to selected agent.");w("Message queued. Agent is processing it.")}n("")}finally{s(!1)}};return(0,l.jsxs)("div",{className:"flex h-full w-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,l.jsxs)("aside",{className:"shrink-0 border-r px-3 py-4 overflow-y-auto",style:{borderColor:"rgba(229,195,75,0.15)",width:"clamp(220px, 21%, 300px)"},children:[(0,l.jsx)("div",{className:"font-mono text-[10px] tracking-widest uppercase mb-3",style:{color:"var(--muted-foreground)"},children:"Диалоги"}),(0,l.jsxs)("button",{onClick:()=>e(aU),className:"w-full text-left rounded-sm px-3 py-2 mb-2",style:{backgroundColor:d===aU?"rgba(229,195,75,0.12)":"rgba(229,195,75,0.05)",border:d===aU?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.16)"},children:[(0,l.jsx)("div",{className:"font-mono text-xs uppercase",style:{color:"var(--cyber-glow)"},children:"Все агенты"}),(0,l.jsx)("div",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:"Общий сигнал и ответы"})]}),(0,l.jsx)("div",{className:"flex flex-col gap-2",children:b.map(a=>{let b,c=p[a.mood],f=d===a.id;return(0,l.jsxs)("button",{onClick:()=>e(a.id),className:"w-full text-left rounded-sm px-3 py-2",style:{backgroundColor:f?"rgba(229,195,75,0.12)":"rgba(229,195,75,0.04)",border:f?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.12)"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"font-mono text-xs uppercase",style:{color:"var(--foreground)"},children:a.name}),(0,l.jsx)("span",{className:"font-mono text-[10px]",style:{color:c.color},children:c.label})]}),(0,l.jsx)("div",{className:"font-mono text-[10px] mt-1",style:{color:"var(--muted-foreground)"},children:(b=a.currentPlan.replace(/\s+/g," ").trim()).length<=42?b:`${b.slice(0,39)}...`})]},a.id)})})]}),(0,l.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,l.jsxs)("div",{className:"shrink-0 border-b px-4 py-3 flex items-center justify-between",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,l.jsx)("div",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:d===aU?"Сообщения / Все агенты":`Сообщения / ${z?.name??"Агент"}`}),(0,l.jsxs)("div",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:[f.length," сообщений"]})]}),(0,l.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 flex flex-col gap-2",children:[o?(0,l.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Загрузка переписки..."}):null,o||0!==f.length?null:(0,l.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Пока нет сообщений."}),f.map(a=>{let b="user"===a.role;return(0,l.jsx)("div",{className:`flex ${b?"justify-end":"justify-start"}`,children:(0,l.jsxs)("div",{className:"max-w-[82%] rounded-sm px-3 py-2",style:{backgroundColor:b?"rgba(229,195,75,0.08)":"rgba(74,222,128,0.08)",border:`1px solid ${b?"#e5c34b":"#4ade80"}40`},children:[d===aU?(0,l.jsx)("div",{className:"font-mono text-[10px] mb-1 uppercase",style:{color:"var(--cyber-glow)"},children:a.agentName}):null,(0,l.jsx)("div",{className:"font-mono text-xs whitespace-pre-wrap",style:{color:"var(--foreground)"},children:a.content}),(0,l.jsxs)("div",{className:"font-mono text-[10px] mt-1",style:{color:"var(--muted-foreground)"},children:[a.role," | ",new Date(a.timestamp).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"})]})]})},a.id)})]}),(0,l.jsxs)("div",{className:"shrink-0 border-t px-4 py-3",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,l.jsx)("button",{onClick:()=>j("ask"),className:"font-mono text-[10px] tracking-widest uppercase px-2 py-1 rounded-sm",style:{color:"ask"===i?"var(--cyber-glow)":"var(--muted-foreground)",border:"ask"===i?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.15)",backgroundColor:"ask"===i?"rgba(229,195,75,0.1)":"rgba(229,195,75,0.03)"},children:"Вопрос"}),(0,l.jsx)("button",{onClick:()=>j("nudge"),className:"font-mono text-[10px] tracking-widest uppercase px-2 py-1 rounded-sm",style:{color:"nudge"===i?"var(--cyber-glow)":"var(--muted-foreground)",border:"nudge"===i?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.15)",backgroundColor:"nudge"===i?"rgba(229,195,75,0.1)":"rgba(229,195,75,0.03)"},children:"Подстрекать к действию"})]}),(0,l.jsxs)("div",{className:"flex gap-2",children:[(0,l.jsx)("textarea",{value:k,onChange:a=>n(a.target.value),placeholder:d===aU?"Введите общий сигнал для всех агентов...":"Введите сообщение агенту...",className:"flex-1 min-h-[72px] max-h-[180px] rounded-sm p-2 font-mono text-xs outline-none resize-y",style:{backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.2)",color:"var(--foreground)"},disabled:r}),(0,l.jsx)("button",{onClick:A,disabled:r||0===k.trim().length,className:"shrink-0 h-fit font-mono text-xs tracking-widest uppercase px-3 py-2 rounded-sm disabled:cursor-not-allowed",style:{color:r?"var(--muted-foreground)":"var(--cyber-glow)",border:"1px solid rgba(229,195,75,0.35)",backgroundColor:r?"rgba(229,195,75,0.03)":"rgba(229,195,75,0.09)"},children:r?"ОТПРАВКА...":"ОТПРАВИТЬ"})]}),t?(0,l.jsx)("div",{className:"font-mono text-[11px] mt-2",style:{color:"#f87171"},children:t}):null,v?(0,l.jsx)("div",{className:"font-mono text-[11px] mt-2",style:{color:"#4ade80"},children:v}):null]})]})]})}function aX(){let[a,b]=(0,m.useState)("graph"),[c,d]=(0,m.useState)(1),[e,f]=(0,m.useState)(null),[g,h]=(0,m.useState)(null),[i,j]=(0,m.useState)(null),[k,n]=(0,m.useState)(0);(0,m.useEffect)(()=>{let a=!0,b=async()=>{let b=await P();b&&a&&(d(a=>Math.abs(a-b.speed)>.001?b.speed:a),f(a=>{if(!a)return b.gameTime;let c=new Date(a).getTime(),d=new Date(b.gameTime).getTime();return Number.isFinite(c)&&Number.isFinite(d)?Math.abs(d-c)>=6e4?b.gameTime:a:b.gameTime}))};b();let c=setInterval(b,5e3);return()=>{a=!1,clearInterval(c)}},[]);let p=async a=>{await C(a)?n(a=>a+1):console.warn("[ui] Event was not sent to backend, fallback mode is active")},q=async a=>{d(a);let b=await Q(a);b&&(d(b.speed),f(b.gameTime),n(a=>a+1))},r=async()=>{if(!window.confirm("Начать симуляцию заново? Текущие агенты, связи и события будут сброшены."))return;let a=await R();a&&(d(a.speed),f(a.gameTime),h(null),j(null),n(a=>a+1))},s=a=>{h(a),j("graph"),b("agents")};return(0,l.jsx)(o,{activeTab:a,onTabChange:a=>{b(a),"agents"!==a&&(h(null),j(null))},onAddEvent:p,timeSpeed:c,onTimeSpeedChange:q,onRestartSimulation:r,worldTime:e,children:function(){switch(a){case"graph":return(0,l.jsx)(V,{onSelectAgent:s,refreshToken:k});case"events":return(0,l.jsx)(aO,{refreshToken:k});case"stats":return(0,l.jsx)(aT,{refreshToken:k});case"agents":return(0,l.jsx)(aQ,{refreshToken:k,preSelectedAgentId:g,onClearSelection:()=>{h(null),"graph"===i&&(b("graph"),j(null))},fromGraph:"graph"===i});case"messages":return(0,l.jsx)(aW,{refreshToken:k});default:return null}}()})}a.s(["default",()=>aX],60350)}];

//# sourceMappingURL=app_page_tsx_55b2e5ee._.js.map