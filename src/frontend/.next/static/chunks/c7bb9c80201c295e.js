(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,31713,e=>{"use strict";var t,o,r,n,s,i,a,l,c,d,h=e.i(43476),u=e.i(71645);let g=[{id:"graph",label:"ГРАФ"},{id:"events",label:"СОБЫТИЯ"},{id:"stats",label:"СТАТИСТИКА"},{id:"agents",label:"АГЕНТЫ"},{id:"messages",label:"СООБЩЕНИЯ"}];function p({children:e,activeTab:t="graph",onTabChange:o,onAddEvent:r,timeSpeed:n=1,onTimeSpeedChange:s,onRestartSimulation:i,worldTime:a}){let[l,c]=(0,u.useState)("--:--:--"),[d,p]=(0,u.useState)("--.--.----"),[m,f]=(0,u.useState)(""),[b,x]=(0,u.useState)(!1),[_,y]=(0,u.useState)(!1),v=(0,u.useRef)(1),w=n<=.001;(0,u.useEffect)(()=>{n>.001&&(v.current=n)},[n]),(0,u.useEffect)(()=>{y(!0)},[]),(0,u.useEffect)(()=>{if(!a){c("--:--:--"),p("--.--.----");return}let e=new Date(a);if(Number.isNaN(e.getTime())){c("--:--:--"),p("--.--.----");return}let t=e.getTime(),o=Math.max(0,n),r=()=>{let e=new Date(t);c(e.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"})),p(e.toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"})),t+=1e3*o*60};r();let s=setInterval(r,1e3);return()=>clearInterval(s)},[a,n]);let k=()=>{m.trim()&&r&&(r(m.trim()),f(""))};return(0,h.jsxs)("div",{className:"relative w-screen overflow-hidden flex flex-col",style:{height:"100dvh",backgroundColor:"var(--background)"},children:[(0,h.jsx)("div",{className:"pointer-events-none absolute inset-0 z-50",style:{background:"repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(229,195,75,0.008) 2px, rgba(229,195,75,0.008) 4px)"}}),(0,h.jsxs)("svg",{className:"pointer-events-none absolute inset-0 z-40 hidden md:block",style:{width:"100%",height:"100%"},viewBox:"0 0 1000 1000",preserveAspectRatio:"none",fill:"none",children:[(0,h.jsxs)("defs",{children:[(0,h.jsxs)("filter",{id:"glow",children:[(0,h.jsx)("feGaussianBlur",{stdDeviation:"2",result:"blur"}),(0,h.jsxs)("feMerge",{children:[(0,h.jsx)("feMergeNode",{in:"blur"}),(0,h.jsx)("feMergeNode",{in:"SourceGraphic"})]})]}),(0,h.jsxs)("filter",{id:"glow-strong",children:[(0,h.jsx)("feGaussianBlur",{stdDeviation:"4",result:"blur"}),(0,h.jsxs)("feMerge",{children:[(0,h.jsx)("feMergeNode",{in:"blur"}),(0,h.jsx)("feMergeNode",{in:"SourceGraphic"})]})]})]}),(0,h.jsx)("path",{d:"M 30 6 L 970 6 L 994 30 L 994 970 L 970 994 L 30 994 L 6 970 L 6 30 Z",stroke:"var(--cyber-glow)",strokeWidth:"1.2",filter:"url(#glow)",opacity:"0.8"}),(0,h.jsx)("path",{d:"M 34 10 L 966 10 L 990 34 L 990 966 L 966 990 L 34 990 L 10 966 L 10 34 Z",stroke:"var(--cyber-glow)",strokeWidth:"0.3",opacity:"0.25"}),(0,h.jsx)("path",{d:"M 6 55 L 6 30 L 30 6",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),(0,h.jsx)("path",{d:"M 970 6 L 994 30 L 994 55",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),(0,h.jsx)("path",{d:"M 994 945 L 994 970 L 970 994",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),(0,h.jsx)("path",{d:"M 30 994 L 6 970 L 6 945",stroke:"var(--cyber-glow)",strokeWidth:"2",filter:"url(#glow-strong)",strokeLinecap:"square"}),[150,300,500,700,850].map(e=>(0,h.jsx)("line",{x1:e,y1:6,x2:e,y2:12,stroke:"var(--cyber-glow)",strokeWidth:"0.5",opacity:"0.35"},e))]}),(0,h.jsx)("div",{className:"pointer-events-none absolute inset-[2px] z-40 md:hidden",style:{border:"1px solid var(--cyber-glow)",boxShadow:"0 0 6px var(--cyber-glow-dim), inset 0 0 6px var(--cyber-glow-dim)",opacity:.5}}),(0,h.jsx)("div",{className:"absolute left-[0.35%] top-1/2 z-40 -translate-y-1/2 flex-col gap-1 hidden lg:flex",children:[.9,.7,.5,.3].map((e,t)=>(0,h.jsx)("div",{className:"rounded-sm",style:{width:"3px",height:"14px",backgroundColor:"var(--cyber-glow)",opacity:e,boxShadow:"0 0 4px var(--cyber-glow-dim)"}},t))}),(0,h.jsx)("div",{className:"absolute right-[0.35%] top-1/2 z-40 -translate-y-1/2 flex-col gap-1 hidden lg:flex",children:[.3,.5,.7,.9].map((e,t)=>(0,h.jsx)("div",{className:"rounded-sm",style:{width:"3px",height:"14px",backgroundColor:"var(--cyber-glow)",opacity:e,boxShadow:"0 0 4px var(--cyber-glow-dim)"}},t))}),(0,h.jsxs)("div",{className:"relative z-10 flex flex-col h-full",style:{padding:"1.2% 1.8%"},children:[(0,h.jsxs)("header",{className:"shrink-0 flex flex-col gap-2 pb-[0.6%]",children:[(0,h.jsx)("div",{className:"flex items-center justify-between",children:(0,h.jsxs)("div",{className:"flex items-center gap-4 pl-[1.5%]",children:[(0,h.jsx)("h1",{className:"font-mono text-base md:text-lg lg:text-xl tracking-[0.2em] uppercase whitespace-nowrap",style:{color:"var(--cyber-glow)"},children:"LONG LIVE MODELS"}),(0,h.jsxs)("div",{className:"flex flex-col items-start gap-1",children:[(0,h.jsxs)("div",{className:"flex items-center gap-2",children:[(0,h.jsx)("button",{onClick:()=>{if(s){if(w)return void s(Math.max(v.current,1));s(0)}},className:"font-mono text-[10px] md:text-xs tracking-wider uppercase cursor-pointer",style:{color:w?"#4ade80":"#f87171",border:`1px solid ${w?"rgba(74,222,128,0.45)":"rgba(248,113,113,0.45)"}`,backgroundColor:w?"rgba(74,222,128,0.12)":"rgba(248,113,113,0.12)",padding:"2px 8px",transition:"all 0.2s ease"},title:w?"Продолжить течение игрового времени":"Остановить течение игрового времени",children:w?"ПРОДОЛЖИТЬ ВРЕМЯ":"ОСТАНОВИТЬ ВРЕМЯ"}),(0,h.jsx)("button",{onClick:i,disabled:!i,className:"font-mono text-[10px] md:text-xs tracking-wider uppercase cursor-pointer disabled:cursor-not-allowed",style:{color:i?"var(--cyber-glow)":"var(--muted-foreground)",border:"1px solid rgba(229,195,75,0.35)",backgroundColor:i?"rgba(229,195,75,0.1)":"rgba(229,195,75,0.03)",padding:"2px 8px",transition:"all 0.2s ease"},title:"Полностью сбросить мир и начать симуляцию заново",children:"НАЧАТЬ ЗАНОВО"})]}),(0,h.jsxs)("span",{className:"font-mono text-xs md:text-sm tabular-nums whitespace-nowrap",style:{color:"var(--cyber-glow)",opacity:.5},children:[d,(0,h.jsx)("span",{className:"mx-1.5",style:{opacity:.4},children:"/"}),l]})]})]})}),(0,h.jsxs)("div",{className:"flex items-center justify-between",children:[(0,h.jsx)("nav",{className:"flex items-center pl-[1.5%]",children:g.map(e=>{let r=t===e.id;return(0,h.jsx)("button",{onClick:()=>o?.(e.id),className:"font-mono text-sm md:text-base tracking-wider uppercase cursor-pointer whitespace-nowrap",style:{padding:"6px 14px",color:r?"var(--cyber-glow)":"var(--muted-foreground)",backgroundColor:r?"rgba(229,195,75,0.1)":"transparent",borderBottom:r?"2px solid var(--cyber-glow)":"2px solid transparent",textShadow:r?"0 0 10px rgba(229,195,75,0.4)":"none",transition:"all 0.2s ease"},onMouseEnter:e=>{r||(e.currentTarget.style.color="var(--cyber-glow)",e.currentTarget.style.backgroundColor="rgba(229,195,75,0.06)",e.currentTarget.style.textShadow="0 0 10px rgba(229,195,75,0.3)",e.currentTarget.style.borderBottom="2px solid rgba(229,195,75,0.4)")},onMouseLeave:e=>{r||(e.currentTarget.style.color="var(--muted-foreground)",e.currentTarget.style.backgroundColor="transparent",e.currentTarget.style.textShadow="none",e.currentTarget.style.borderBottom="2px solid transparent")},children:e.label},e.id)})}),(0,h.jsxs)("div",{className:"relative flex items-center gap-3 shrink-0",style:{padding:"5px 14px",backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.1)",clipPath:"polygon(4px 0, calc(100% - 4px) 0, 100% 4px, 100% calc(100% - 4px), calc(100% - 4px) 100%, 4px 100%, 0 calc(100% - 4px), 0 4px)"},onMouseEnter:()=>x(!0),onMouseLeave:()=>x(!1),children:[(0,h.jsx)("span",{className:"font-mono text-xs tracking-widest uppercase select-none",style:{color:"var(--muted-foreground)"},children:"СКОРОСТЬ"}),(0,h.jsx)("input",{type:"range",min:0,max:5,step:.1,value:n,onChange:e=>s?.(Math.round(10*parseFloat(e.target.value))/10),className:"cyber-slider h-1",style:{width:"clamp(80px, 8vw, 160px)",background:`linear-gradient(to right, var(--cyber-glow) ${n/5*100}%, var(--border) ${n/5*100}%)`}}),(0,h.jsxs)("button",{onClick:()=>s?.(1),className:"font-mono text-sm tabular-nums cursor-pointer",title:_?`Клик = сброс на 1x`:void 0,style:{color:"var(--cyber-glow)",textShadow:n>0?"0 0 8px rgba(229,195,75,0.4)":"none",background:"none",border:"none",padding:0,width:"3.5em",textAlign:"right",transition:"opacity 0.2s ease, text-shadow 0.2s ease",opacity:1===n?.7:1},onMouseEnter:e=>{e.currentTarget.style.textShadow="0 0 14px rgba(229,195,75,0.7)"},onMouseLeave:e=>{e.currentTarget.style.textShadow=n>0?"0 0 8px rgba(229,195,75,0.4)":"none"},children:[n.toFixed(1),"x"]}),b&&(0,h.jsx)("div",{className:"absolute top-full right-0 mt-2 px-3 py-1.5 font-mono text-[10px] tracking-wide whitespace-nowrap pointer-events-none z-50 hidden lg:block",style:{backgroundColor:"rgba(17,17,24,0.95)",border:"1px solid rgba(229,195,75,0.25)",color:"var(--cyber-glow)",clipPath:"polygon(4px 0, calc(100% - 4px) 0, 100% 4px, 100% calc(100% - 4px), calc(100% - 4px) 100%, 4px 100%, 0 calc(100% - 4px), 0 4px)"},children:"Скорость течения времени мира // Клик на значение = сброс"})]})]})]}),(0,h.jsx)("div",{className:"relative flex-1 min-h-0 overflow-hidden rounded-sm border",style:{borderColor:"rgba(229,195,75,0.2)"},children:e}),(0,h.jsx)("div",{className:"shrink-0",style:{paddingTop:"0.6%"},children:(0,h.jsx)("div",{className:"relative overflow-hidden",style:{clipPath:"polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px)"},children:(0,h.jsxs)("div",{className:"flex items-center gap-3",style:{padding:"4px 6px",border:"1px solid rgba(229,195,75,0.2)",backgroundColor:"rgba(17,17,24,0.9)",animation:"cyber-shimmer 4s ease-in-out infinite",clipPath:"polygon(8px 0, calc(100% - 8px) 0, 100% 8px, 100% calc(100% - 8px), calc(100% - 8px) 100%, 8px 100%, 0 calc(100% - 8px), 0 8px)"},children:[(0,h.jsx)("div",{className:"shrink-0 pl-2",children:(0,h.jsx)("div",{className:"h-2 w-2 rounded-full",style:{backgroundColor:"var(--cyber-glow)",boxShadow:"0 0 6px var(--cyber-glow-dim)",animation:"cyber-pulse 2s ease-in-out infinite"}})}),(0,h.jsx)("input",{type:"text",value:m,onChange:e=>f(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),k())},placeholder:"Введите событие для мира агентов...",className:"flex-1 bg-transparent font-mono text-sm md:text-base py-2.5 placeholder:opacity-30 focus:outline-none",style:{color:"var(--foreground)",caretColor:"var(--cyber-glow)",paddingLeft:"8px",paddingRight:"8px"}}),(0,h.jsx)("button",{onClick:k,className:"shrink-0 font-mono text-xs md:text-sm tracking-widest uppercase cursor-pointer",style:{padding:"10px 20px",marginRight:"4px",backgroundColor:"rgba(229,195,75,0.08)",color:"var(--cyber-glow)",border:"1px solid rgba(229,195,75,0.25)",clipPath:"polygon(6px 0, calc(100% - 6px) 0, 100% 6px, 100% calc(100% - 6px), calc(100% - 6px) 100%, 6px 100%, 0 calc(100% - 6px), 0 6px)",transition:"all 0.25s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.18)",e.currentTarget.style.borderColor="rgba(229,195,75,0.6)",e.currentTarget.style.boxShadow="0 0 20px rgba(229,195,75,0.15), inset 0 0 12px rgba(229,195,75,0.06)",e.currentTarget.style.textShadow="0 0 10px rgba(229,195,75,0.5)",e.currentTarget.style.color="#f5d96b"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.08)",e.currentTarget.style.borderColor="rgba(229,195,75,0.25)",e.currentTarget.style.boxShadow="none",e.currentTarget.style.textShadow="none",e.currentTarget.style.color="var(--cyber-glow)"},onMouseDown:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.3)",e.currentTarget.style.transform="scale(0.97)"},onMouseUp:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.18)",e.currentTarget.style.transform="scale(1)"},children:"ДОБАВИТЬ СОБЫТИЕ"})]})})})]})]})}var m=e.i(47167);let f={happy:{color:"#4ade80",label:"Счастлив"},neutral:{color:"#a0a0b0",label:"Нейтрален"},sad:{color:"#60a5fa",label:"Грустит"},angry:{color:"#f87171",label:"Злится"},excited:{color:"#e5c34b",label:"Воодушевлён"},anxious:{color:"#c084fc",label:"Тревожится"}},b=[{id:"agent-1",name:"Алексей",avatar:"А",mood:"happy",traits:["общительный","оптимист","любопытный"],description:"Молодой исследователь, который всегда ищет новые знакомства. Верит в лучшее в людях.",currentPlan:"Поговорить с Мариной о вчерашнем событии",memories:["Встретил Марину на площади","Поспорил с Виктором о политике","Нашёл старую книгу в библиотеке"]},{id:"agent-2",name:"Марина",avatar:"М",mood:"neutral",traits:["задумчивая","художница","интроверт"],description:"Талантливая художница, предпочитает одиночество. Наблюдает за миром через призму искусства.",currentPlan:"Закончить картину заката",memories:["Разговор с Алексеем был приятным","Виктор показался грубым","Увидела красивый закат"]},{id:"agent-3",name:"Виктор",avatar:"В",mood:"angry",traits:["прямолинейный","амбициозный","упрямый"],description:"Бывший военный, привык командовать. Не терпит слабости, но глубоко внутри одинок.",currentPlan:"Доказать свою правоту Алексею",memories:["Спор с Алексеем закончился ничем","Марина отвернулась при встрече","Вспомнил службу в армии"]},{id:"agent-4",name:"Елена",avatar:"Е",mood:"excited",traits:["энергичная","лидер","эмпат"],description:"Врач по профессии и миротворец по натуре. Старается помирить всех вокруг.",currentPlan:"Организовать общий ужин для всех",memories:["Помогла незнакомцу на улице","Заметила напряжение между Виктором и Алексеем","Получила письмо от старого друга"]},{id:"agent-5",name:"Дмитрий",avatar:"Д",mood:"sad",traits:["замкнутый","умный","меланхоличный"],description:"Бывший учёный, потерял лабораторию в пожаре. Живёт на окраине и избегает людей.",currentPlan:"Попытаться восстановить записи из сгоревшей лаборатории",memories:["Пожар уничтожил десять лет работы","Марина однажды принесла еду","Не доверяет Виктору"]},{id:"agent-6",name:"Ольга",avatar:"О",mood:"anxious",traits:["осторожная","наблюдательная","скрытная"],description:"Торговка на рынке. Знает все сплетни города, но сама держит много секретов.",currentPlan:"Разузнать, что случилось на площади вчера ночью",memories:["Видела Виктора в переулке поздно ночью","Елена покупает у неё травы каждую неделю","Кто-то следит за ней -- уверена"]},{id:"agent-7",name:"Игорь",avatar:"И",mood:"neutral",traits:["спокойный","справедливый","старомодный"],description:"Пожилой сторож библиотеки. Видел многое, говорит мало, но когда говорит -- все слушают.",currentPlan:"Присматривать за библиотекой и читать хроники",memories:["Алексей часто приходит читать","Помнит, каким был город до войны","Не одобряет поведение Виктора"]},{id:"agent-8",name:"Настя",avatar:"Н",mood:"happy",traits:["жизнерадостная","наивная","творческая"],description:"Студентка-музыкант, недавно приехала в город. Ещё не знает местных интриг.",currentPlan:"Найти место для репетиции и познакомиться с людьми",memories:["Город показался красивым, но странным","Марина улыбнулась ей на улице","Услышала громкий спор на площади"]}],x=[{id:"evt-1",agentId:"agent-1",agentName:"Алексей",type:"chat",text:"Привет, Марина! Как твоя новая картина?",timestamp:new Date(Date.now()-3e5).toISOString()},{id:"evt-2",agentId:"agent-2",agentName:"Марина",type:"emotion",text:"Почувствовала прилив вдохновения от заката",timestamp:new Date(Date.now()-24e4).toISOString()},{id:"evt-3",agentId:"agent-3",agentName:"Виктор",type:"action",text:"Отправился на площадь, чтобы найти Алексея",timestamp:new Date(Date.now()-18e4).toISOString()},{id:"evt-4",agentId:"agent-4",agentName:"Елена",type:"chat",text:"Виктор, давай поговорим спокойно. Я уверена, вы с Алексеем найдёте общий язык.",timestamp:new Date(Date.now()-12e4).toISOString()},{id:"evt-5",agentId:"agent-3",agentName:"Виктор",type:"emotion",text:"Раздражён: Елена снова лезет не в своё дело",timestamp:new Date(Date.now()-6e4).toISOString()},{id:"evt-6",agentId:"agent-1",agentName:"Алексей",type:"action",text:"Зашёл в библиотеку и нашёл интересную книгу об истории города",timestamp:new Date(Date.now()-3e4).toISOString()},{id:"evt-7",agentId:"agent-2",agentName:"Марина",type:"action",text:"Поставила мольберт у реки и начала рисовать",timestamp:new Date(Date.now()-15e3).toISOString()},{id:"evt-8",agentId:"agent-4",agentName:"Елена",type:"system",text:"Решила организовать общий ужин сегодня вечером",timestamp:new Date(Date.now()-5e3).toISOString()},{id:"evt-9",agentId:"agent-5",agentName:"Дмитрий",type:"action",text:"Нашёл обгоревший дневник среди руин лаборатории",timestamp:new Date(Date.now()-28e4).toISOString()},{id:"evt-10",agentId:"agent-6",agentName:"Ольга",type:"emotion",text:"Тревога нарастает -- кто-то определённо следит",timestamp:new Date(Date.now()-2e5).toISOString()},{id:"evt-11",agentId:"agent-7",agentName:"Игорь",type:"action",text:"Открыл старый архив в подвале библиотеки",timestamp:new Date(Date.now()-15e4).toISOString()},{id:"evt-12",agentId:"agent-8",agentName:"Настя",type:"chat",text:"Простите, вы не подскажете, где тут можно порепетировать?",timestamp:new Date(Date.now()-9e4).toISOString()}],_=[{from:"agent-1",to:"agent-2",sentiment:.7,label:"дружба"},{from:"agent-1",to:"agent-3",sentiment:-.4,label:"конфликт"},{from:"agent-1",to:"agent-7",sentiment:.4,label:"уважение"},{from:"agent-2",to:"agent-5",sentiment:.3,label:"сочувствие"},{from:"agent-2",to:"agent-8",sentiment:.5,label:"симпатия"},{from:"agent-3",to:"agent-4",sentiment:-.2,label:"раздражение"},{from:"agent-3",to:"agent-7",sentiment:-.3,label:"неприязнь"},{from:"agent-4",to:"agent-6",sentiment:.4,label:"торговля"},{from:"agent-4",to:"agent-1",sentiment:.5,label:"знакомые"},{from:"agent-6",to:"agent-3",sentiment:-.1,label:"подозрение"},{from:"agent-8",to:"agent-1",sentiment:.2,label:"знакомые"},{from:"agent-5",to:"agent-7",sentiment:.2,label:"соседи"}],y={totalEvents:847,totalConversations:234,avgMood:.62,mostActiveAgent:"Алексей",topRelationship:{from:"agent-1",to:"agent-2",sentiment:.7},eventsByType:[{type:"chat",count:312},{type:"action",count:289},{type:"emotion",count:178},{type:"system",count:68}],moodDistribution:[{mood:"happy",count:2},{mood:"neutral",count:2},{mood:"sad",count:1},{mood:"angry",count:1},{mood:"excited",count:1},{mood:"anxious",count:1}]},v=new Map(b.map(e=>[e.id,[]]));for(let e of x){let t=v.get(e.agentId)??[];t.push({id:`mock-msg-${e.id}`,agentId:e.agentId,agentName:e.agentName,role:"assistant",content:e.text,timestamp:e.timestamp}),v.set(e.agentId,t)}function w(){let e=m.default.env.NEXT_PUBLIC_USER_ID?.trim();return e&&e.length>0?e:"demo-user"}async function k(e,t,o=15e3){let r,n=new Headers(t?.headers);n.set("Accept","application/json"),n.set("X-User-Id",w()),t?.body&&!n.has("Content-Type")&&n.set("Content-Type","application/json");let s=new AbortController,i=setTimeout(()=>s.abort(),Math.max(1e3,o));try{r=await fetch(`/api/backend${e}`,{...t,headers:n,cache:"no-store",signal:s.signal})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw Error(`Backend request timed out after ${o}ms`);throw e}finally{clearTimeout(i)}if(!r.ok)throw Error(`Backend request failed: ${r.status} ${r.statusText}`);return await r.json()}function S(e){var t,o,r;let n,s,i,a=(t=e.status,o=e.energy,r=e.emotion,n=t.toLowerCase(),s=r?.trim().toLowerCase()??"",i=Number.isFinite(o)?Math.max(0,Math.min(1,o)):.5,s.includes("радост")||s.includes("счаст")||s.includes("вдохнов")||s.includes("воодуш")?"happy":s.includes("спокой")||s.includes("нейтрал")?"neutral":s.includes("устал")||s.includes("груст")?"sad":s.includes("раздраж")||s.includes("зл")?"angry":s.includes("тревог")||s.includes("напряж")?"anxious":n.includes("error")||n.includes("failed")?"angry":n.includes("stop")||n.includes("archived")?"sad":n.includes("pause")?"anxious":i>=.8?"excited":i>=.6?"happy":i>=.4?"neutral":i>=.2?"anxious":"sad"),l=function(e,t){if(t&&t.length>0)return t.slice(0,8);if(!e)return["adaptive"];let o=[{key:"openness",label:"curious"},{key:"conscientiousness",label:"disciplined"},{key:"extraversion",label:"social"},{key:"agreeableness",label:"cooperative"},{key:"neuroticism",label:"sensitive"}].map(t=>({label:t.label,value:Number(e[t.key]??0)})).sort((e,t)=>t.value-e.value).filter(e=>e.value>0).slice(0,3).map(e=>e.label);return o.length>0?o:["adaptive"]}(e.personalityTraits,e.traits),c=e.memories&&e.memories.length>0?e.memories:e.state?[`Current state: ${e.state}`]:[];return{id:e.agentId,name:e.name,avatar:e.name?.trim()?.charAt(0)?.toUpperCase()||"?",mood:a,traits:l,description:e.description?.trim()||`${e.model} - status: ${e.status}`,currentPlan:e.currentPlan?.trim()||e.state||"No current plan",memories:c}}function C(e){return!e||"object"!=typeof e||Array.isArray(e)?null:e}function j(e,t){if(e)for(let o of t){let t=e[o];if("string"==typeof t&&t.trim().length>0)return t.trim()}}function N(e){let t=e.replace(/\*\*/g," ").replace(/[«»]/g,'"').replace(/^[\"']+|[\"']+$/g,"").replace(/\s+/g," ").trim();return t?t.length<=400?t:`${t.slice(0,397)}...`:""}function T(e,t){let o,r="user"===(o=e.role.trim().toLowerCase())||"assistant"===o||"system"===o?o:"assistant";return{id:e.messageId,agentId:e.agentId,agentName:t.get(e.agentId)?.name??"Agent",role:r,content:function(e,t){let o,r=e.trim();if(!r)return"";let n=r.split(/\r?\n/).map(e=>e.trim().replace(/^\*+|\*+$/g,"").trim()).filter(e=>e.length>0);if(0===n.length)return"";if("assistant"===t){let e=n.find(e=>e.toLowerCase().startsWith("actiontext"));if(e){let t=e.indexOf(":");return N(t>=0?e.slice(t+1).trim():e)}return N(n.filter(e=>{let t=e.toLowerCase();return!t.startsWith("actionname")&&!t.startsWith("actiontext")}).join(" "))}return n.length>1&&!(!(o=n[0].trim().toLowerCase())||o.includes(" "))&&("world.update"===o||o.startsWith("chat.")||o.startsWith("action.")||o.startsWith("custom.")||o.startsWith("ui.")||o.startsWith("system."))?n.slice(1).join("\n"):n.join("\n")}(e.content,r),timestamp:e.createdAt,correlationId:e.correlationId}}async function I(e){try{return await k("/api/events",{method:"POST",body:JSON.stringify({type:"ui.note",payload:{text:e,message:e,source:"frontend",agentName:"Operator"}})}),!0}catch(e){return console.warn("[data] addEvent fallback, backend unavailable",e),!1}}function E(e){return b.find(t=>t.id===e)?.name??e}function P(e,t,o,r){let n=v.get(e)??[];n.push({id:`mock-msg-${Math.random().toString(36).slice(2,10)}`,agentId:e,agentName:E(e),role:t,content:o,timestamp:new Date().toISOString(),correlationId:r}),v.set(e,n)}async function $(e,t=80){let o=e.trim();if(!o)return[];try{let[e,r]=await Promise.all([k(`/api/user-agents/${encodeURIComponent(o)}/messages?limit=${Math.max(1,Math.floor(t))}`),W()]),n=new Map(r.map(e=>[e.id,e]));return e.items.map(e=>T(e,n)).filter(e=>e.content.trim().length>0)}catch(e){var r;return console.warn("[data] getAgentMessages fallback to mock",e),r=Math.max(1,Math.floor(t)),(v.get(o)??[]).slice(-r)}}async function D(e=20){let t=Math.max(1,Math.floor(e));try{let[e,o]=await Promise.all([k(`/api/user-agents/messages?limitPerAgent=${t}`),W()]),r=new Map(o.map(e=>[e.id,e]));return e.items.map(e=>T(e,r)).filter(e=>e.content.trim().length>0)}catch(e){return console.warn("[data] getAllAgentMessages fallback to mock",e),Array.from(v.values()).flatMap(e=>e.slice(-t)).sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime())}}async function R(e,t,o){let r=e.trim(),n=t.trim(),s=o?.trim();if(!r||!n&&!s)return null;try{let e=await k(`/api/user-agents/${encodeURIComponent(r)}/commands`,{method:"POST",body:JSON.stringify({command:s||void 0,message:n||void 0})});return{agentId:e.agentId,userId:e.userId,correlationId:e.correlationId,status:e.status,acceptedAt:e.acceptedAt}}catch(t){console.warn("[data] commandAgent fallback to mock",t);let e=`mock-${Date.now().toString(36)}`;return P(r,"user",n||s||"...",e),P(r,"assistant",`${E(r)} получил команду и готов действовать.`,e),{agentId:r,userId:w(),correlationId:e,status:"Working",acceptedAt:new Date().toISOString()}}}async function M(e,t){let o=e.trim(),r=t?.command?.trim();if(!o&&!r)return null;let n={command:r||void 0,message:o||void 0,agentIds:t?.agentIds&&t.agentIds.length>0?t.agentIds:void 0};try{let e=await k("/api/user-agents/commands/broadcast",{method:"POST",body:JSON.stringify(n)});return{userId:e.userId,acceptedAt:e.acceptedAt,acceptedCount:e.acceptedCount,rejectedCount:e.rejectedCount,items:e.items.map(e=>({agentId:e.agentId,status:e.status,correlationId:e.correlationId,reason:e.reason}))}}catch(i){console.warn("[data] broadcastAgentCommand fallback to mock",i);let e=t?.agentIds?.filter(e=>e.trim().length>0)??b.map(e=>e.id),n=`mock-${Date.now().toString(36)}`,s=e.map((e,t)=>{let s=`${n}-${t+1}`;return P(e,"user",o||r||"...",s),P(e,"assistant",`${E(e)} получил общий сигнал и приступает к задаче.`,s),{agentId:e,status:"accepted",correlationId:s}});return{userId:w(),acceptedAt:new Date().toISOString(),acceptedCount:s.length,rejectedCount:0,items:s}}}async function A(e,t){let o=e.trim();if(!o)return null;let r={prompt:o,model:t?.trim()||void 0};try{let e=await k("/api/user-agents/generate",{method:"POST",body:JSON.stringify(r)},9e4);return S(e)}catch(e){return console.warn("[data] generateAgentWithAi failed",e),null}}async function L(e){let t=e.trim();if(!t)return!1;try{return await k(`/api/user-agents/${encodeURIComponent(t)}`,{method:"DELETE"}),!0}catch(e){return console.warn("[data] deleteAgent failed",e),!1}}async function W(){try{return(await k("/api/user-agents")).map(S)}catch(e){return console.warn("[data] getAgents fallback to mock",e),b}}async function q(){try{let[e,t]=await Promise.all([W(),k("/api/events")]),o=new Map(e.map(e=>[e.id,e]));return t.map(e=>{var t,r;let n,s,i,a,l;return t=e,r=o,s=C(t.payload),i=C(s?.payload)??s,a=j(i,["agentId","agent_id","id"])??j(C(i?.agent),["id","agentId"])??"system",l=j(i,["agentName","agent_name","name"])??r.get(a)?.name??"System",{id:t.id,agentId:a,agentName:l,type:(n=t.type.toLowerCase()).includes("chat")||n.includes("message")?"chat":n.includes("emotion")||n.includes("mood")?"emotion":n.includes("system")||n.includes("status")||n.includes("error")||n.includes("progress")?"system":"action",text:function(e,t){let o=C(e),r=j(o,["text","message","description","content"]);if(r)return r;if(o){let e=j(C(o.payload),["text","message","description","content"]);if(e)return e}try{let o=JSON.stringify(e);if(!o||"{}"===o)return t;return o.slice(0,200)}catch{return t}}(t.payload,t.type),timestamp:t.createdAt}})}catch(e){return console.warn("[data] getEvents fallback to mock",e),x}}async function O(){try{return(await k("/api/relationships")).map(e=>({from:e.from,to:e.to,sentiment:e.sentiment,label:e.label??"interaction"}))}catch(e){return console.warn("[data] getRelationships fallback to mock",e),_}}async function B(){try{var e;return{totalEvents:(e=await k("/api/stats")).totalEvents,totalConversations:e.totalConversations,avgMood:e.avgMood,mostActiveAgent:e.mostActiveAgent,topRelationship:e.topRelationship,eventsByType:e.eventsByType,moodDistribution:e.moodDistribution.map(e=>{let t;return{mood:(t=e.mood.trim().toLowerCase(),"happy"===t||"neutral"===t||"sad"===t||"angry"===t||"excited"===t||"anxious"===t?t:"neutral"),count:e.count}})}}catch(e){return console.warn("[data] getStats fallback to mock",e),y}}async function H(){try{let e=await k("/api/world/time");return{gameTime:e.gameTime,speed:e.speed}}catch(e){return console.warn("[data] getWorldTime failed",e),null}}async function U(e){try{let t=await k("/api/world/time/speed",{method:"POST",body:JSON.stringify({speed:e})});return{gameTime:t.gameTime,speed:t.speed}}catch(e){return console.warn("[data] setWorldTimeSpeed failed",e),null}}async function F(){try{let e=await k("/api/world/time/reset",{method:"POST"});return{gameTime:e.gameTime,speed:e.speed}}catch(e){return console.warn("[data] resetWorldSimulation failed",e),null}}function z(e){return e>=.5?"#4ade80":e>=.2?"#86efac":e>-.2?"#555566":e>-.5?"#fca5a5":"#f87171"}function K({visible:e}){return(0,h.jsxs)("div",{className:"absolute inset-0 z-30 flex items-center justify-center",style:{backgroundColor:"var(--cyber-surface)",opacity:+!!e,pointerEvents:e?"auto":"none",transition:"opacity 0.6s ease"},children:[(0,h.jsx)("div",{className:"pointer-events-none absolute inset-0 opacity-10",style:{backgroundImage:"linear-gradient(var(--cyber-glow) 1px, transparent 1px), linear-gradient(90deg, var(--cyber-glow) 1px, transparent 1px)",backgroundSize:"60px 60px"}}),(0,h.jsxs)("div",{className:"relative flex flex-col items-center gap-4",children:[(0,h.jsx)("div",{className:"h-16 w-16 rounded-full border flex items-center justify-center",style:{borderColor:"var(--cyber-glow)",boxShadow:"0 0 20px var(--cyber-glow-dim), inset 0 0 20px var(--cyber-glow-dim)",animation:"cyber-pulse 2s ease-in-out infinite"},children:(0,h.jsxs)("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"var(--cyber-glow)",strokeWidth:"1.5",children:[(0,h.jsx)("circle",{cx:"5",cy:"12",r:"2"}),(0,h.jsx)("circle",{cx:"19",cy:"6",r:"2"}),(0,h.jsx)("circle",{cx:"19",cy:"18",r:"2"}),(0,h.jsx)("line",{x1:"7",y1:"12",x2:"17",y2:"6"}),(0,h.jsx)("line",{x1:"7",y1:"12",x2:"17",y2:"18"})]})}),(0,h.jsx)("p",{className:"font-mono text-sm tracking-[0.2em] uppercase",style:{color:"var(--cyber-glow)",opacity:.6},children:"ЗАГРУЗКА ГРАФА"})]})]})}function X(){return(0,h.jsxs)("div",{className:"absolute bottom-3 left-3 z-20 flex items-center gap-4 px-3 py-2 font-mono text-[11px]",style:{backgroundColor:"rgba(10,10,15,0.85)",border:"1px solid rgba(229,195,75,0.15)"},children:[[{color:"#4ade80",label:"Дружба"},{color:"#555566",label:"Нейтрально"},{color:"#f87171",label:"Конфликт"}].map(e=>(0,h.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,h.jsx)("div",{className:"h-[2px] w-4",style:{backgroundColor:e.color}}),(0,h.jsx)("span",{style:{color:"var(--muted-foreground)"},children:e.label})]},e.label)),(0,h.jsx)("div",{className:"flex items-center gap-1.5 ml-2",style:{borderLeft:"1px solid rgba(229,195,75,0.15)",paddingLeft:8},children:(0,h.jsx)("span",{style:{color:"var(--muted-foreground)"},children:"Клик = профиль"})})]})}function J({onSelectAgent:t,refreshToken:o}){let r=(0,u.useRef)(null),n=(0,u.useRef)(null),[s,i]=(0,u.useState)({width:0,height:0}),[a,l]=(0,u.useState)(!1),[c,d]=(0,u.useState)(!1),[g,p]=(0,u.useState)([]),[m,b]=(0,u.useState)([]),[x,_]=(0,u.useState)({nodes:[],links:[]}),[y,v]=(0,u.useState)(null),[w,k]=(0,u.useState)(null),[S,C]=(0,u.useState)({x:0,y:0}),j=(0,u.useRef)(""),N=(0,u.useRef)(""),T=(0,u.useRef)(!1);(0,u.useEffect)(()=>{let e=!0;T.current||d(!1);let t=async()=>{let[t,o]=await Promise.all([W(),O()]);if(!e)return;let r=JSON.stringify(t.map(e=>[e.id,e.name,e.avatar,e.mood])),n=JSON.stringify(o.map(e=>[e.from,e.to,e.sentiment,e.label])),s=!1;r!==j.current&&(j.current=r,p(t),s=!0),n!==N.current&&(N.current=n,b(o),s=!0),s&&_(e=>{let r,n,s;return r=new Set(t.map(e=>e.id)),n={nodes:t.map(e=>({id:e.id,name:e.name,avatar:e.avatar,mood:e.mood,moodColor:f[e.mood].color,val:8})),links:o.filter(e=>r.has(e.from)&&r.has(e.to)).map(e=>({source:e.from,target:e.to,sentiment:e.sentiment,label:e.label,color:z(e.sentiment)}))},s=new Map(e.nodes.map(e=>[e.id,e])),{nodes:n.nodes.map(e=>{let t=s.get(e.id);return t?{...e,x:t.x,y:t.y,fx:t.fx,fy:t.fy,__dragging:t.__dragging}:e}),links:n.links}}),T.current||(T.current=!0,d(!0))};t();let o=setInterval(()=>{t()},4e3);return()=>{e=!1,clearInterval(o)}},[o]),(0,u.useEffect)(()=>{let e=r.current;if(!e)return;let t=new ResizeObserver(e=>{for(let t of e)i({width:t.contentRect.width,height:t.contentRect.height})});return t.observe(e),()=>t.disconnect()},[]),(0,u.useEffect)(()=>{e.A(16727).then(e=>{v(()=>e.default),setTimeout(()=>l(!0),500)})},[]);let I=(0,u.useRef)(!1);(0,u.useEffect)(()=>{let t=n.current;t&&!I.current&&a&&(I.current=!0,t.d3Force("charge")?.strength(-300).distanceMax(500),t.d3Force("link")?.distance(120).strength(.35),t.d3Force("center")?.strength(.04),e.A(38154).then(({forceCollide:e})=>{t.d3Force("collide",e(30).strength(1).iterations(4)),t.d3ReheatSimulation()}),t.d3ReheatSimulation())},[a]),(0,u.useEffect)(()=>{let e=n.current;if(!e||!a||0===s.width)return;let t=setTimeout(()=>{e.zoomToFit(400,40),e.d3ReheatSimulation()},100);return()=>clearTimeout(t)},[s,a]);let E=(0,u.useCallback)((e,t,o)=>{let r=e.x??0,n=e.y??0,s=w?.id===e.id,i=Math.max(11/o,2.5);t.save(),s&&(t.beginPath(),t.arc(r,n,20,0,2*Math.PI),t.fillStyle="rgba(229,195,75,0.06)",t.fill()),t.beginPath(),t.arc(r,n,14,0,2*Math.PI),t.fillStyle="#111118",t.fill(),t.strokeStyle=s?"#e5c34b":e.moodColor,t.lineWidth=1.5,t.stroke(),t.textAlign="center",t.textBaseline="middle",t.font="bold 11.200000000000001px 'Geist Mono', monospace",t.fillStyle=s?"#e5c34b":e.moodColor,t.fillText(e.avatar,r,n+.5),o>.45&&(t.font=`${i}px 'Geist Mono', monospace`,t.fillStyle=s?"#e5c34b":"rgba(229,195,75,0.3)",t.fillText(e.name,r,n+14+i+3)),t.restore()},[w]),P=(0,u.useCallback)((e,t)=>{let o=e.source,r=e.target;null!=o.x&&null!=o.y&&null!=r.x&&null!=r.y&&(t.save(),t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(r.x,r.y),t.strokeStyle=e.color,t.lineWidth=1.2,t.globalAlpha=.4,t.stroke(),t.restore())},[]),$=(0,u.useMemo)(()=>{if(!w)return null;let e=g.find(e=>e.id===w.id);if(!e)return null;let t=f[e.mood],o=m.filter(t=>t.from===e.id||t.to===e.id).map(t=>{let o=t.from===e.id?t.to:t.from,r=g.find(e=>e.id===o);return{name:r?.name??o,sentiment:t.sentiment,label:t.label}});return{agent:e,moodCfg:t,rels:o}},[w,g,m]),D=(0,u.useCallback)(e=>{t&&t(e.id)},[t]),R=(0,u.useCallback)(e=>{e.__dragging=!0,e.fx=e.x,e.fy=e.y},[]),M=(0,u.useCallback)(e=>{e.__dragging=!1,setTimeout(()=>{e.__dragging||(e.fx=void 0,e.fy=void 0)},300)},[]);return(0,h.jsxs)("div",{ref:r,className:"relative h-full w-full overflow-hidden",style:{backgroundColor:"var(--cyber-surface)"},onMouseMove:e=>{let t=r.current?.getBoundingClientRect();t&&C({x:e.clientX-t.left,y:e.clientY-t.top})},children:[(0,h.jsx)("div",{className:"pointer-events-none absolute inset-0 opacity-[0.04]",style:{backgroundImage:"linear-gradient(var(--cyber-glow) 1px, transparent 1px), linear-gradient(90deg, var(--cyber-glow) 1px, transparent 1px)",backgroundSize:"50px 50px"}}),(0,h.jsx)(K,{visible:!a||!c}),y&&s.width>0&&(0,h.jsx)(y,{ref:n,graphData:x,width:s.width,height:s.height,backgroundColor:"transparent",d3AlphaDecay:.005,d3VelocityDecay:.25,warmupTicks:0,cooldownTime:1/0,nodeCanvasObject:E,nodePointerAreaPaint:(e,t,o)=>{let r=e.x??0,n=e.y??0;o.fillStyle=t,o.beginPath(),o.arc(r,n,22,0,2*Math.PI),o.fill()},nodeLabel:()=>"",nodeVal:()=>1,onNodeHover:e=>{k(e||null),r.current&&(r.current.style.cursor=e?"pointer":"default")},onNodeClick:D,onNodeDrag:R,onNodeDragEnd:M,enableNodeDrag:!0,linkCanvasObject:P,linkDirectionalParticles:0,linkPointerAreaPaint:()=>{},enableZoomInteraction:!0,enablePanInteraction:!0,minZoom:.3,maxZoom:6}),w&&$&&(0,h.jsxs)("div",{className:"absolute z-40 pointer-events-none font-mono",style:{left:Math.min(S.x+18,s.width-230),top:Math.max(S.y-14,8),backgroundColor:"rgba(10,10,15,0.94)",border:"1px solid rgba(229,195,75,0.2)",padding:"10px 14px",minWidth:"180px",maxWidth:"240px"},children:[(0,h.jsxs)("div",{className:"flex items-center gap-2 mb-1.5",children:[(0,h.jsx)("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold",style:{backgroundColor:$.moodCfg.color+"25",color:$.moodCfg.color,border:`1px solid ${$.moodCfg.color}50`},children:$.agent.avatar}),(0,h.jsx)("span",{className:"text-sm",style:{color:"var(--cyber-glow)"},children:$.agent.name})]}),(0,h.jsxs)("div",{className:"text-[10px] flex items-center gap-1.5 mb-2",style:{color:$.moodCfg.color},children:[(0,h.jsx)("div",{className:"w-1.5 h-1.5 rounded-full",style:{backgroundColor:$.moodCfg.color}}),$.moodCfg.label,(0,h.jsx)("span",{style:{color:"var(--muted-foreground)",marginLeft:4},children:$.agent.traits.slice(0,2).join(", ")})]}),$.rels.length>0&&(0,h.jsxs)("div",{style:{borderTop:"1px solid rgba(229,195,75,0.1)"},className:"pt-1.5",children:[(0,h.jsx)("div",{className:"text-[9px] uppercase tracking-widest mb-1",style:{color:"var(--muted-foreground)"},children:"Связи"}),$.rels.map(e=>(0,h.jsxs)("div",{className:"flex items-center justify-between text-[10px] py-0.5",children:[(0,h.jsx)("span",{style:{color:"var(--foreground)"},children:e.name}),(0,h.jsx)("span",{style:{color:z(e.sentiment),fontSize:"9px"},children:e.label})]},e.name))]}),0===$.rels.length&&(0,h.jsx)("div",{className:"text-[10px] pt-1",style:{color:"var(--muted-foreground)",borderTop:"1px solid rgba(229,195,75,0.1)",paddingTop:6},children:"Нет связей с другими агентами"})]}),(0,h.jsx)(X,{})]})}let V=[0,2e3,1e4,3e4,null];class G{constructor(e){this._retryDelays=void 0!==e?[...e,null]:V}nextRetryDelayInMilliseconds(e){return this._retryDelays[e.previousRetryCount]}}class Q{}Q.Authorization="Authorization",Q.Cookie="Cookie";class Z{constructor(e,t,o){this.statusCode=e,this.statusText=t,this.content=o}}class Y{get(e,t){return this.send({...t,method:"GET",url:e})}post(e,t){return this.send({...t,method:"POST",url:e})}delete(e,t){return this.send({...t,method:"DELETE",url:e})}getCookieString(e){return""}}class ee extends Y{constructor(e,t){super(),this._innerClient=e,this._accessTokenFactory=t}async send(e){let t=!0;this._accessTokenFactory&&(!this._accessToken||e.url&&e.url.indexOf("/negotiate?")>0)&&(t=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(e);let o=await this._innerClient.send(e);return t&&401===o.statusCode&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(e),await this._innerClient.send(e)):o}_setAuthorizationHeader(e){e.headers||(e.headers={}),this._accessToken?e.headers[Q.Authorization]=`Bearer ${this._accessToken}`:this._accessTokenFactory&&e.headers[Q.Authorization]&&delete e.headers[Q.Authorization]}getCookieString(e){return this._innerClient.getCookieString(e)}}class et extends Error{constructor(e,t){const o=new.target.prototype;super(`${e}: Status code '${t}'`),this.statusCode=t,this.__proto__=o}}class eo extends Error{constructor(e="A timeout occurred."){const t=new.target.prototype;super(e),this.__proto__=t}}class er extends Error{constructor(e="An abort occurred."){const t=new.target.prototype;super(e),this.__proto__=t}}class en extends Error{constructor(e,t){const o=new.target.prototype;super(e),this.transport=t,this.errorType="UnsupportedTransportError",this.__proto__=o}}class es extends Error{constructor(e,t){const o=new.target.prototype;super(e),this.transport=t,this.errorType="DisabledTransportError",this.__proto__=o}}class ei extends Error{constructor(e,t){const o=new.target.prototype;super(e),this.transport=t,this.errorType="FailedToStartTransportError",this.__proto__=o}}class ea extends Error{constructor(e){const t=new.target.prototype;super(e),this.errorType="FailedToNegotiateWithServerError",this.__proto__=t}}class el extends Error{constructor(e,t){const o=new.target.prototype;super(e),this.innerErrors=t,this.__proto__=o}}(t=i||(i={}))[t.Trace=0]="Trace",t[t.Debug=1]="Debug",t[t.Information=2]="Information",t[t.Warning=3]="Warning",t[t.Error=4]="Error",t[t.Critical=5]="Critical",t[t.None=6]="None";class ec{log(e,t){}}ec.instance=new ec;class ed{static isRequired(e,t){if(null==e)throw Error(`The '${t}' argument is required.`)}static isNotEmpty(e,t){if(!e||e.match(/^\s*$/))throw Error(`The '${t}' argument should not be empty.`)}static isIn(e,t,o){if(!(e in t))throw Error(`Unknown ${o} value: ${e}.`)}}class eh{static get isBrowser(){return!eh.isNode&&"object"==typeof window&&"object"==typeof window.document}static get isWebWorker(){return!eh.isNode&&"object"==typeof self&&"importScripts"in self}static get isReactNative(){return!eh.isNode&&"object"==typeof window&&void 0===window.document}static get isNode(){return void 0!==m.default&&m.default.release&&"node"===m.default.release.name}}function eu(e,t){let o,r,n="";return eg(e)?(n=`Binary data of length ${e.byteLength}`,t&&(n+=`. Content: '${o=new Uint8Array(e),r="",o.forEach(e=>{let t=e<16?"0":"";r+=`0x${t}${e.toString(16)} `}),r.substr(0,r.length-1)}'`)):"string"==typeof e&&(n=`String data of length ${e.length}`,t&&(n+=`. Content: '${e}'`)),n}function eg(e){return e&&"u">typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}async function ep(e,t,o,r,n,s){let a={},[l,c]=eb();a[l]=c,e.log(i.Trace,`(${t} transport) sending data. ${eu(n,s.logMessageContent)}.`);let d=eg(n)?"arraybuffer":"text",h=await o.post(r,{content:n,headers:{...a,...s.headers},responseType:d,timeout:s.timeout,withCredentials:s.withCredentials});e.log(i.Trace,`(${t} transport) request complete. Response status: ${h.statusCode}.`)}class em{constructor(e,t){this._subject=e,this._observer=t}dispose(){let e=this._subject.observers.indexOf(this._observer);e>-1&&this._subject.observers.splice(e,1),0===this._subject.observers.length&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(e=>{})}}class ef{constructor(e){this._minLevel=e,this.out=console}log(e,t){if(e>=this._minLevel){let o=`[${new Date().toISOString()}] ${i[e]}: ${t}`;switch(e){case i.Critical:case i.Error:this.out.error(o);break;case i.Warning:this.out.warn(o);break;case i.Information:this.out.info(o);break;default:this.out.log(o)}}}}function eb(){var e,t,o,r;let n,s,i="X-SignalR-User-Agent";return eh.isNode&&(i="User-Agent"),[i,(e="8.0.17",t=function(){if(!eh.isNode)return"";switch(m.default.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return m.default.platform}}(),o=eh.isNode?"NodeJS":"Browser",r=function(){if(eh.isNode)return m.default.versions.node}(),n="Microsoft SignalR/",s=e.split("."),n+=`${s[0]}.${s[1]} (${e}; `,t&&""!==t?n+=`${t}; `:n+="Unknown OS; ",n+=`${o}`,r?n+=`; ${r}`:n+="; Unknown Runtime Version",n+=")")]}function ex(e){return e.stack?e.stack:e.message?e.message:`${e}`}class e_ extends Y{constructor(t){if(super(),this._logger=t,"u"<typeof fetch||eh.isNode){const t="function"==typeof __webpack_require__?__non_webpack_require__:e.z;this._jar=new(t("tough-cookie")).CookieJar,"u"<typeof fetch?this._fetchType=t("node-fetch"):this._fetchType=fetch,this._fetchType=t("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind("u">typeof globalThis?globalThis:"u">typeof self?self:"u">typeof window?window:e.g);if("u"<typeof AbortController){const t="function"==typeof __webpack_require__?__non_webpack_require__:e.z;this._abortControllerType=t("abort-controller")}else this._abortControllerType=AbortController}async send(e){let t,o;if(e.abortSignal&&e.abortSignal.aborted)throw new er;if(!e.method)throw Error("No method defined.");if(!e.url)throw Error("No url defined.");let r=new this._abortControllerType;e.abortSignal&&(e.abortSignal.onabort=()=>{r.abort(),t=new er});let n=null;e.timeout&&(n=setTimeout(()=>{r.abort(),this._logger.log(i.Warning,"Timeout from HTTP request."),t=new eo},e.timeout)),""===e.content&&(e.content=void 0),e.content&&(e.headers=e.headers||{},eg(e.content)?e.headers["Content-Type"]="application/octet-stream":e.headers["Content-Type"]="text/plain;charset=UTF-8");try{o=await this._fetchType(e.url,{body:e.content,cache:"no-cache",credentials:!0===e.withCredentials?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...e.headers},method:e.method,mode:"cors",redirect:"follow",signal:r.signal})}catch(e){if(t)throw t;throw this._logger.log(i.Warning,`Error from HTTP request. ${e}.`),e}finally{n&&clearTimeout(n),e.abortSignal&&(e.abortSignal.onabort=null)}if(!o.ok)throw new et(await ey(o,"text")||o.statusText,o.status);let s=ey(o,e.responseType),a=await s;return new Z(o.status,o.statusText,a)}getCookieString(e){let t="";return eh.isNode&&this._jar&&this._jar.getCookies(e,(e,o)=>t=o.join("; ")),t}}function ey(e,t){let o;switch(t){case"arraybuffer":o=e.arrayBuffer();break;case"text":default:o=e.text();break;case"blob":case"document":case"json":throw Error(`${t} is not supported.`)}return o}class ev extends Y{constructor(e){super(),this._logger=e}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new er):e.method?e.url?new Promise((t,o)=>{let r=new XMLHttpRequest;r.open(e.method,e.url,!0),r.withCredentials=void 0===e.withCredentials||e.withCredentials,r.setRequestHeader("X-Requested-With","XMLHttpRequest"),""===e.content&&(e.content=void 0),e.content&&(eg(e.content)?r.setRequestHeader("Content-Type","application/octet-stream"):r.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));let n=e.headers;n&&Object.keys(n).forEach(e=>{r.setRequestHeader(e,n[e])}),e.responseType&&(r.responseType=e.responseType),e.abortSignal&&(e.abortSignal.onabort=()=>{r.abort(),o(new er)}),e.timeout&&(r.timeout=e.timeout),r.onload=()=>{e.abortSignal&&(e.abortSignal.onabort=null),r.status>=200&&r.status<300?t(new Z(r.status,r.statusText,r.response||r.responseText)):o(new et(r.response||r.responseText||r.statusText,r.status))},r.onerror=()=>{this._logger.log(i.Warning,`Error from HTTP request. ${r.status}: ${r.statusText}.`),o(new et(r.statusText,r.status))},r.ontimeout=()=>{this._logger.log(i.Warning,"Timeout from HTTP request."),o(new eo)},r.send(e.content)}):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}}class ew extends Y{constructor(e){if(super(),"u">typeof fetch||eh.isNode)this._httpClient=new e_(e);else if("u">typeof XMLHttpRequest)this._httpClient=new ev(e);else throw Error("No usable HttpClient found.")}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new er):e.method?e.url?this._httpClient.send(e):Promise.reject(Error("No url defined.")):Promise.reject(Error("No method defined."))}getCookieString(e){return this._httpClient.getCookieString(e)}}(o=a||(a={}))[o.None=0]="None",o[o.WebSockets=1]="WebSockets",o[o.ServerSentEvents=2]="ServerSentEvents",o[o.LongPolling=4]="LongPolling",(r=l||(l={}))[r.Text=1]="Text",r[r.Binary=2]="Binary";class ek{constructor(){this._isAborted=!1,this.onabort=null}abort(){!this._isAborted&&(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}}class eS{get pollAborted(){return this._pollAbort.aborted}constructor(e,t,o){this._httpClient=e,this._logger=t,this._pollAbort=new ek,this._options=o,this._running=!1,this.onreceive=null,this.onclose=null}async connect(e,t){if(ed.isRequired(e,"url"),ed.isRequired(t,"transferFormat"),ed.isIn(t,l,"transferFormat"),this._url=e,this._logger.log(i.Trace,"(LongPolling transport) Connecting."),t===l.Binary&&"u">typeof XMLHttpRequest&&"string"!=typeof new XMLHttpRequest().responseType)throw Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");let[o,r]=eb(),n={[o]:r,...this._options.headers},s={abortSignal:this._pollAbort.signal,headers:n,timeout:1e5,withCredentials:this._options.withCredentials};t===l.Binary&&(s.responseType="arraybuffer");let a=`${e}&_=${Date.now()}`;this._logger.log(i.Trace,`(LongPolling transport) polling: ${a}.`);let c=await this._httpClient.get(a,s);200!==c.statusCode?(this._logger.log(i.Error,`(LongPolling transport) Unexpected response code: ${c.statusCode}.`),this._closeError=new et(c.statusText||"",c.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,s)}async _poll(e,t){try{for(;this._running;)try{let o=`${e}&_=${Date.now()}`;this._logger.log(i.Trace,`(LongPolling transport) polling: ${o}.`);let r=await this._httpClient.get(o,t);204===r.statusCode?(this._logger.log(i.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==r.statusCode?(this._logger.log(i.Error,`(LongPolling transport) Unexpected response code: ${r.statusCode}.`),this._closeError=new et(r.statusText||"",r.statusCode),this._running=!1):r.content?(this._logger.log(i.Trace,`(LongPolling transport) data received. ${eu(r.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(r.content)):this._logger.log(i.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(e){this._running?e instanceof eo?this._logger.log(i.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=e,this._running=!1):this._logger.log(i.Trace,`(LongPolling transport) Poll errored after shutdown: ${e.message}`)}}finally{this._logger.log(i.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(e){return this._running?ep(this._logger,"LongPolling",this._httpClient,this._url,e,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(i.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{let e;await this._receiving,this._logger.log(i.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);let t={},[o,r]=eb();t[o]=r;let n={headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};try{await this._httpClient.delete(this._url,n)}catch(t){e=t}e?e instanceof et&&(404===e.statusCode?this._logger.log(i.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(i.Trace,`(LongPolling transport) Error sending a DELETE request: ${e}`)):this._logger.log(i.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(i.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let e="(LongPolling transport) Firing onclose event.";this._closeError&&(e+=" Error: "+this._closeError),this._logger.log(i.Trace,e),this.onclose(this._closeError)}}}class eC{constructor(e,t,o,r){this._httpClient=e,this._accessToken=t,this._logger=o,this._options=r,this.onreceive=null,this.onclose=null}async connect(e,t){return ed.isRequired(e,"url"),ed.isRequired(t,"transferFormat"),ed.isIn(t,l,"transferFormat"),this._logger.log(i.Trace,"(SSE transport) Connecting."),this._url=e,this._accessToken&&(e+=(0>e.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(this._accessToken)}`),new Promise((o,r)=>{let n,s=!1;if(t!==l.Text)return void r(Error("The Server-Sent Events transport only supports the 'Text' transfer format"));if(eh.isBrowser||eh.isWebWorker)n=new this._options.EventSource(e,{withCredentials:this._options.withCredentials});else{let t=this._httpClient.getCookieString(e),o={};o.Cookie=t;let[r,s]=eb();o[r]=s,n=new this._options.EventSource(e,{withCredentials:this._options.withCredentials,headers:{...o,...this._options.headers}})}try{n.onmessage=e=>{if(this.onreceive)try{this._logger.log(i.Trace,`(SSE transport) data received. ${eu(e.data,this._options.logMessageContent)}.`),this.onreceive(e.data)}catch(e){this._close(e);return}},n.onerror=e=>{s?this._close():r(Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},n.onopen=()=>{this._logger.log(i.Information,`SSE connected to ${this._url}`),this._eventSource=n,s=!0,o()}}catch(e){r(e);return}})}async send(e){return this._eventSource?ep(this._logger,"SSE",this._httpClient,this._url,e,this._options):Promise.reject(Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(e){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(e))}}class ej{constructor(e,t,o,r,n,s){this._logger=o,this._accessTokenFactory=t,this._logMessageContent=r,this._webSocketConstructor=n,this._httpClient=e,this.onreceive=null,this.onclose=null,this._headers=s}async connect(e,t){let o;return ed.isRequired(e,"url"),ed.isRequired(t,"transferFormat"),ed.isIn(t,l,"transferFormat"),this._logger.log(i.Trace,"(WebSockets transport) Connecting."),this._accessTokenFactory&&(o=await this._accessTokenFactory()),new Promise((r,n)=>{let s;e=e.replace(/^http/,"ws");let a=this._httpClient.getCookieString(e),c=!1;if(eh.isNode||eh.isReactNative){let t={},[r,n]=eb();t[r]=n,o&&(t[Q.Authorization]=`Bearer ${o}`),a&&(t[Q.Cookie]=a),s=new this._webSocketConstructor(e,void 0,{headers:{...t,...this._headers}})}else o&&(e+=(0>e.indexOf("?")?"?":"&")+`access_token=${encodeURIComponent(o)}`);s||(s=new this._webSocketConstructor(e)),t===l.Binary&&(s.binaryType="arraybuffer"),s.onopen=t=>{this._logger.log(i.Information,`WebSocket connected to ${e}.`),this._webSocket=s,c=!0,r()},s.onerror=e=>{let t=null;t="u">typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"There was an error with the transport",this._logger.log(i.Information,`(WebSockets transport) ${t}.`)},s.onmessage=e=>{if(this._logger.log(i.Trace,`(WebSockets transport) data received. ${eu(e.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(e.data)}catch(e){this._close(e);return}},s.onclose=e=>{if(c)this._close(e);else n(Error("u">typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled."))}})}send(e){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(i.Trace,`(WebSockets transport) sending data. ${eu(e,this._logMessageContent)}.`),this._webSocket.send(e),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(e){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(i.Trace,"(WebSockets transport) socket closed."),this.onclose&&(this._isCloseEvent(e)&&(!1===e.wasClean||1e3!==e.code)?this.onclose(Error(`WebSocket closed with status code: ${e.code} (${e.reason||"no reason given"}).`)):e instanceof Error?this.onclose(e):this.onclose())}_isCloseEvent(e){return e&&"boolean"==typeof e.wasClean&&"number"==typeof e.code}}class eN{constructor(t,o={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,ed.isRequired(t,"url"),this._logger=function(e){return void 0===e?new ef(i.Information):null===e?ec.instance:void 0!==e.log?e:new ef(e)}(o.logger),this.baseUrl=this._resolveUrl(t),(o=o||{}).logMessageContent=void 0!==o.logMessageContent&&o.logMessageContent,"boolean"==typeof o.withCredentials||void 0===o.withCredentials)o.withCredentials=void 0===o.withCredentials||o.withCredentials;else throw Error("withCredentials option was not a 'boolean' or 'undefined' value");o.timeout=void 0===o.timeout?1e5:o.timeout;let r=null,n=null;if(eh.isNode&&1){const t="function"==typeof __webpack_require__?__non_webpack_require__:e.z;r=t("ws"),n=t("eventsource")}!eh.isNode&&"u">typeof WebSocket&&!o.WebSocket?o.WebSocket=WebSocket:eh.isNode&&!o.WebSocket&&r&&(o.WebSocket=r),!eh.isNode&&"u">typeof EventSource&&!o.EventSource?o.EventSource=EventSource:eh.isNode&&!o.EventSource&&void 0!==n&&(o.EventSource=n),this._httpClient=new ee(o.httpClient||new ew(this._logger),o.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=o,this.onreceive=null,this.onclose=null}async start(e){if(e=e||l.Binary,ed.isIn(e,l,"transferFormat"),this._logger.log(i.Debug,`Starting connection with transfer format '${l[e]}'.`),"Disconnected"!==this._connectionState)return Promise.reject(Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(e),await this._startInternalPromise,"Disconnecting"===this._connectionState){let e="Failed to start the HttpConnection before stop() was called.";return this._logger.log(i.Error,e),await this._stopPromise,Promise.reject(new er(e))}if("Connected"!==this._connectionState){let e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(i.Error,e),Promise.reject(new er(e))}this._connectionStarted=!0}send(e){return"Connected"!==this._connectionState?Promise.reject(Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new eT(this.transport)),this._sendQueue.send(e))}async stop(e){return"Disconnected"===this._connectionState?(this._logger.log(i.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnected state.`),Promise.resolve()):"Disconnecting"===this._connectionState?(this._logger.log(i.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):void(this._connectionState="Disconnecting",this._stopPromise=new Promise(e=>{this._stopPromiseResolver=e}),await this._stopInternal(e),await this._stopPromise)}async _stopInternal(e){this._stopError=e;try{await this._startInternalPromise}catch(e){}if(this.transport){try{await this.transport.stop()}catch(e){this._logger.log(i.Error,`HttpConnection.transport.stop() threw error '${e}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(i.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(e){let t=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation)if(this._options.transport===a.WebSockets)this.transport=this._constructTransport(a.WebSockets),await this._startTransport(t,e);else throw Error("Negotiation can only be skipped when using the WebSocket transport directly.");else{let o=null,r=0;do{if(o=await this._getNegotiationResponse(t),"Disconnecting"===this._connectionState||"Disconnected"===this._connectionState)throw new er("The connection was stopped during negotiation.");if(o.error)throw Error(o.error);if(o.ProtocolVersion)throw Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(o.url&&(t=o.url),o.accessToken){let e=o.accessToken;this._accessTokenFactory=()=>e,this._httpClient._accessToken=e,this._httpClient._accessTokenFactory=void 0}r++}while(o.url&&r<100)if(100===r&&o.url)throw Error("Negotiate redirection limit exceeded.");await this._createTransport(t,this._options.transport,o,e)}this.transport instanceof eS&&(this.features.inherentKeepAlive=!0),"Connecting"===this._connectionState&&(this._logger.log(i.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(e){return this._logger.log(i.Error,"Failed to start the connection: "+e),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(e)}}async _getNegotiationResponse(e){let t={},[o,r]=eb();t[o]=r;let n=this._resolveNegotiateUrl(e);this._logger.log(i.Debug,`Sending negotiation request: ${n}.`);try{let e=await this._httpClient.post(n,{content:"",headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(200!==e.statusCode)return Promise.reject(Error(`Unexpected status code returned from negotiate '${e.statusCode}'`));let o=JSON.parse(e.content);if((!o.negotiateVersion||o.negotiateVersion<1)&&(o.connectionToken=o.connectionId),o.useStatefulReconnect&&!0!==this._options._useStatefulReconnect)return Promise.reject(new ea("Client didn't negotiate Stateful Reconnect but the server did."));return o}catch(t){let e="Failed to complete negotiation with the server: "+t;return t instanceof et&&404===t.statusCode&&(e+=" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(i.Error,e),Promise.reject(new ea(e))}}_createConnectUrl(e,t){return t?e+(-1===e.indexOf("?")?"?":"&")+`id=${t}`:e}async _createTransport(e,t,o,r){let n=this._createConnectUrl(e,o.connectionToken);if(this._isITransport(t)){this._logger.log(i.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=t,await this._startTransport(n,r),this.connectionId=o.connectionId;return}let s=[],l=o.availableTransports||[],c=o;for(let o of l){let l=this._resolveTransportOrError(o,t,r,(null==c?void 0:c.useStatefulReconnect)===!0);if(l instanceof Error)s.push(`${o.transport} failed:`),s.push(l);else if(this._isITransport(l)){if(this.transport=l,!c){try{c=await this._getNegotiationResponse(e)}catch(e){return Promise.reject(e)}n=this._createConnectUrl(e,c.connectionToken)}try{await this._startTransport(n,r),this.connectionId=c.connectionId;return}catch(e){if(this._logger.log(i.Error,`Failed to start the transport '${o.transport}': ${e}`),c=void 0,s.push(new ei(`${o.transport} failed: ${e}`,a[o.transport])),"Connecting"!==this._connectionState){let e="Failed to select transport before stop() was called.";return this._logger.log(i.Debug,e),Promise.reject(new er(e))}}}}return s.length>0?Promise.reject(new el(`Unable to connect to the server with any of the available transports. ${s.join(" ")}`,s)):Promise.reject(Error("None of the transports supported by the client are supported by the server."))}_constructTransport(e){switch(e){case a.WebSockets:if(!this._options.WebSocket)throw Error("'WebSocket' is not supported in your environment.");return new ej(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case a.ServerSentEvents:if(!this._options.EventSource)throw Error("'EventSource' is not supported in your environment.");return new eC(this._httpClient,this._httpClient._accessToken,this._logger,this._options);case a.LongPolling:return new eS(this._httpClient,this._logger,this._options);default:throw Error(`Unknown transport: ${e}.`)}}_startTransport(e,t){return this.transport.onreceive=this.onreceive,this.features.reconnect?this.transport.onclose=async o=>{let r=!1;if(!this.features.reconnect)return void this._stopConnection(o);try{this.features.disconnected(),await this.transport.connect(e,t),await this.features.resend()}catch{r=!0}r&&this._stopConnection(o)}:this.transport.onclose=e=>this._stopConnection(e),this.transport.connect(e,t)}_resolveTransportOrError(e,t,o,r){var n,s;let c=a[e.transport];if(null==c)return this._logger.log(i.Debug,`Skipping transport '${e.transport}' because it is not supported by this client.`),Error(`Skipping transport '${e.transport}' because it is not supported by this client.`);if(n=t,s=c,n&&(s&n)==0)return this._logger.log(i.Debug,`Skipping transport '${a[c]}' because it was disabled by the client.`),new es(`'${a[c]}' is disabled by the client.`,c);if(!(e.transferFormats.map(e=>l[e]).indexOf(o)>=0))return this._logger.log(i.Debug,`Skipping transport '${a[c]}' because it does not support the requested transfer format '${l[o]}'.`),Error(`'${a[c]}' does not support ${l[o]}.`);if(c===a.WebSockets&&!this._options.WebSocket||c===a.ServerSentEvents&&!this._options.EventSource)return this._logger.log(i.Debug,`Skipping transport '${a[c]}' because it is not supported in your environment.'`),new en(`'${a[c]}' is not supported in your environment.`,c);this._logger.log(i.Debug,`Selecting transport '${a[c]}'.`);try{return this.features.reconnect=c===a.WebSockets?r:void 0,this._constructTransport(c)}catch(e){return e}}_isITransport(e){return e&&"object"==typeof e&&"connect"in e}_stopConnection(e){if(this._logger.log(i.Debug,`HttpConnection.stopConnection(${e}) called while in state ${this._connectionState}.`),this.transport=void 0,e=this._stopError||e,this._stopError=void 0,"Disconnected"===this._connectionState)return void this._logger.log(i.Debug,`Call to HttpConnection.stopConnection(${e}) was ignored because the connection is already in the disconnected state.`);if("Connecting"===this._connectionState)throw this._logger.log(i.Warning,`Call to HttpConnection.stopConnection(${e}) was ignored because the connection is still in the connecting state.`),Error(`HttpConnection.stopConnection(${e}) was called while the connection is still in the connecting state.`);if("Disconnecting"===this._connectionState&&this._stopPromiseResolver(),e?this._logger.log(i.Error,`Connection disconnected with error '${e}'.`):this._logger.log(i.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(e=>{this._logger.log(i.Error,`TransportSendQueue.stop() threw error '${e}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(e)}catch(t){this._logger.log(i.Error,`HttpConnection.onclose(${e}) threw error '${t}'.`)}}}_resolveUrl(e){if(0===e.lastIndexOf("https://",0)||0===e.lastIndexOf("http://",0))return e;if(!eh.isBrowser)throw Error(`Cannot resolve '${e}'.`);let t=window.document.createElement("a");return t.href=e,this._logger.log(i.Information,`Normalizing '${e}' to '${t.href}'.`),t.href}_resolveNegotiateUrl(e){let t=new URL(e);t.pathname.endsWith("/")?t.pathname+="negotiate":t.pathname+="/negotiate";let o=new URLSearchParams(t.searchParams);return o.has("negotiateVersion")||o.append("negotiateVersion",this._negotiateVersion.toString()),o.has("useStatefulReconnect")?"true"===o.get("useStatefulReconnect")&&(this._options._useStatefulReconnect=!0):!0===this._options._useStatefulReconnect&&o.append("useStatefulReconnect","true"),t.search=o.toString(),t.toString()}}class eT{constructor(e){this._transport=e,this._buffer=[],this._executing=!0,this._sendBufferedData=new eI,this._transportResult=new eI,this._sendLoopPromise=this._sendLoop()}send(e){return this._bufferData(e),this._transportResult||(this._transportResult=new eI),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(e){if(this._buffer.length&&typeof this._buffer[0]!=typeof e)throw Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof e}`);this._buffer.push(e),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new eI;let e=this._transportResult;this._transportResult=void 0;let t="string"==typeof this._buffer[0]?this._buffer.join(""):eT._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(t),e.resolve()}catch(t){e.reject(t)}}}static _concatBuffers(e){let t=new Uint8Array(e.map(e=>e.byteLength).reduce((e,t)=>e+t)),o=0;for(let r of e)t.set(new Uint8Array(r),o),o+=r.byteLength;return t.buffer}}class eI{constructor(){this.promise=new Promise((e,t)=>([this._resolver,this._rejecter]=[e,t]))}resolve(){this._resolver()}reject(e){this._rejecter(e)}}class eE{static write(e){return`${e}${eE.RecordSeparator}`}static parse(e){if(e[e.length-1]!==eE.RecordSeparator)throw Error("Message is incomplete.");let t=e.split(eE.RecordSeparator);return t.pop(),t}}eE.RecordSeparatorCode=30,eE.RecordSeparator=String.fromCharCode(eE.RecordSeparatorCode);class eP{writeHandshakeRequest(e){return eE.write(JSON.stringify(e))}parseHandshakeResponse(e){let t,o;if(eg(e)){let r=new Uint8Array(e),n=r.indexOf(eE.RecordSeparatorCode);if(-1===n)throw Error("Message is incomplete.");let s=n+1;t=String.fromCharCode.apply(null,Array.prototype.slice.call(r.slice(0,s))),o=r.byteLength>s?r.slice(s).buffer:null}else{let r=e.indexOf(eE.RecordSeparator);if(-1===r)throw Error("Message is incomplete.");let n=r+1;t=e.substring(0,n),o=e.length>n?e.substring(n):null}let r=JSON.parse(eE.parse(t)[0]);if(r.type)throw Error("Expected a handshake response from the server.");return[o,r]}}(n=c||(c={}))[n.Invocation=1]="Invocation",n[n.StreamItem=2]="StreamItem",n[n.Completion=3]="Completion",n[n.StreamInvocation=4]="StreamInvocation",n[n.CancelInvocation=5]="CancelInvocation",n[n.Ping=6]="Ping",n[n.Close=7]="Close",n[n.Ack=8]="Ack",n[n.Sequence=9]="Sequence";class e${constructor(){this.observers=[]}next(e){for(let t of this.observers)t.next(e)}error(e){for(let t of this.observers)t.error&&t.error(e)}complete(){for(let e of this.observers)e.complete&&e.complete()}subscribe(e){return this.observers.push(e),new em(this,e)}}class eD{constructor(e,t,o){this._bufferSize=1e5,this._messages=[],this._totalMessageCount=0,this._waitForSequenceMessage=!1,this._nextReceivingSequenceId=1,this._latestReceivedSequenceId=0,this._bufferedByteCount=0,this._reconnectInProgress=!1,this._protocol=e,this._connection=t,this._bufferSize=o}async _send(e){let t=this._protocol.writeMessage(e),o=Promise.resolve();if(this._isInvocationMessage(e)){this._totalMessageCount++;let e=()=>{},r=()=>{};eg(t)?this._bufferedByteCount+=t.byteLength:this._bufferedByteCount+=t.length,this._bufferedByteCount>=this._bufferSize&&(o=new Promise((t,o)=>{e=t,r=o})),this._messages.push(new eR(t,this._totalMessageCount,e,r))}try{this._reconnectInProgress||await this._connection.send(t)}catch{this._disconnected()}await o}_ack(e){let t=-1;for(let o=0;o<this._messages.length;o++){let r=this._messages[o];if(r._id<=e.sequenceId)t=o,eg(r._message)?this._bufferedByteCount-=r._message.byteLength:this._bufferedByteCount-=r._message.length,r._resolver();else if(this._bufferedByteCount<this._bufferSize)r._resolver();else break}-1!==t&&(this._messages=this._messages.slice(t+1))}_shouldProcessMessage(e){if(this._waitForSequenceMessage)if(e.type!==c.Sequence)return!1;else return this._waitForSequenceMessage=!1,!0;if(!this._isInvocationMessage(e))return!0;let t=this._nextReceivingSequenceId;return(this._nextReceivingSequenceId++,t<=this._latestReceivedSequenceId)?(t===this._latestReceivedSequenceId&&this._ackTimer(),!1):(this._latestReceivedSequenceId=t,this._ackTimer(),!0)}_resetSequence(e){e.sequenceId>this._nextReceivingSequenceId?this._connection.stop(Error("Sequence ID greater than amount of messages we've received.")):this._nextReceivingSequenceId=e.sequenceId}_disconnected(){this._reconnectInProgress=!0,this._waitForSequenceMessage=!0}async _resend(){let e=0!==this._messages.length?this._messages[0]._id:this._totalMessageCount+1;for(let t of(await this._connection.send(this._protocol.writeMessage({type:c.Sequence,sequenceId:e})),this._messages))await this._connection.send(t._message);this._reconnectInProgress=!1}_dispose(e){for(let t of(null!=e||(e=Error("Unable to reconnect to server.")),this._messages))t._rejector(e)}_isInvocationMessage(e){switch(e.type){case c.Invocation:case c.StreamItem:case c.Completion:case c.StreamInvocation:case c.CancelInvocation:return!0;case c.Close:case c.Sequence:case c.Ping:case c.Ack:return!1}}_ackTimer(){void 0===this._ackTimerHandle&&(this._ackTimerHandle=setTimeout(async()=>{try{this._reconnectInProgress||await this._connection.send(this._protocol.writeMessage({type:c.Ack,sequenceId:this._latestReceivedSequenceId}))}catch{}clearTimeout(this._ackTimerHandle),this._ackTimerHandle=void 0},1e3))}}class eR{constructor(e,t,o,r){this._message=e,this._id=t,this._resolver=o,this._rejector=r}}(s=d||(d={})).Disconnected="Disconnected",s.Connecting="Connecting",s.Connected="Connected",s.Disconnecting="Disconnecting",s.Reconnecting="Reconnecting";class eM{static create(e,t,o,r,n,s,i){return new eM(e,t,o,r,n,s,i)}constructor(e,t,o,r,n,s,a){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(i.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://learn.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},ed.isRequired(e,"connection"),ed.isRequired(t,"logger"),ed.isRequired(o,"protocol"),this.serverTimeoutInMilliseconds=null!=n?n:3e4,this.keepAliveIntervalInMilliseconds=null!=s?s:15e3,this._statefulReconnectBufferSize=null!=a?a:1e5,this._logger=t,this._protocol=o,this.connection=e,this._reconnectPolicy=r,this._handshakeProtocol=new eP,this.connection.onreceive=e=>this._processIncomingData(e),this.connection.onclose=e=>this._connectionClosed(e),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=d.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:c.Ping})}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(e){if(this._connectionState!==d.Disconnected&&this._connectionState!==d.Reconnecting)throw Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!e)throw Error("The HubConnection url must be a valid url.");this.connection.baseUrl=e}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==d.Disconnected)return Promise.reject(Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=d.Connecting,this._logger.log(i.Debug,"Starting HubConnection.");try{await this._startInternal(),eh.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=d.Connected,this._connectionStarted=!0,this._logger.log(i.Debug,"HubConnection connected successfully.")}catch(e){return this._connectionState=d.Disconnected,this._logger.log(i.Debug,`HubConnection failed to start successfully because of error '${e}'.`),Promise.reject(e)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;let e=new Promise((e,t)=>{this._handshakeResolver=e,this._handshakeRejecter=t});await this.connection.start(this._protocol.transferFormat);try{let t=this._protocol.version;this.connection.features.reconnect||(t=1);let o={protocol:this._protocol.name,version:t};if(this._logger.log(i.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(o)),this._logger.log(i.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await e,this._stopDuringStartError)throw this._stopDuringStartError;(this.connection.features.reconnect||0)&&(this._messageBuffer=new eD(this._protocol,this.connection,this._statefulReconnectBufferSize),this.connection.features.disconnected=this._messageBuffer._disconnected.bind(this._messageBuffer),this.connection.features.resend=()=>{if(this._messageBuffer)return this._messageBuffer._resend()}),this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(e){throw this._logger.log(i.Debug,`Hub handshake failed with error '${e}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(e),e}}async stop(){let e=this._startPromise;this.connection.features.reconnect=!1,this._stopPromise=this._stopInternal(),await this._stopPromise;try{await e}catch(e){}}_stopInternal(e){if(this._connectionState===d.Disconnected)return this._logger.log(i.Debug,`Call to HubConnection.stop(${e}) ignored because it is already in the disconnected state.`),Promise.resolve();if(this._connectionState===d.Disconnecting)return this._logger.log(i.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;let t=this._connectionState;return(this._connectionState=d.Disconnecting,this._logger.log(i.Debug,"Stopping HubConnection."),this._reconnectDelayHandle)?(this._logger.log(i.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(t===d.Connected&&this._sendCloseMessage(),this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=e||new er("The connection was stopped before the hub handshake could complete."),this.connection.stop(e))}async _sendCloseMessage(){try{await this._sendWithProtocol(this._createCloseMessage())}catch{}}stream(e,...t){let o,[r,n]=this._replaceStreamingParams(t),s=this._createStreamInvocation(e,t,n),i=new e$;return i.cancelCallback=()=>{let e=this._createCancelInvocation(s.invocationId);return delete this._callbacks[s.invocationId],o.then(()=>this._sendWithProtocol(e))},this._callbacks[s.invocationId]=(e,t)=>{t?i.error(t):e&&(e.type===c.Completion?e.error?i.error(Error(e.error)):i.complete():i.next(e.item))},o=this._sendWithProtocol(s).catch(e=>{i.error(e),delete this._callbacks[s.invocationId]}),this._launchStreams(r,o),i}_sendMessage(e){return this._resetKeepAliveInterval(),this.connection.send(e)}_sendWithProtocol(e){return this._messageBuffer?this._messageBuffer._send(e):this._sendMessage(this._protocol.writeMessage(e))}send(e,...t){let[o,r]=this._replaceStreamingParams(t),n=this._sendWithProtocol(this._createInvocation(e,t,!0,r));return this._launchStreams(o,n),n}invoke(e,...t){let[o,r]=this._replaceStreamingParams(t),n=this._createInvocation(e,t,!1,r);return new Promise((e,t)=>{this._callbacks[n.invocationId]=(o,r)=>{r?t(r):o&&(o.type===c.Completion?o.error?t(Error(o.error)):e(o.result):t(Error(`Unexpected message type: ${o.type}`)))};let r=this._sendWithProtocol(n).catch(e=>{t(e),delete this._callbacks[n.invocationId]});this._launchStreams(o,r)})}on(e,t){e&&t&&(e=e.toLowerCase(),this._methods[e]||(this._methods[e]=[]),-1===this._methods[e].indexOf(t)&&this._methods[e].push(t))}off(e,t){if(!e)return;e=e.toLowerCase();let o=this._methods[e];if(o)if(t){let r=o.indexOf(t);-1!==r&&(o.splice(r,1),0===o.length&&delete this._methods[e])}else delete this._methods[e]}onclose(e){e&&this._closedCallbacks.push(e)}onreconnecting(e){e&&this._reconnectingCallbacks.push(e)}onreconnected(e){e&&this._reconnectedCallbacks.push(e)}_processIncomingData(e){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(e=this._processHandshakeResponse(e),this._receivedHandshakeResponse=!0),e){for(let t of this._protocol.parseMessages(e,this._logger))if(!this._messageBuffer||this._messageBuffer._shouldProcessMessage(t))switch(t.type){case c.Invocation:this._invokeClientMethod(t).catch(e=>{this._logger.log(i.Error,`Invoke client method threw error: ${ex(e)}`)});break;case c.StreamItem:case c.Completion:{let e=this._callbacks[t.invocationId];if(e){t.type===c.Completion&&delete this._callbacks[t.invocationId];try{e(t)}catch(e){this._logger.log(i.Error,`Stream callback threw error: ${ex(e)}`)}}break}case c.Ping:break;case c.Close:{this._logger.log(i.Information,"Close message received from server.");let e=t.error?Error("Server returned an error on close: "+t.error):void 0;!0===t.allowReconnect?this.connection.stop(e):this._stopPromise=this._stopInternal(e);break}case c.Ack:this._messageBuffer&&this._messageBuffer._ack(t);break;case c.Sequence:this._messageBuffer&&this._messageBuffer._resetSequence(t);break;default:this._logger.log(i.Warning,`Invalid message type: ${t.type}.`)}}this._resetTimeoutPeriod()}_processHandshakeResponse(e){let t,o;try{[o,t]=this._handshakeProtocol.parseHandshakeResponse(e)}catch(o){let e="Error parsing handshake response: "+o;this._logger.log(i.Error,e);let t=Error(e);throw this._handshakeRejecter(t),t}if(t.error){let e="Server returned handshake error: "+t.error;this._logger.log(i.Error,e);let o=Error(e);throw this._handshakeRejecter(o),o}return this._logger.log(i.Debug,"Server handshake complete."),this._handshakeResolver(),o}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=new Date().getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if((!this.connection.features||!this.connection.features.inherentKeepAlive)&&(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),void 0===this._pingServerHandle)){let e=this._nextKeepAlive-new Date().getTime();e<0&&(e=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===d.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},e)}}serverTimeout(){this.connection.stop(Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(e){let t,o,r,n=e.target.toLowerCase(),s=this._methods[n];if(!s){this._logger.log(i.Warning,`No client method with the name '${n}' found.`),e.invocationId&&(this._logger.log(i.Warning,`No result given for '${n}' method and invocation ID '${e.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(e.invocationId,"Client didn't provide a result.",null)));return}let a=s.slice(),l=!!e.invocationId;for(let s of a)try{let a=t;t=await s.apply(this,e.arguments),l&&t&&a&&(this._logger.log(i.Error,`Multiple results provided for '${n}'. Sending error to server.`),r=this._createCompletionMessage(e.invocationId,"Client provided multiple results.",null)),o=void 0}catch(e){o=e,this._logger.log(i.Error,`A callback for the method '${n}' threw error '${e}'.`)}r?await this._sendWithProtocol(r):l?(o?r=this._createCompletionMessage(e.invocationId,`${o}`,null):void 0!==t?r=this._createCompletionMessage(e.invocationId,null,t):(this._logger.log(i.Warning,`No result given for '${n}' method and invocation ID '${e.invocationId}'.`),r=this._createCompletionMessage(e.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(r)):t&&this._logger.log(i.Error,`Result given for '${n}' method but server is not expecting a result.`)}_connectionClosed(e){this._logger.log(i.Debug,`HubConnection.connectionClosed(${e}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||e||new er("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(e||Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===d.Disconnecting?this._completeClose(e):this._connectionState===d.Connected&&this._reconnectPolicy?this._reconnect(e):this._connectionState===d.Connected&&this._completeClose(e)}_completeClose(e){if(this._connectionStarted){this._connectionState=d.Disconnected,this._connectionStarted=!1,this._messageBuffer&&(this._messageBuffer._dispose(null!=e?e:Error("Connection closed.")),this._messageBuffer=void 0),eh.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(t=>t.apply(this,[e]))}catch(t){this._logger.log(i.Error,`An onclose callback called with error '${e}' threw error '${t}'.`)}}}async _reconnect(e){let t=Date.now(),o=0,r=void 0!==e?e:Error("Attempting to reconnect due to a unknown error."),n=this._getNextRetryDelay(o++,0,r);if(null===n){this._logger.log(i.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(e);return}if(this._connectionState=d.Reconnecting,e?this._logger.log(i.Information,`Connection reconnecting because of error '${e}'.`):this._logger.log(i.Information,"Connection reconnecting."),0!==this._reconnectingCallbacks.length){try{this._reconnectingCallbacks.forEach(t=>t.apply(this,[e]))}catch(t){this._logger.log(i.Error,`An onreconnecting callback called with error '${e}' threw error '${t}'.`)}if(this._connectionState!==d.Reconnecting)return void this._logger.log(i.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.")}for(;null!==n;){if(this._logger.log(i.Information,`Reconnect attempt number ${o} will start in ${n} ms.`),await new Promise(e=>{this._reconnectDelayHandle=setTimeout(e,n)}),this._reconnectDelayHandle=void 0,this._connectionState!==d.Reconnecting)return void this._logger.log(i.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");try{if(await this._startInternal(),this._connectionState=d.Connected,this._logger.log(i.Information,"HubConnection reconnected successfully."),0!==this._reconnectedCallbacks.length)try{this._reconnectedCallbacks.forEach(e=>e.apply(this,[this.connection.connectionId]))}catch(e){this._logger.log(i.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${e}'.`)}return}catch(e){if(this._logger.log(i.Information,`Reconnect attempt failed because of error '${e}'.`),this._connectionState!==d.Reconnecting){this._logger.log(i.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),this._connectionState===d.Disconnecting&&this._completeClose();return}r=e instanceof Error?e:Error(e.toString()),n=this._getNextRetryDelay(o++,Date.now()-t,r)}}this._logger.log(i.Information,`Reconnect retries have been exhausted after ${Date.now()-t} ms and ${o} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(e,t,o){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:t,previousRetryCount:e,retryReason:o})}catch(o){return this._logger.log(i.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${e}, ${t}) threw error '${o}'.`),null}}_cancelCallbacksWithError(e){let t=this._callbacks;this._callbacks={},Object.keys(t).forEach(o=>{let r=t[o];try{r(null,e)}catch(t){this._logger.log(i.Error,`Stream 'error' callback called with '${e}' threw error: ${ex(t)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(e,t,o,r){if(o)if(0!==r.length)return{arguments:t,streamIds:r,target:e,type:c.Invocation};else return{arguments:t,target:e,type:c.Invocation};{let o=this._invocationId;return(this._invocationId++,0!==r.length)?{arguments:t,invocationId:o.toString(),streamIds:r,target:e,type:c.Invocation}:{arguments:t,invocationId:o.toString(),target:e,type:c.Invocation}}}_launchStreams(e,t){if(0!==e.length)for(let o in t||(t=Promise.resolve()),e)e[o].subscribe({complete:()=>{t=t.then(()=>this._sendWithProtocol(this._createCompletionMessage(o)))},error:e=>{let r;r=e instanceof Error?e.message:e&&e.toString?e.toString():"Unknown error",t=t.then(()=>this._sendWithProtocol(this._createCompletionMessage(o,r)))},next:e=>{t=t.then(()=>this._sendWithProtocol(this._createStreamItemMessage(o,e)))}})}_replaceStreamingParams(e){let t=[],o=[];for(let r=0;r<e.length;r++){let n=e[r];if(this._isObservable(n)){let s=this._invocationId;this._invocationId++,t[s]=n,o.push(s.toString()),e.splice(r,1)}}return[t,o]}_isObservable(e){return e&&e.subscribe&&"function"==typeof e.subscribe}_createStreamInvocation(e,t,o){let r=this._invocationId;return(this._invocationId++,0!==o.length)?{arguments:t,invocationId:r.toString(),streamIds:o,target:e,type:c.StreamInvocation}:{arguments:t,invocationId:r.toString(),target:e,type:c.StreamInvocation}}_createCancelInvocation(e){return{invocationId:e,type:c.CancelInvocation}}_createStreamItemMessage(e,t){return{invocationId:e,item:t,type:c.StreamItem}}_createCompletionMessage(e,t,o){return t?{error:t,invocationId:e,type:c.Completion}:{invocationId:e,result:o,type:c.Completion}}_createCloseMessage(){return{type:c.Close}}}class eA{constructor(){this.name="json",this.version=2,this.transferFormat=l.Text}parseMessages(e,t){if("string"!=typeof e)throw Error("Invalid input for JSON hub protocol. Expected a string.");if(!e)return[];null===t&&(t=ec.instance);let o=eE.parse(e),r=[];for(let e of o){let o=JSON.parse(e);if("number"!=typeof o.type)throw Error("Invalid payload.");switch(o.type){case c.Invocation:this._isInvocationMessage(o);break;case c.StreamItem:this._isStreamItemMessage(o);break;case c.Completion:this._isCompletionMessage(o);break;case c.Ping:case c.Close:break;case c.Ack:this._isAckMessage(o);break;case c.Sequence:this._isSequenceMessage(o);break;default:t.log(i.Information,"Unknown message type '"+o.type+"' ignored.");continue}r.push(o)}return r}writeMessage(e){return eE.write(JSON.stringify(e))}_isInvocationMessage(e){this._assertNotEmptyString(e.target,"Invalid payload for Invocation message."),void 0!==e.invocationId&&this._assertNotEmptyString(e.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(e){if(this._assertNotEmptyString(e.invocationId,"Invalid payload for StreamItem message."),void 0===e.item)throw Error("Invalid payload for StreamItem message.")}_isCompletionMessage(e){if(e.result&&e.error)throw Error("Invalid payload for Completion message.");!e.result&&e.error&&this._assertNotEmptyString(e.error,"Invalid payload for Completion message."),this._assertNotEmptyString(e.invocationId,"Invalid payload for Completion message.")}_isAckMessage(e){if("number"!=typeof e.sequenceId)throw Error("Invalid SequenceId for Ack message.")}_isSequenceMessage(e){if("number"!=typeof e.sequenceId)throw Error("Invalid SequenceId for Sequence message.")}_assertNotEmptyString(e,t){if("string"!=typeof e||""===e)throw Error(t)}}let eL={trace:i.Trace,debug:i.Debug,info:i.Information,information:i.Information,warn:i.Warning,warning:i.Warning,error:i.Error,critical:i.Critical,none:i.None};class eW{configureLogging(e){if(ed.isRequired(e,"logging"),void 0!==e.log)this.logger=e;else if("string"==typeof e){let t=function(e){let t=eL[e.toLowerCase()];if(void 0!==t)return t;throw Error(`Unknown log level: ${e}`)}(e);this.logger=new ef(t)}else this.logger=new ef(e);return this}withUrl(e,t){return ed.isRequired(e,"url"),ed.isNotEmpty(e,"url"),this.url=e,"object"==typeof t?this.httpConnectionOptions={...this.httpConnectionOptions,...t}:this.httpConnectionOptions={...this.httpConnectionOptions,transport:t},this}withHubProtocol(e){return ed.isRequired(e,"protocol"),this.protocol=e,this}withAutomaticReconnect(e){if(this.reconnectPolicy)throw Error("A reconnectPolicy has already been set.");return e?Array.isArray(e)?this.reconnectPolicy=new G(e):this.reconnectPolicy=e:this.reconnectPolicy=new G,this}withServerTimeout(e){return ed.isRequired(e,"milliseconds"),this._serverTimeoutInMilliseconds=e,this}withKeepAliveInterval(e){return ed.isRequired(e,"milliseconds"),this._keepAliveIntervalInMilliseconds=e,this}withStatefulReconnect(e){return void 0===this.httpConnectionOptions&&(this.httpConnectionOptions={}),this.httpConnectionOptions._useStatefulReconnect=!0,this._statefulReconnectBufferSize=null==e?void 0:e.bufferSize,this}build(){let e=this.httpConnectionOptions||{};if(void 0===e.logger&&(e.logger=this.logger),!this.url)throw Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");let t=new eN(this.url,e);return eM.create(t,this.logger||ec.instance,this.protocol||new eA,this.reconnectPolicy,this._serverTimeoutInMilliseconds,this._keepAliveIntervalInMilliseconds,this._statefulReconnectBufferSize)}}let eq=["events.updated","agents.list.updated","agent.status.changed","agent.message","agent.progress","agent.thought","agent.error"],eO={chat:{label:"ЧАТ",color:"#4ade80"},action:{label:"ДЕЙСТВИЕ",color:"#e5c34b"},emotion:{label:"ЭМОЦИЯ",color:"#c084fc"},system:{label:"СИСТЕМА",color:"#60a5fa"}};function eB({refreshToken:e}){let[t,o]=(0,u.useState)([]),[r,n]=(0,u.useState)([]),[s,a]=(0,u.useState)(!0);return(0,u.useEffect)(()=>{let e=!0,t=null,r=async({silent:t=!1}={})=>{t||a(!0);try{let[t,r]=await Promise.all([q(),W()]);if(!e)return;o(t),n(r)}finally{e&&!t&&a(!1)}},s=()=>{e&&r({silent:!0})},l=async()=>{let o,n,a=(o=m.default.env.NEXT_PUBLIC_BACKEND_URL?.trim())&&o.length>0?o.replace(/\/+$/,""):"http://localhost:5133",l=(n=m.default.env.NEXT_PUBLIC_USER_ID?.trim())&&n.length>0?n:"demo-user",c=`${a}/hubs/agents?userId=${encodeURIComponent(l)}`;for(let e of(t=new eW().withUrl(c).withAutomaticReconnect().configureLogging(i.Error).build(),eq))t.on(e,s);t.onreconnected(()=>{e&&(t?.invoke("SubscribeUser").catch(()=>void 0),r({silent:!0}))});try{if(await t.start(),!e)return;await t.invoke("SubscribeUser")}catch(e){console.warn("[events-panel] SignalR connection failed, fallback to polling",e)}};r(),l();let c=setInterval(()=>{r({silent:!0})},5e3);return()=>{if(e=!1,clearInterval(c),t){for(let e of eq)t.off(e,s);t.stop()}}},[e]),(0,h.jsxs)("div",{className:"flex h-full w-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,h.jsxs)("aside",{className:"shrink-0 flex flex-col gap-3 overflow-y-auto border-r py-4 px-3",style:{borderColor:"rgba(229,195,75,0.15)",width:"clamp(160px, 15%, 220px)"},children:[(0,h.jsx)("span",{className:"font-mono text-[10px] tracking-widest uppercase px-1",style:{color:"var(--muted-foreground)"},children:"АГЕНТЫ ОНЛАЙН"}),r.map(e=>{let t=f[e.mood];return(0,h.jsxs)("div",{className:"flex items-center gap-2 px-2 py-2 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.04)"},children:[(0,h.jsx)("div",{className:"shrink-0 flex items-center justify-center font-mono text-xs font-bold rounded-sm",style:{width:32,height:32,backgroundColor:"rgba(229,195,75,0.1)",color:t.color,border:`1px solid ${t.color}`},children:e.avatar}),(0,h.jsxs)("div",{className:"min-w-0",children:[(0,h.jsx)("div",{className:"font-mono text-xs truncate",style:{color:"var(--foreground)"},children:e.name}),(0,h.jsx)("div",{className:"font-mono text-[10px]",style:{color:t.color},children:t.label})]})]},e.id)})]}),(0,h.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,h.jsxs)("div",{className:"shrink-0 flex items-center justify-between px-4 py-2 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,h.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"ЛЕНТА СОБЫТИЙ"}),(0,h.jsxs)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:[t.length," ","событий"]})]}),(0,h.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 flex flex-col gap-1.5",children:[s&&(0,h.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Загрузка событий..."}),!s&&0===t.length&&(0,h.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Событий пока нет"}),t.map(e=>{let t=eO[e.type];return(0,h.jsxs)("div",{className:"group flex items-start gap-3 px-3 py-2.5 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.02)",borderLeft:`2px solid ${t.color}`,transition:"background-color 0.15s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.06)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.02)"},children:[(0,h.jsx)("span",{className:"shrink-0 font-mono text-[11px] tabular-nums pt-0.5",style:{color:"var(--muted-foreground)",width:"64px"},children:new Date(e.timestamp).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}),(0,h.jsx)("span",{className:"shrink-0 font-mono text-[9px] tracking-wider uppercase px-1.5 py-0.5 rounded-sm mt-0.5",style:{color:t.color,backgroundColor:`${t.color}15`,border:`1px solid ${t.color}30`},children:t.label}),(0,h.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,h.jsx)("span",{className:"font-mono text-xs font-bold mr-2",style:{color:"var(--cyber-glow)"},children:e.agentName}),(0,h.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.85},children:e.text})]})]},e.id)})]})]})]})}function eH({agent:e,onBack:t,fromGraph:o,allAgents:r,allEvents:n,allRelationships:s,onDelete:i,deleting:a,deleteError:l}){let c=f[e.mood],d=n.filter(t=>t.agentId===e.id),u=s.filter(t=>t.from===e.id||t.to===e.id);return(0,h.jsxs)("div",{className:"flex flex-col h-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,h.jsxs)("div",{className:"shrink-0 flex items-center gap-3 px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,h.jsx)("button",{onClick:t,className:"font-mono text-xs tracking-wider uppercase cursor-pointer",style:{color:"var(--cyber-glow)",padding:"4px 10px",border:"1px solid rgba(229,195,75,0.25)",backgroundColor:"rgba(229,195,75,0.05)",transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.15)",e.currentTarget.style.borderColor="rgba(229,195,75,0.5)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.05)",e.currentTarget.style.borderColor="rgba(229,195,75,0.25)"},children:o?"<- К ГРАФУ":"<- НАЗАД"}),(0,h.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"ДОСЬЕ АГЕНТА"}),(0,h.jsx)("button",{onClick:()=>i(e.id),disabled:a,className:"ml-auto font-mono text-xs tracking-wider uppercase cursor-pointer disabled:cursor-not-allowed",style:{color:a?"var(--muted-foreground)":"#f87171",padding:"4px 10px",border:"1px solid rgba(248,113,113,0.35)",backgroundColor:a?"rgba(248,113,113,0.05)":"rgba(248,113,113,0.1)",transition:"all 0.2s ease"},children:a?"УДАЛЕНИЕ...":"УДАЛИТЬ АГЕНТА"})]}),(0,h.jsxs)("div",{className:"flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-5",children:[(0,h.jsxs)("div",{className:"flex items-start gap-4",children:[(0,h.jsx)("div",{className:"shrink-0 flex items-center justify-center font-mono text-2xl font-bold rounded-sm",style:{width:64,height:64,backgroundColor:"rgba(229,195,75,0.1)",color:c.color,border:`2px solid ${c.color}`,boxShadow:`0 0 12px ${c.color}30`},children:e.avatar}),(0,h.jsxs)("div",{className:"flex flex-col gap-1 min-w-0",children:[(0,h.jsx)("h2",{className:"font-mono text-lg uppercase tracking-wider",style:{color:"var(--foreground)"},children:e.name}),(0,h.jsxs)("div",{className:"flex items-center gap-2",children:[(0,h.jsx)("div",{className:"h-2 w-2 rounded-full",style:{backgroundColor:c.color}}),(0,h.jsx)("span",{className:"font-mono text-xs",style:{color:c.color},children:c.label})]}),(0,h.jsx)("p",{className:"font-mono text-xs mt-1",style:{color:"var(--muted-foreground)"},children:e.description})]})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ЧЕРТЫ ХАРАКТЕРА"}),(0,h.jsx)("div",{className:"flex flex-wrap gap-1.5",children:e.traits.map(e=>(0,h.jsx)("span",{className:"font-mono text-[11px] px-2 py-0.5 rounded-sm",style:{color:"var(--cyber-glow)",backgroundColor:"rgba(229,195,75,0.08)",border:"1px solid rgba(229,195,75,0.2)"},children:e},e))})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ТЕКУЩИЙ ПЛАН"}),(0,h.jsx)("p",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.9},children:e.currentPlan})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ОТНОШЕНИЯ"}),(0,h.jsx)("div",{className:"flex flex-col gap-1.5",children:u.map((t,o)=>{let n=t.from===e.id?t.to:t.from,s=r.find(e=>e.id===n),i=t.sentiment>0?"#4ade80":t.sentiment<0?"#f87171":"#a0a0b0";return(0,h.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.03)",borderLeft:`2px solid ${i}`},children:[(0,h.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)"},children:s?.name||n}),(0,h.jsxs)("div",{className:"flex items-center gap-2",children:[(0,h.jsx)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:t.label}),(0,h.jsxs)("span",{className:"font-mono text-xs font-bold",style:{color:i},children:[t.sentiment>0?"+":"",(100*t.sentiment).toFixed(0),"%"]})]})]},o)})})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ВОСПОМИНАНИЯ"}),(0,h.jsx)("div",{className:"flex flex-col gap-1",children:e.memories.map((e,t)=>(0,h.jsxs)("div",{className:"flex items-start gap-2 py-1",children:[(0,h.jsx)("div",{className:"shrink-0 mt-1.5 h-1 w-1 rounded-full",style:{backgroundColor:"var(--cyber-glow)",opacity:.5}}),(0,h.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.8},children:e})]},t))})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"ПОСЛЕДНИЕ СОБЫТИЯ"}),(0,h.jsx)("div",{className:"flex flex-col gap-1",children:d.map(e=>(0,h.jsxs)("div",{className:"flex items-start gap-2 py-1.5 px-2 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.02)"},children:[(0,h.jsx)("span",{className:"shrink-0 font-mono text-[10px] tabular-nums",style:{color:"var(--muted-foreground)",width:56},children:new Date(e.timestamp).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}),(0,h.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--foreground)",opacity:.8},children:e.text})]},e.id))})]}),l?(0,h.jsx)("div",{className:"font-mono text-[11px]",style:{color:"#f87171"},children:l}):null]})]})}function eU({preSelectedAgentId:e,onClearSelection:t,fromGraph:o,refreshToken:r}){let[n,s]=(0,u.useState)(e??null),[i,a]=(0,u.useState)([]),[l,c]=(0,u.useState)([]),[d,g]=(0,u.useState)([]),[p,m]=(0,u.useState)(!0),[b,x]=(0,u.useState)(""),[_,y]=(0,u.useState)(null),[v,w]=(0,u.useState)(!1),[k,S]=(0,u.useState)(!1),[C,j]=(0,u.useState)(null),N=async()=>{let[e,t,o]=await Promise.all([W(),q(),O()]);a(e),c(t),g(o)};(0,u.useEffect)(()=>{let e=!0;return m(!0),Promise.all([W(),q(),O()]).then(([t,o,r])=>{e&&(a(t),c(o),g(r))}).finally(()=>{e&&m(!1)}),()=>{e=!1}},[r]);let T=async()=>{let e=b.trim();if(e&&!v){w(!0),y(null);try{let t=await A(e);if(!t)return void y("Не удалось сгенерировать агента. Проверь backend и OPENAI_API_KEY.");await N(),x(""),s(t.id)}finally{w(!1)}}},I=async e=>{if(k)return;let o=i.find(t=>t.id===e)?.name??e;if(window.confirm(`Удалить агента "${o}"?`)){S(!0),j(null);try{if(!await L(e))return void j("Не удалось удалить агента. Проверь backend и попробуй снова.");await N(),s(null),t?.()}finally{S(!1)}}},E=(0,u.useRef)(e);e&&e!==E.current&&(E.current=e,n!==e&&s(e));let P=i.find(e=>e.id===n);return P?(0,h.jsx)(eH,{agent:P,allAgents:i,allEvents:l,allRelationships:d,onDelete:I,deleting:k,deleteError:C,onBack:()=>{s(null),t?.()},fromGraph:o}):p?(0,h.jsx)("div",{className:"flex h-full items-center justify-center font-mono text-xs",style:{backgroundColor:"var(--cyber-surface)",color:"var(--muted-foreground)"},children:"Загрузка агентов..."}):(0,h.jsxs)("div",{className:"flex flex-col h-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,h.jsxs)("div",{className:"shrink-0 flex items-center justify-between px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,h.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"СПИСОК АГЕНТОВ"}),(0,h.jsxs)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:[i.length," ","агентов"]})]}),(0,h.jsxs)("div",{className:"px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.12)"},children:[(0,h.jsxs)("div",{className:"flex gap-2",children:[(0,h.jsx)("input",{type:"text",value:b,onChange:e=>x(e.target.value),placeholder:"Опиши агента для ИИ...",className:"flex-1 font-mono text-xs px-3 py-2 rounded-sm outline-none",style:{backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.2)",color:"var(--foreground)"},disabled:v}),(0,h.jsx)("button",{onClick:T,disabled:v||0===b.trim().length,className:"font-mono text-xs tracking-wider uppercase px-3 py-2 rounded-sm cursor-pointer disabled:cursor-not-allowed",style:{color:v?"var(--muted-foreground)":"var(--cyber-glow)",backgroundColor:v?"rgba(229,195,75,0.02)":"rgba(229,195,75,0.08)",border:"1px solid rgba(229,195,75,0.25)"},children:v?"ГЕНЕРАЦИЯ...":"СОЗДАТЬ ИИ"})]}),_?(0,h.jsx)("p",{className:"mt-2 font-mono text-[10px]",style:{color:"#f87171"},children:_}):null]}),(0,h.jsxs)("div",{className:"flex-1 overflow-y-auto px-5 py-4 grid grid-cols-1 md:grid-cols-2 gap-3 auto-rows-min",children:[0===i.length?(0,h.jsx)("div",{className:"col-span-full flex items-center justify-center font-mono text-xs py-8",style:{color:"var(--muted-foreground)"},children:'Агентов пока нет. Опиши первого и нажми "СОЗДАТЬ ИИ".'}):null,i.map(e=>{let t=f[e.mood];return(0,h.jsxs)("button",{onClick:()=>s(e.id),className:"text-left p-4 rounded-sm cursor-pointer flex items-start gap-3",style:{backgroundColor:"rgba(229,195,75,0.03)",border:"1px solid rgba(229,195,75,0.1)",transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.08)",e.currentTarget.style.borderColor="rgba(229,195,75,0.3)",e.currentTarget.style.boxShadow="0 0 12px rgba(229,195,75,0.06)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="rgba(229,195,75,0.03)",e.currentTarget.style.borderColor="rgba(229,195,75,0.1)",e.currentTarget.style.boxShadow="none"},children:[(0,h.jsx)("div",{className:"shrink-0 flex items-center justify-center font-mono text-lg font-bold rounded-sm",style:{width:48,height:48,backgroundColor:"rgba(229,195,75,0.08)",color:t.color,border:`1px solid ${t.color}`},children:e.avatar}),(0,h.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,h.jsxs)("div",{className:"flex items-center gap-2",children:[(0,h.jsx)("span",{className:"font-mono text-sm uppercase",style:{color:"var(--foreground)"},children:e.name}),(0,h.jsxs)("div",{className:"flex items-center gap-1",children:[(0,h.jsx)("div",{className:"h-1.5 w-1.5 rounded-full",style:{backgroundColor:t.color}}),(0,h.jsx)("span",{className:"font-mono text-[10px]",style:{color:t.color},children:t.label})]})]}),(0,h.jsx)("p",{className:"font-mono text-[11px] mt-1 line-clamp-2",style:{color:"var(--muted-foreground)"},children:e.description}),(0,h.jsx)("div",{className:"flex flex-wrap gap-1 mt-2",children:e.traits.map(e=>(0,h.jsx)("span",{className:"font-mono text-[9px] px-1.5 py-0.5 rounded-sm",style:{color:"var(--cyber-glow)",backgroundColor:"rgba(229,195,75,0.06)",border:"1px solid rgba(229,195,75,0.15)"},children:e},e))})]})]},e.id)})]})]})}function eF({label:e,value:t,sub:o}){return(0,h.jsxs)("div",{className:"flex flex-col gap-1 p-4 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.03)",border:"1px solid rgba(229,195,75,0.1)"},children:[(0,h.jsx)("span",{className:"font-mono text-[10px] tracking-widest uppercase",style:{color:"var(--muted-foreground)"},children:e}),(0,h.jsx)("span",{className:"font-mono text-2xl tabular-nums",style:{color:"var(--cyber-glow)",textShadow:"0 0 10px rgba(229,195,75,0.3)"},children:t}),o&&(0,h.jsx)("span",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:o})]})}function ez({items:e,maxVal:t}){return(0,h.jsx)("div",{className:"flex flex-col gap-2",children:e.map(e=>(0,h.jsxs)("div",{className:"flex items-center gap-3",children:[(0,h.jsx)("span",{className:"font-mono text-[10px] tracking-wider uppercase shrink-0",style:{color:"var(--muted-foreground)",width:80},children:e.label}),(0,h.jsx)("div",{className:"flex-1 h-5 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.06)"},children:(0,h.jsx)("div",{className:"h-full rounded-sm",style:{width:`${Math.max(e.value/t*100,2)}%`,backgroundColor:e.color,opacity:.7,boxShadow:`0 0 8px ${e.color}40`,transition:"width 0.5s ease"}})}),(0,h.jsx)("span",{className:"font-mono text-xs tabular-nums shrink-0",style:{color:e.color,width:36,textAlign:"right"},children:e.value})]},e.label))})}function eK({refreshToken:e}){let[t,o]=(0,u.useState)(null);if((0,u.useEffect)(()=>{let e=!0;return o(null),B().then(t=>{e&&o(t)}),()=>{e=!1}},[e]),!t)return(0,h.jsx)("div",{className:"flex h-full items-center justify-center font-mono text-xs",style:{backgroundColor:"var(--cyber-surface)",color:"var(--muted-foreground)"},children:"Загрузка статистики..."});let r={chat:"#4ade80",action:"#e5c34b",emotion:"#c084fc",system:"#60a5fa"},n={chat:"Чат",action:"Действие",emotion:"Эмоция",system:"Система"},s=Math.max(1,...t.eventsByType.map(e=>e.count)),i=Math.max(1,...t.moodDistribution.map(e=>e.count)),a=t.topRelationship.sentiment>0?"#4ade80":t.topRelationship.sentiment<0?"#f87171":"var(--muted-foreground)";return(0,h.jsxs)("div",{className:"flex flex-col h-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,h.jsx)("div",{className:"shrink-0 flex items-center px-5 py-3 border-b",style:{borderColor:"rgba(229,195,75,0.15)"},children:(0,h.jsx)("span",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:"СТАТИСТИКА МИРА"})}),(0,h.jsxs)("div",{className:"flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-5",children:[(0,h.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,h.jsx)(eF,{label:"Всего событий",value:t.totalEvents}),(0,h.jsx)(eF,{label:"Диалогов",value:t.totalConversations}),(0,h.jsx)(eF,{label:"Среднее настроение",value:`${(100*t.avgMood).toFixed(0)}%`,sub:"0% = плохо, 100% = отлично"}),(0,h.jsx)(eF,{label:"Самый активный",value:t.mostActiveAgent})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-3",style:{color:"var(--muted-foreground)"},children:"СОБЫТИЯ ПО ТИПАМ"}),(0,h.jsx)(ez,{items:t.eventsByType.map(e=>({label:n[e.type]||e.type,value:e.count,color:r[e.type]||"var(--cyber-glow)"})),maxVal:s})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-3",style:{color:"var(--muted-foreground)"},children:"РАСПРЕДЕЛЕНИЕ НАСТРОЕНИЙ"}),(0,h.jsx)(ez,{items:t.moodDistribution.map(e=>({label:f[e.mood].label,value:e.count,color:f[e.mood].color})),maxVal:i})]}),(0,h.jsxs)("div",{children:[(0,h.jsx)("h3",{className:"font-mono text-[10px] tracking-widest uppercase mb-2",style:{color:"var(--muted-foreground)"},children:"САМАЯ СИЛЬНАЯ СВЯЗЬ"}),(0,h.jsxs)("div",{className:"flex items-center justify-between px-4 py-3 rounded-sm",style:{backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.15)"},children:[(0,h.jsxs)("div",{className:"flex items-center gap-3",children:[(0,h.jsx)("span",{className:"font-mono text-sm",style:{color:"var(--foreground)"},children:t.topRelationship.from}),(0,h.jsx)("span",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"<->"}),(0,h.jsx)("span",{className:"font-mono text-sm",style:{color:"var(--foreground)"},children:t.topRelationship.to})]}),(0,h.jsxs)("span",{className:"font-mono text-sm font-bold",style:{color:a},children:[t.topRelationship.sentiment>0?"+":"",(100*t.topRelationship.sentiment).toFixed(0),"%"]})]})]})]})]})}let eX="__all_agents__",eJ=["agents.list.updated","agent.status.changed","agent.message","agent.progress","agent.error"];function eV({refreshToken:e}){let[t,o]=(0,u.useState)([]),[r,n]=(0,u.useState)(eX),[s,a]=(0,u.useState)([]),[l,c]=(0,u.useState)("ask"),[d,g]=(0,u.useState)(""),[p,b]=(0,u.useState)(!0),[x,_]=(0,u.useState)(!1),[y,v]=(0,u.useState)(null),[w,k]=(0,u.useState)(null),S=(0,u.useRef)(0),C=(0,u.useRef)(r),j=(0,u.useMemo)(()=>t.find(e=>e.id===r),[t,r]);(0,u.useEffect)(()=>{C.current=r},[r]),(0,u.useEffect)(()=>{let e=!0,t=null,r=async({silent:t=!1}={})=>{let r=++S.current;t||(b(!0),a([]));try{let t=await W();if(!e||r!==S.current)return;o(t);let s=C.current,i=s===eX||t.some(e=>e.id===s)?s:t[0]?.id??eX;i!==s&&(C.current=i,n(i));let l=i===eX?await D(20):await $(i,120);if(!e||r!==S.current)return;a(l.filter(e=>"system"!==e.role).slice().sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()))}finally{e&&!t&&b(!1)}},s=()=>{e&&r({silent:!0})},l=async()=>{let o,n,a=(o=m.default.env.NEXT_PUBLIC_BACKEND_URL?.trim())&&o.length>0?o.replace(/\/+$/,""):"http://localhost:5133",l=(n=m.default.env.NEXT_PUBLIC_USER_ID?.trim())&&n.length>0?n:"demo-user",c=`${a}/hubs/agents?userId=${encodeURIComponent(l)}`;for(let e of(t=new eW().withUrl(c).withAutomaticReconnect().configureLogging(i.Error).build(),eJ))t.on(e,s);t.onreconnected(()=>{e&&(t?.invoke("SubscribeUser").catch(()=>void 0),r({silent:!0}))});try{if(await t.start(),!e)return;await t.invoke("SubscribeUser")}catch(e){console.warn("[messages-panel] SignalR connection failed, fallback to polling",e)}};r(),l();let c=setInterval(()=>{r({silent:!0})},5e3);return()=>{if(e=!1,clearInterval(c),t){for(let e of eJ)t.off(e,s);t.stop()}}},[e]),(0,u.useEffect)(()=>{let e=!0,t=++S.current;return b(!0),a([]),(async()=>{try{let o=r===eX?await D(20):await $(r,120);if(!e||t!==S.current)return;a(o.filter(e=>"system"!==e.role).slice().sort((e,t)=>new Date(e.timestamp).getTime()-new Date(t.timestamp).getTime()))}finally{e&&t===S.current&&b(!1)}})(),()=>{e=!1}},[r]);let N=async()=>{let e=d.trim();if(!e||x)return;_(!0),v(null),k(null);let t="ask"===l?"chat.ask":"action.nudge";if(r!==eX){let t={id:`local-user-${Date.now()}`,agentId:r,agentName:j?.name??"You",role:"user",content:e,timestamp:new Date().toISOString()};a(e=>[...e,t])}try{if(r===eX){let o=await M(e,{command:t});if(!o)return void v("Failed to send message to all agents.");o.rejectedCount>0?k(`Sent: ${o.acceptedCount}, rejected: ${o.rejectedCount}.`):k(`Sent to all agents: ${o.acceptedCount}.`)}else{if(!await R(r,e,t))return void v("Failed to send message to selected agent.");k("Message queued. Agent is processing it.")}g("")}finally{_(!1)}};return(0,h.jsxs)("div",{className:"flex h-full w-full",style:{backgroundColor:"var(--cyber-surface)"},children:[(0,h.jsxs)("aside",{className:"shrink-0 border-r px-3 py-4 overflow-y-auto",style:{borderColor:"rgba(229,195,75,0.15)",width:"clamp(220px, 21%, 300px)"},children:[(0,h.jsx)("div",{className:"font-mono text-[10px] tracking-widest uppercase mb-3",style:{color:"var(--muted-foreground)"},children:"Диалоги"}),(0,h.jsxs)("button",{onClick:()=>n(eX),className:"w-full text-left rounded-sm px-3 py-2 mb-2",style:{backgroundColor:r===eX?"rgba(229,195,75,0.12)":"rgba(229,195,75,0.05)",border:r===eX?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.16)"},children:[(0,h.jsx)("div",{className:"font-mono text-xs uppercase",style:{color:"var(--cyber-glow)"},children:"Все агенты"}),(0,h.jsx)("div",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:"Общий сигнал и ответы"})]}),(0,h.jsx)("div",{className:"flex flex-col gap-2",children:t.map(e=>{let t,o=f[e.mood],s=r===e.id;return(0,h.jsxs)("button",{onClick:()=>n(e.id),className:"w-full text-left rounded-sm px-3 py-2",style:{backgroundColor:s?"rgba(229,195,75,0.12)":"rgba(229,195,75,0.04)",border:s?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.12)"},children:[(0,h.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,h.jsx)("span",{className:"font-mono text-xs uppercase",style:{color:"var(--foreground)"},children:e.name}),(0,h.jsx)("span",{className:"font-mono text-[10px]",style:{color:o.color},children:o.label})]}),(0,h.jsx)("div",{className:"font-mono text-[10px] mt-1",style:{color:"var(--muted-foreground)"},children:(t=e.currentPlan.replace(/\s+/g," ").trim()).length<=42?t:`${t.slice(0,39)}...`})]},e.id)})})]}),(0,h.jsxs)("div",{className:"flex-1 flex flex-col min-w-0",children:[(0,h.jsxs)("div",{className:"shrink-0 border-b px-4 py-3 flex items-center justify-between",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,h.jsx)("div",{className:"font-mono text-sm tracking-widest uppercase",style:{color:"var(--cyber-glow)"},children:r===eX?"Сообщения / Все агенты":`Сообщения / ${j?.name??"Агент"}`}),(0,h.jsxs)("div",{className:"font-mono text-[10px]",style:{color:"var(--muted-foreground)"},children:[s.length," сообщений"]})]}),(0,h.jsxs)("div",{className:"flex-1 overflow-y-auto px-4 py-3 flex flex-col gap-2",children:[p?(0,h.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Загрузка переписки..."}):null,p||0!==s.length?null:(0,h.jsx)("div",{className:"font-mono text-xs",style:{color:"var(--muted-foreground)"},children:"Пока нет сообщений."}),s.map(e=>{let t="user"===e.role;return(0,h.jsx)("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:(0,h.jsxs)("div",{className:"max-w-[82%] rounded-sm px-3 py-2",style:{backgroundColor:t?"rgba(229,195,75,0.08)":"rgba(74,222,128,0.08)",border:`1px solid ${t?"#e5c34b":"#4ade80"}40`},children:[r===eX?(0,h.jsx)("div",{className:"font-mono text-[10px] mb-1 uppercase",style:{color:"var(--cyber-glow)"},children:e.agentName}):null,(0,h.jsx)("div",{className:"font-mono text-xs whitespace-pre-wrap",style:{color:"var(--foreground)"},children:e.content}),(0,h.jsxs)("div",{className:"font-mono text-[10px] mt-1",style:{color:"var(--muted-foreground)"},children:[e.role," | ",new Date(e.timestamp).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit",second:"2-digit"})]})]})},e.id)})]}),(0,h.jsxs)("div",{className:"shrink-0 border-t px-4 py-3",style:{borderColor:"rgba(229,195,75,0.15)"},children:[(0,h.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,h.jsx)("button",{onClick:()=>c("ask"),className:"font-mono text-[10px] tracking-widest uppercase px-2 py-1 rounded-sm",style:{color:"ask"===l?"var(--cyber-glow)":"var(--muted-foreground)",border:"ask"===l?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.15)",backgroundColor:"ask"===l?"rgba(229,195,75,0.1)":"rgba(229,195,75,0.03)"},children:"Вопрос"}),(0,h.jsx)("button",{onClick:()=>c("nudge"),className:"font-mono text-[10px] tracking-widest uppercase px-2 py-1 rounded-sm",style:{color:"nudge"===l?"var(--cyber-glow)":"var(--muted-foreground)",border:"nudge"===l?"1px solid rgba(229,195,75,0.4)":"1px solid rgba(229,195,75,0.15)",backgroundColor:"nudge"===l?"rgba(229,195,75,0.1)":"rgba(229,195,75,0.03)"},children:"Подстрекать к действию"})]}),(0,h.jsxs)("div",{className:"flex gap-2",children:[(0,h.jsx)("textarea",{value:d,onChange:e=>g(e.target.value),placeholder:r===eX?"Введите общий сигнал для всех агентов...":"Введите сообщение агенту...",className:"flex-1 min-h-[72px] max-h-[180px] rounded-sm p-2 font-mono text-xs outline-none resize-y",style:{backgroundColor:"rgba(229,195,75,0.04)",border:"1px solid rgba(229,195,75,0.2)",color:"var(--foreground)"},disabled:x}),(0,h.jsx)("button",{onClick:N,disabled:x||0===d.trim().length,className:"shrink-0 h-fit font-mono text-xs tracking-widest uppercase px-3 py-2 rounded-sm disabled:cursor-not-allowed",style:{color:x?"var(--muted-foreground)":"var(--cyber-glow)",border:"1px solid rgba(229,195,75,0.35)",backgroundColor:x?"rgba(229,195,75,0.03)":"rgba(229,195,75,0.09)"},children:x?"ОТПРАВКА...":"ОТПРАВИТЬ"})]}),y?(0,h.jsx)("div",{className:"font-mono text-[11px] mt-2",style:{color:"#f87171"},children:y}):null,w?(0,h.jsx)("div",{className:"font-mono text-[11px] mt-2",style:{color:"#4ade80"},children:w}):null]})]})]})}function eG(){let[e,t]=(0,u.useState)("graph"),[o,r]=(0,u.useState)(1),[n,s]=(0,u.useState)(null),[i,a]=(0,u.useState)(null),[l,c]=(0,u.useState)(null),[d,g]=(0,u.useState)(0);(0,u.useEffect)(()=>{let e=!0,t=async()=>{let t=await H();t&&e&&(r(e=>Math.abs(e-t.speed)>.001?t.speed:e),s(e=>{if(!e)return t.gameTime;let o=new Date(e).getTime(),r=new Date(t.gameTime).getTime();return Number.isFinite(o)&&Number.isFinite(r)?Math.abs(r-o)>=6e4?t.gameTime:e:t.gameTime}))};t();let o=setInterval(t,5e3);return()=>{e=!1,clearInterval(o)}},[]);let m=async e=>{await I(e)?g(e=>e+1):console.warn("[ui] Event was not sent to backend, fallback mode is active")},f=async e=>{r(e);let t=await U(e);t&&(r(t.speed),s(t.gameTime),g(e=>e+1))},b=async()=>{if(!window.confirm("Начать симуляцию заново? Текущие агенты, связи и события будут сброшены."))return;let e=await F();e&&(r(e.speed),s(e.gameTime),a(null),c(null),g(e=>e+1))},x=e=>{a(e),c("graph"),t("agents")};return(0,h.jsx)(p,{activeTab:e,onTabChange:e=>{t(e),"agents"!==e&&(a(null),c(null))},onAddEvent:m,timeSpeed:o,onTimeSpeedChange:f,onRestartSimulation:b,worldTime:n,children:function(){switch(e){case"graph":return(0,h.jsx)(J,{onSelectAgent:x,refreshToken:d});case"events":return(0,h.jsx)(eB,{refreshToken:d});case"stats":return(0,h.jsx)(eK,{refreshToken:d});case"agents":return(0,h.jsx)(eU,{refreshToken:d,preSelectedAgentId:i,onClearSelection:()=>{a(null),"graph"===l&&(t("graph"),c(null))},fromGraph:"graph"===l});case"messages":return(0,h.jsx)(eV,{refreshToken:d});default:return null}}()})}e.s(["default",()=>eG],31713)}]);